<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cura.tor | Smart Contact Curation</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Scan and curate business cards with smart OCR technology">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cura.tor">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Cura.tor">
    <meta name="msapplication-TileColor" content="#020617">
    <meta name="msapplication-TileImage" content="/icons/icon-144.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-72.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-128.png">

    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <!-- Google Identity Services for OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #0a0f1a 0%, #0d1321 50%, #0a0f1a 100%);
            color: #e2e8f0;
            margin: 0;
            min-height: 100vh;
        }

        /* Premium glass effect */
        .glass {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.6) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        /* Elevated card style */
        .card-elevated {
            background: linear-gradient(145deg, rgba(20, 30, 48, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-elevated:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Gradient text variations */
        .gradient-text {
            background: linear-gradient(135deg, #ffffff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gradient-text-accent {
            background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 50%, #0284c7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gradient-text-gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Ambient background glow */
        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse 80% 50% at 20% -10%, rgba(14, 165, 233, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 110%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse 40% 30% at 50% 50%, rgba(15, 23, 42, 0.5) 0%, transparent 70%);
            z-index: -1;
            pointer-events: none;
        }

        /* Premium button styles */
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            font-weight: 600;
            border: none;
            box-shadow: 0 4px 14px rgba(14, 165, 233, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            color: #e2e8f0;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Action card with icon */
        .action-card {
            background: linear-gradient(145deg, rgba(20, 30, 48, 0.7) 0%, rgba(15, 23, 42, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 20px;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        .action-card:hover {
            transform: translateY(-4px) scale(1.02);
            border-color: rgba(255, 255, 255, 0.12);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .action-card:active {
            transform: translateY(-2px) scale(1.01);
        }

        .action-card .icon-wrapper {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .action-card:hover .icon-wrapper {
            transform: scale(1.1);
        }

        /* Status indicator */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Smooth page transitions */
        .page-enter {
            animation: pageEnter 0.3s ease-out;
        }

        @keyframes pageEnter {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card stagger animation */
        .card-stagger {
            animation: cardSlideIn 0.4s ease-out backwards;
        }

        .card-stagger:nth-child(1) { animation-delay: 0.05s; }
        .card-stagger:nth-child(2) { animation-delay: 0.1s; }
        .card-stagger:nth-child(3) { animation-delay: 0.15s; }
        .card-stagger:nth-child(4) { animation-delay: 0.2s; }
        .card-stagger:nth-child(5) { animation-delay: 0.25s; }
        .card-stagger:nth-child(6) { animation-delay: 0.3s; }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Scale bounce animation for buttons */
        .btn-bounce {
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-bounce:active {
            transform: scale(0.95);
        }

        /* Shimmer loading effect */
        .shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Subtle float animation for icons */
        .icon-float {
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        /* Glow pulse for active elements */
        .glow-pulse {
            animation: glowPulse 2s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(14, 165, 233, 0.3); }
            50% { box-shadow: 0 0 30px rgba(14, 165, 233, 0.5); }
        }

        /* Fade scale for modals */
        .modal-enter {
            animation: modalEnter 0.25s ease-out;
        }

        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Smooth expand for collapsible sections */
        .expand-enter {
            animation: expandEnter 0.3s ease-out;
            overflow: hidden;
        }

        @keyframes expandEnter {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }

        /* Header style */
        .header-bar {
            background: linear-gradient(180deg, rgba(10, 15, 26, 0.95) 0%, rgba(10, 15, 26, 0.8) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        /* Input styles */
        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 14px 16px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: rgba(14, 165, 233, 0.5);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .input-field::placeholder {
            color: #475569;
        }

        /* Toggle switch */
        .toggle-switch {
            width: 52px;
            height: 28px;
            border-radius: 14px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .toggle-switch .toggle-knob {
            width: 22px;
            height: 22px;
            border-radius: 11px;
            background: white;
            position: absolute;
            top: 3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.5);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 0.7);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 16px;
        }

        /* Section label */
        .section-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #64748b;
        }
    </style>
</head>

<body>
    <div class="bg-glow"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Keys (hardcoded for personal use)
        const GOOGLE_VISION_API_KEY = 'AIzaSyDp5v_RuQZsNlrqJOKJ1TgAZq2n3GZ8nBg';
        const GOOGLE_DRIVE_CLIENT_ID = '989864367677-fcll4q385kai03cj1hkhaa852i5rdhis.apps.googleusercontent.com';

        // Smart OCR Parsing Logic
        // Precompiled regex patterns (created once, reused for all parses)
        const COMPANY_END_WORDS = ['inc', 'inc.', 'corp', 'corp.', 'corporation', 'llc', 'ltd', 'ltd.', 'co.', 'company'];
        const COMPANY_SUFFIX_END_REGEX = new RegExp(`\\b(${COMPANY_END_WORDS.map(s => s.replace('.', '\\.')).join('|')})$`, 'i');
        const COMPANY_SUFFIX_WORD_REGEX = new RegExp(`\\b(${COMPANY_END_WORDS.map(s => s.replace('.', '\\.')).join('|')})\\b`, 'i');
        const STRONG_COMPANY_SUFFIXES = ['inc', 'inc.', 'corp', 'corp.', 'corporation', 'llc', 'ltd', 'ltd.'];
        const STRONG_SUFFIX_REGEX = new RegExp(`\\b(${STRONG_COMPANY_SUFFIXES.map(s => s.replace('.', '\\.')).join('|')})\\b`, 'i');

        // Company continuation words - common second-line brand words that should be merged with company name
        const COMPANY_CONTINUATION_WORDS = ['energy', 'group', 'systems', 'solutions', 'technologies', 'technology', 'tech', 'industries', 'industrial', 'holdings', 'enterprises', 'services', 'international', 'partners', 'consulting', 'global', 'networks', 'labs', 'studio', 'studios', 'media', 'digital', 'creative', 'design', 'works', 'ventures', 'capital', 'financial', 'properties', 'realty', 'construction', 'builders', 'manufacturing', 'logistics', 'trading', 'supply', 'foods', 'pharma', 'health', 'healthcare', 'wellness', 'fitness', 'auto', 'motors', 'aviation', 'marine', 'power', 'electric', 'electronics', 'software', 'hardware', 'telecom', 'communications', 'security', 'insurance', 'bank', 'finance'];
        const COMPANY_CONTINUATION_REGEX = new RegExp(`^(${COMPANY_CONTINUATION_WORDS.join('|')})$`, 'i');

        const MERGE_ADDRESS_KW = ['street', 'st.', 'avenue', 'ave', 'road', 'rd', 'floor', 'flr', 'suite', 'unit', 'building', 'bldg', 'city', 'barangay', 'brgy'];
        const PHONE_REGEX = /^\+?\d[\d\s().-]{6,}$/;
        const HAS_LETTERS_REGEX = /[A-Za-z]/;

        // Professional suffixes pattern
        const PROFESSIONAL_SUFFIXES = ['ree', 'pee', 'rme', 'pme', 'cpa', 'cma', 'cfa', 'md', 'm\\.d\\.', 'do', 'd\\.o\\.', 'rn', 'r\\.n\\.', 'bsn', 'jd', 'j\\.d\\.', 'esq', 'esq\\.', 'atty', 'atty\\.', 'phd', 'ph\\.d\\.', 'edd', 'ed\\.d\\.', 'mba', 'm\\.b\\.a\\.', 'ms', 'm\\.s\\.', 'ma', 'm\\.a\\.', 'pe', 'p\\.e\\.', 'se', 's\\.e\\.', 'prc', 'lic\\.', 'certified'];
        const PROFESSIONAL_SUFFIX_REGEX = new RegExp(`[,\\s](${PROFESSIONAL_SUFFIXES.join('|')})$|[,\\s](${PROFESSIONAL_SUFFIXES.join('|')})[,\\s]`, 'i');

        // Title keywords pattern
        const TITLE_KEYWORDS = ['ceo', 'cto', 'cfo', 'coo', 'president', 'vice president', 'vp', 'director', 'manager', 'supervisor', 'lead', 'engineer', 'developer', 'designer', 'analyst', 'consultant', 'sales', 'marketing', 'executive', 'officer', 'associate', 'specialist', 'coordinator', 'administrator', 'assistant', 'founder', 'partner', 'owner', 'chairman', 'secretary', 'accountant', 'attorney', 'lawyer', 'doctor', 'nurse', 'representative', 'agent', 'broker', 'realtor', 'architect', 'account manager', 'project manager', 'general manager'];
        const TITLE_KEYWORD_REGEX = new RegExp(`\\b(${TITLE_KEYWORDS.join('|')})\\b`, 'i');

        const parseBusinessCard = (text) => {
            console.log('[Parser v2] Starting parse...');
            const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            let lines = normalizedText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            console.log('[Parser v2] Initial lines:', lines);

            // PRE-PROCESS: Merge fragmented company names
            // Handles: "BUILDERS,\nINC." | "Google\nLLC" | "Hedgefund\nCorporation Inc"

            // Helper: Check if line is a valid company name fragment
            const isValidFragment = (line) => {
                const lower = line.toLowerCase();
                return HAS_LETTERS_REGEX.test(line) &&
                       !line.includes('@') &&
                       !PHONE_REGEX.test(line) &&
                       !MERGE_ADDRESS_KW.some(kw => lower.includes(kw)) &&
                       line.length < 50;
            };

            // Helper: Check if line ends with a company suffix (uses precompiled regex)
            const endsWithSuffix = (line) => COMPANY_SUFFIX_END_REGEX.test(line.toLowerCase());

            // Helper: Check if line IS exactly a suffix
            const isExactSuffix = (line) => {
                const lower = line.toLowerCase().trim();
                return COMPANY_END_WORDS.some(suf => lower === suf || lower === suf.replace('.', ''));
            };

            // Helper: Extend merge backwards for ALL CAPS single words
            const extendBackwards = (startIdx, lines) => {
                while (startIdx > 0) {
                    const prev = lines[startIdx - 1];
                    const isAllCaps = prev === prev.toUpperCase() && /[A-Z]/.test(prev);
                    const isSingleWord = prev.split(/\s+/).length === 1;
                    if (isAllCaps && isSingleWord && !prev.includes('@') && !/\d{3}/.test(prev) && !endsWithSuffix(prev)) {
                        startIdx--;
                    } else break;
                }
                return startIdx;
            };

            // Identify line types
            const suffixLines = [];      // Lines that ARE just a suffix
            const suffixEndLines = [];   // Lines that END with a suffix
            const commaLines = [];       // ALL CAPS lines ending with comma

            lines.forEach((line, idx) => {
                const isAllCaps = line === line.toUpperCase() && /[A-Z]/.test(line);
                if (isExactSuffix(line)) suffixLines.push(idx);
                else if (endsWithSuffix(line)) suffixEndLines.push(idx);
                if (isAllCaps && line.endsWith(',')) commaLines.push(idx);
            });

            // Build merge map
            const mergeMap = new Map();
            const skipIndices = new Set();

            const addMerge = (start, end) => {
                mergeMap.set(start, end);
                for (let m = start; m <= end; m++) skipIndices.add(m);
            };

            // Process standalone suffix lines (e.g., "LLC")
            suffixLines.forEach(suffixIdx => {
                if (skipIndices.has(suffixIdx)) return;

                // Try 1: Look for comma-ending line within 3 lines back
                for (let k = suffixIdx - 1; k >= Math.max(0, suffixIdx - 3); k--) {
                    if (commaLines.includes(k)) {
                        addMerge(extendBackwards(k, lines), suffixIdx);
                        return;
                    }
                }

                // Try 2: Check immediate previous line
                if (suffixIdx > 0 && isValidFragment(lines[suffixIdx - 1]) && !isExactSuffix(lines[suffixIdx - 1])) {
                    addMerge(extendBackwards(suffixIdx - 1, lines), suffixIdx);
                }
            });

            // Process lines ending with suffix (e.g., "Corporation Inc")
            suffixEndLines.forEach(idx => {
                if (skipIndices.has(idx) || idx === 0) return;
                if (isValidFragment(lines[idx - 1]) && !endsWithSuffix(lines[idx - 1])) {
                    addMerge(extendBackwards(idx - 1, lines), idx);
                }
            });

            // Process company continuation words (e.g., "JIVO" + "ENERGY" -> "JIVO ENERGY")
            lines.forEach((line, idx) => {
                if (skipIndices.has(idx) || idx === 0) return;
                const trimmed = line.trim();
                // Check if this line is a company continuation word
                if (COMPANY_CONTINUATION_REGEX.test(trimmed)) {
                    const prevLine = lines[idx - 1];
                    // Merge if previous line looks like a company name fragment
                    // (short, has letters, is ALL CAPS or Title Case, not already merged)
                    const isAllCaps = prevLine === prevLine.toUpperCase() && /[A-Z]/.test(prevLine);
                    const isTitleCase = /^[A-Z][a-z]*(\s+[A-Z][a-z]*)*$/.test(prevLine);
                    if (isValidFragment(prevLine) && (isAllCaps || isTitleCase || prevLine.length <= 20) && !skipIndices.has(idx - 1)) {
                        addMerge(extendBackwards(idx - 1, lines), idx);
                        console.log(`[Parser] Merged company continuation: "${prevLine}" + "${trimmed}"`);
                    }
                }
            });

            // Build merged lines
            const mergedLines = [];
            let i = 0;
            while (i < lines.length) {
                if (mergeMap.has(i)) {
                    const endIdx = mergeMap.get(i);
                    // Merge all lines in range, handling comma lines specially
                    let merged = lines[i];
                    const commaIdx = commaLines.find(c => c > i && c <= endIdx);
                    if (commaIdx !== undefined && commaIdx !== i) merged += ' ' + lines[commaIdx];
                    if (!merged.toLowerCase().includes(lines[endIdx].toLowerCase())) {
                        merged += ' ' + lines[endIdx];
                    }
                    mergedLines.push(merged.replace(/\s+/g, ' ').trim());
                    // Add non-merge lines in range (e.g., "ELECTRICAL CONTRACTOR")
                    for (let m = i + 1; m < endIdx; m++) {
                        if (m !== commaIdx) mergedLines.push(lines[m]);
                    }
                    i = endIdx + 1;
                } else if (!skipIndices.has(i)) {
                    mergedLines.push(lines[i]);
                    i++;
                } else i++;
            }

            lines = mergedLines;
            if (mergeMap.size > 0) {
                console.log('[Parser] Merged company names:', Array.from(mergeMap.entries()).map(([s, e]) => `${s}-${e}`));
            }

            // PRE-PROCESS: Merge multi-line addresses
            // Handles: "Add:No.6 Foluo Road Industrial" + "Park,Nanhai District,Foshan," + "Guangdong,China"
            const ADDRESS_LOCATION_WORDS = [
                // Location types
                'park', 'district', 'city', 'province', 'state', 'country', 'village', 'subdivision',
                'compound', 'complex', 'center', 'centre', 'plaza', 'mall', 'estate', 'heights',
                // Countries
                'china', 'usa', 'philippines', 'singapore', 'japan', 'korea', 'india', 'taiwan', 'malaysia',
                // China cities
                'guangdong', 'foshan', 'nanhai', 'shenzhen', 'guangzhou', 'shanghai', 'beijing',
                // Philippine locations
                'metro manila', 'manila', 'makati', 'pasig', 'taguig', 'quezon', 'cavite', 'laguna',
                'cebu', 'davao', 'barangay', 'brgy', 'intramuros', 'bicutan', 'paranaque', 'muntinlupa',
                'mandaluyong', 'san juan', 'caloocan', 'valenzuela', 'malabon', 'navotas', 'pateros',
                // Street types (full + abbreviations)
                'road', 'rd', 'rd.', 'street', 'st', 'st.', 'avenue', 'ave', 'ave.',
                'boulevard', 'blvd', 'blvd.', 'drive', 'dr', 'dr.', 'lane', 'ln',
                'highway', 'hwy', 'corner', 'cor', 'cor.',
                // Building types (full + abbreviations)
                'building', 'bldg', 'bldg.', 'floor', 'flr', 'flr.', 'room', 'rm', 'rm.',
                'tower', 'twr', 'unit', 'suite', 'ste', 'level', 'lvl',
                // Other address parts
                'industrial', 'block', 'blk', 'lot', 'phase', 'no.', 'number'
            ];

            // SIMPLE DIRECT APPROACH: Find lines with "Add:" prefix and merge subsequent address-looking lines
            const addressMergedLines = [];
            i = 0; // Reset i (already declared above)

            console.log('[Address Merge v3] Starting address merge. Lines before:', lines);

            while (i < lines.length) {
                const line = lines[i];
                const lower = line.toLowerCase();

                // Check if this line starts an address (has "Add:" prefix or is clearly an address start)
                const hasAddPrefix = /^(add|address|addr)[\s.:]/i.test(line);
                const hasLocationWord = ADDRESS_LOCATION_WORDS.some(w => lower.includes(w));
                const hasNumber = lower.includes('no.') || /\d/.test(line);

                // Strong address indicators that don't need numbers (include abbreviations)
                const strongAddressWords = [
                    'floor', 'flr', 'flr.', 'building', 'bldg', 'bldg.', 'tower', 'twr',
                    'unit', 'suite', 'ste', 'room', 'rm', 'rm.', 'level', 'lvl',
                    'block', 'blk', 'lot', 'phase', 'compound', 'complex', 'plaza'
                ];
                const hasStrongAddressWord = strongAddressWords.some(w => lower.includes(w));

                // Count location words - multiple = likely address
                const locationWordCount = ADDRESS_LOCATION_WORDS.filter(w => lower.includes(w)).length;

                // Address start if:
                // - Has "Add:" prefix
                // - Has location word + number (original logic)
                // - Has strong address word (floor, building, etc.)
                // - Has multiple location words
                // - Ends with comma (often indicates address continuation)
                const endsWithComma = line.trim().endsWith(',');
                const isAddressStart = hasAddPrefix ||
                    (hasLocationWord && hasNumber) ||
                    hasStrongAddressWord ||
                    locationWordCount >= 2 ||
                    (hasLocationWord && endsWithComma);

                console.log(`[Address Merge v3] Line ${i}: "${line}" | hasAddPrefix=${hasAddPrefix} | hasLocationWord=${hasLocationWord} | hasNumber=${hasNumber} | hasStrongAddressWord=${hasStrongAddressWord} | locationWordCount=${locationWordCount} | endsWithComma=${endsWithComma} | isAddressStart=${isAddressStart}`);

                if (isAddressStart) {
                    // Start collecting address lines
                    const addressParts = [line];
                    console.log(`[Address Merge v3] ADDRESS START FOUND at line ${i}`);
                    let j = i + 1;

                    // Look ahead and collect continuation lines
                    while (j < lines.length) {
                        const nextLine = lines[j];
                        const nextLower = nextLine.toLowerCase();

                        console.log(`[Address Merge v3] Checking continuation line ${j}: "${nextLine}"`);

                        // STOP if line is clearly not an address
                        if (nextLine.includes('@')) { console.log('  -> STOP: has email'); break; }
                        if (/^\+?\d[\d\s().-]{9,}$/.test(nextLine.replace(/\s/g, ''))) { console.log('  -> STOP: is phone'); break; }
                        if (/^(tel|phone|mobile|fax|email|web|www)/i.test(nextLine.trim())) { console.log('  -> STOP: is label'); break; }
                        if (COMPANY_SUFFIX_WORD_REGEX.test(nextLower) && !ADDRESS_LOCATION_WORDS.some(w => nextLower.includes(w))) { console.log('  -> STOP: is company'); break; }

                        // CONTINUE if line looks like address continuation
                        const hasLocWord = ADDRESS_LOCATION_WORDS.some(w => nextLower.includes(w));
                        const hasComma = nextLine.includes(',');
                        const startsLower = /^[a-z]/.test(nextLine.trim());
                        const isShort = nextLine.length < 40;
                        const looksLikeAddress = hasLocWord || hasComma || startsLower || isShort;

                        console.log(`  -> hasLocWord=${hasLocWord} hasComma=${hasComma} startsLower=${startsLower} isShort=${isShort} => looksLikeAddress=${looksLikeAddress}`);

                        if (looksLikeAddress) {
                            addressParts.push(nextLine);
                            console.log(`  -> ADDED to address parts`);
                            j++;
                        } else {
                            console.log('  -> STOP: does not look like address');
                            break;
                        }
                    }

                    // Merge all collected address parts
                    if (addressParts.length > 1) {
                        const merged = addressParts.join(' ').replace(/\s+/g, ' ').trim();
                        addressMergedLines.push(merged);
                        console.log(`[Address] Merged ${addressParts.length} lines: "${merged}"`);
                    } else {
                        addressMergedLines.push(line);
                    }
                    i = j; // Skip to after the merged lines
                } else {
                    addressMergedLines.push(line);
                    i++;
                }
            }

            lines = addressMergedLines;
            console.log('[Address Merge v3] Lines AFTER merge:', lines);

            // Extract emails - must have proper format with domain
            const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/gi;
            let emails = (normalizedText.match(emailRegex) || []).filter(e => e.length > 5 && e.includes('.'));

            // Sort emails: prefer personal emails (with person names) over generic company emails
            const genericEmailPrefixes = ['info', 'sales', 'support', 'contact', 'admin', 'hello', 'office', 'enquiry', 'inquiry', 'marketing'];
            emails.sort((a, b) => {
                const aPrefix = a.split('@')[0].toLowerCase();
                const bPrefix = b.split('@')[0].toLowerCase();
                const aIsGeneric = genericEmailPrefixes.some(p => aPrefix.includes(p));
                const bIsGeneric = genericEmailPrefixes.some(p => bPrefix.includes(p));
                if (aIsGeneric && !bIsGeneric) return 1;  // b comes first (personal email)
                if (!aIsGeneric && bIsGeneric) return -1; // a comes first (personal email)
                return 0;
            });

            // Extract phone numbers - need at least 7 digits total, handle various formats
            // Look for lines with "Mobile", "Tel", "Phone" or standalone number patterns
            const phonePatterns = [];

            // Pattern 1: Numbers with Mobile/Tel/Phone prefix
            const labeledPhoneRegex = /(?:mobile|tel|phone|fax|cell)[\s.:]*(?:no)?[\s.:]*([+\d\s()/-]{7,})/gi;
            let match;
            while ((match = labeledPhoneRegex.exec(normalizedText)) !== null) {
                phonePatterns.push(match[1]);
            }

            // Pattern 2: Standalone phone numbers (7+ digits with optional formatting)
            // Supports: (123) 456-7890, 123.456.7890, 123-456-7890, +63 928 520 1886, (0928) 520-1886, etc.
            const standalonePhoneRegex = /(?:^|[\s:])(\+?63[\s.-]?\d{3}[\s.-]?\d{3}[\s.-]?\d{4}|\+?63[\s.-]?\d{10}|\(?\d{3,4}\)?[\s.-]?\d{3,4}[\s.-]?\d{4}|0\d{3}[\s.-]?\d{3}[\s.-]?\d{4}|0\d{3}[\s.-]?\d{7}|\d{3,4}[\s.-]\d{3,4}[\s.-]\d{3,4})/gm;
            while ((match = standalonePhoneRegex.exec(normalizedText)) !== null) {
                phonePatterns.push(match[1]);
            }

            // Clean and deduplicate phones
            const phones = [...new Set(phonePatterns
                .map(p => p.replace(/[\s()-]/g, '').replace(/^[:.]/, '').trim())
                .filter(p => {
                    const digitsOnly = p.replace(/\D/g, '');
                    return digitsOnly.length >= 7 && digitsOnly.length <= 15;
                })
            )];

            // Extract websites
            const websiteRegex = /(?:https?:\/\/)?(?:www\.)?[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(?:\/\S*)?/gi;
            const websites = (normalizedText.match(websiteRegex) || []).filter(w => !w.includes('@'));

            // Common company suffixes
            const companySuffixes = [
                'inc', 'inc.', 'incorporated', 'corp', 'corp.', 'corporation',
                'llc', 'l.l.c.', 'ltd', 'ltd.', 'limited', 'co', 'co.',
                'company', 'enterprises', 'solutions', 'services', 'group',
                'technologies', 'tech', 'systems', 'industries', 'international',
                'holdings', 'partners', 'associates', 'consulting', 'agency',
                'engineering', 'construction', 'trading', 'realty', 'properties'
            ];

            // Address keywords - expanded for international addresses
            const addressKeywords = [
                // Street types
                'street', 'st.', 'avenue', 'ave', 'ave.', 'road', 'rd', 'rd.',
                'boulevard', 'blvd', 'drive', 'dr.', 'lane', 'ln', 'way', 'highway', 'hwy',
                // Building/unit
                'floor', 'flr', 'suite', 'ste', 'unit', 'building', 'bldg', 'tower', 'plaza',
                'phase', 'block', 'blk', 'lot', 'village', 'subdivision', 'subd', 'compound', 'heights', 'homes',
                // Area types
                'city', 'town', 'province', 'state', 'county', 'district', 'zone', 'area',
                'industrial', 'park', 'estate', 'complex',
                // Philippine - Metro Manila
                'barangay', 'brgy', 'brgy.', 'metro manila', 'ncr', 'makati', 'quezon city', 'manila', 'pasig', 'taguig', 'bgc',
                'mandaluyong', 'san juan', 'pasay', 'paranaque', 'muntinlupa', 'alabang', 'las pinas', 'marikina',
                'caloocan', 'malabon', 'navotas', 'valenzuela', 'ortigas', 'eastwood', 'cubao',
                // Philippine - Calabarzon & Central Luzon
                'cavite', 'laguna', 'batangas', 'rizal', 'bulacan', 'pampanga', 'bacoor', 'imus', 'dasmarinas',
                'sta. rosa', 'santa rosa', 'calamba', 'antipolo', 'cainta', 'taytay', 'san fernando', 'angeles', 'clark', 'subic',
                // Philippine - Other regions
                'cebu', 'davao', 'iloilo', 'bacolod', 'cagayan de oro', 'baguio', 'pangasinan', 'ilocos',
                // China specific
                'guangdong', 'shenzhen', 'foshan', 'dongguan', 'guangzhou', 'shanghai', 'beijing', 'nanhai', 'china', 'zhejiang', 'jiangsu',
                // Other international
                'usa', 'uk', 'singapore', 'hong kong', 'japan', 'korea', 'taiwan', 'thailand', 'vietnam', 'indonesia', 'malaysia', 'india',
                // Office indicators
                'head office', 'main office', 'branch office', 'place', 'center', 'centre',
                // Common address prefixes
                'add:', 'add.', 'address:', 'addr:', 'no.', 'no:'
            ];

            // Categorize each line
            const categorized = {
                name: null,
                position: null,
                company: null,
                phones: phones, // Store ALL phone numbers
                phone: phones[0] || '', // Primary phone for backward compatibility
                email: emails[0] || '',
                website: websites[0] || '',
                address: null,
                otherLines: []
            };

            // Lines that contain extracted data (to exclude from other processing)
            const usedLines = new Set();

            // Mark lines containing emails, phones, websites, or label-only lines
            lines.forEach((line, idx) => {
                const lineLower = line.toLowerCase();
                // Mark email lines
                if (emails.some(e => lineLower.includes(e.toLowerCase()))) usedLines.add(idx);
                // Mark phone lines - check if line has phone numbers or is a phone label
                const hasPhoneDigits = phones.some(p => {
                    const last7 = p.slice(-7);
                    return line.replace(/[\s-]/g, '').includes(last7);
                });
                if (hasPhoneDigits || /^(mobile|tel|phone|fax|cell)[\s.:]*no?\.?$/i.test(line.trim())) {
                    usedLines.add(idx);
                }
                // Mark website lines
                if (websites.some(w => lineLower.includes(w.toLowerCase()))) usedLines.add(idx);
                // Mark label-only lines like "Email", "Tel. No.", etc.
                if (/^(email|e-mail|tel|telephone|mobile|phone|fax|address|website|web)[\s.:]*$/i.test(line.trim())) {
                    usedLines.add(idx);
                }
                // Mark lines that are just colons or punctuation with short text
                if (/^[:.\s]*$/.test(line) || line.length <= 2) {
                    usedLines.add(idx);
                }
            });

            // STEP 1: Find name with professional suffix (highest priority - these are definitely names)
            lines.forEach((line, idx) => {
                if (usedLines.has(idx) || categorized.name) return;
                const lineLower = line.toLowerCase();

                // Use precompiled regex for professional suffix check
                if (PROFESSIONAL_SUFFIX_REGEX.test(lineLower)) {
                    categorized.name = line;
                    usedLines.add(idx);
                }
            });

            // STEP 2: Find position/title line FIRST (helps identify name)
            // Collect ALL potential position lines with scores, then pick the best one
            const positionCandidates = [];

            lines.forEach((line, idx) => {
                if (usedLines.has(idx)) return;
                const lineLower = line.toLowerCase();

                // Use precompiled regex for title keyword check
                if (!TITLE_KEYWORD_REGEX.test(lineLower)) return;

                // Find which keywords matched for scoring
                const matchedKeywords = TITLE_KEYWORDS.filter(kw => lineLower.includes(kw));

                // Don't use as title if it looks like a company name with strong suffix
                if (STRONG_SUFFIX_REGEX.test(lineLower)) return;

                // Don't use as title if it looks like an address
                const addressIndicators = ['building', 'bldg', 'floor', 'flr', 'street', 'st.', 'avenue', 'ave', 'road', 'rd', 'place', 'tower', 'unit', 'suite', 'block', 'blk', 'lot', 'phase', 'head office', 'main office', 'branch office'];
                const looksLikeAddress = addressIndicators.some(ind => lineLower.includes(ind));
                if (looksLikeAddress) {
                    console.log(`[Parser] Skipping "${line}" - looks like address`);
                    return;
                }

                // Calculate a score for this position candidate
                let score = 10;

                // PENALTY: Lines that look like service/feature lists (dot-separated items)
                // e.g., ".SALES .SERVICES" or "ENGINEERING . MAINTENANCE"
                const dotSeparatedItems = line.split(/[.•·]/).filter(s => s.trim().length > 0);
                if (dotSeparatedItems.length >= 2) {
                    // Looks like a bullet list - big penalty
                    score -= 50;
                }

                // PENALTY: All caps service descriptors (like "SALES" alone or in a list)
                const serviceWords = ['sales', 'services', 'maintenance', 'engineering', 'construction', 'consulting', 'trading'];
                const words = lineLower.split(/\s+/);
                const serviceWordCount = words.filter(w => serviceWords.includes(w.replace(/[^a-z]/g, ''))).length;
                if (serviceWordCount >= 2) {
                    score -= 40; // Multiple service words = probably a service list
                }

                // BONUS: Multi-word titles like "account manager", "project manager"
                if (matchedKeywords.some(k => k.includes(' '))) {
                    score += 30;
                }

                // BONUS: Line is short and focused (typical job title length)
                if (line.length < 30 && words.length <= 4) {
                    score += 20;
                }

                // BONUS: Title-case or mixed case (not ALL CAPS service lists)
                if (line !== line.toUpperCase() && line !== line.toLowerCase()) {
                    score += 10;
                }

                console.log(`[Parser] "${line}" score: ${score}`);

                positionCandidates.push({ line, idx, score, keywords: matchedKeywords });
            });

            // Pick the best position candidate
            let positionIdx = -1;
            if (positionCandidates.length > 0) {
                positionCandidates.sort((a, b) => b.score - a.score);
                // Only use if score is positive (not a service list)
                if (positionCandidates[0].score > 0) {
                    categorized.position = positionCandidates[0].line;
                    positionIdx = positionCandidates[0].idx;
                    usedLines.add(positionIdx);
                }
            }

            // STEP 3: If we found a position, the line BEFORE it is likely the person's name
            // (unless we already found a name with professional suffix)
            if (!categorized.name && positionIdx > 0) {
                // Look at the line immediately before the position
                for (let checkIdx = positionIdx - 1; checkIdx >= 0; checkIdx--) {
                    if (usedLines.has(checkIdx)) continue;

                    const candidateLine = lines[checkIdx];
                    const candidateLower = candidateLine.toLowerCase();
                    const words = candidateLine.split(/\s+/);

                    // NEVER use a line with company suffix as a name (use precompiled regex)
                    if (STRONG_SUFFIX_REGEX.test(candidateLower)) continue;

                    // Skip lines that look like service/feature lists (dot-separated)
                    const dotItems = candidateLine.split(/[.•·]/).filter(s => s.trim().length > 0);
                    if (dotItems.length >= 2) continue;

                    // Skip lines that start with dots/bullets (service list items)
                    if (/^[.•·\s]/.test(candidateLine)) continue;

                    // Check if this looks like a person's name (not a company descriptor)
                    const looksLikeName =
                        words.length >= 2 &&
                        words.length <= 4 &&
                        !candidateLine.includes('@') &&
                        !/\d{3}/.test(candidateLine) &&
                        // Exclude common service/business descriptors
                        !['event', 'management', 'services', 'solutions', 'consulting', 'agency', 'industrial', 'controls', 'systems', 'engineering', 'maintenance', 'sales', 'trading', 'construction'].some(w => candidateLower.includes(w));

                    if (looksLikeName) {
                        categorized.name = candidateLine;
                        usedLines.add(checkIdx);
                        break;
                    }
                }
            }

            // STEP 4: Find address lines (collect ALL consecutive address lines, not just the first)
            const addressParts = [];
            let addressStartIdx = -1;

            // Helper to check if a line looks like an address
            const isAddressLikeLine = (line) => {
                const lineLower = line.toLowerCase();
                // Skip company names
                if (STRONG_SUFFIX_REGEX.test(lineLower)) return false;

                const hasAddressKeyword = addressKeywords.some(keyword => lineLower.includes(keyword));
                const hasLocationWord = ADDRESS_LOCATION_WORDS.some(w => lineLower.includes(w));
                const hasZipCode = /\b\d{4,6}\b/.test(line);
                const hasPhaseBlock = /phase|block|lot|blk/i.test(line);
                const hasMultipleCommas = (line.match(/,/g) || []).length >= 2;
                const hasStreetNumber = /^#?\d+\s/.test(line) || /\bno\.?\s*\d/i.test(line);

                return hasAddressKeyword || hasLocationWord || hasPhaseBlock || hasStreetNumber || (hasZipCode && hasMultipleCommas);
            };

            // Find first address line
            for (let idx = 0; idx < lines.length; idx++) {
                if (usedLines.has(idx)) continue;
                if (isAddressLikeLine(lines[idx])) {
                    addressStartIdx = idx;
                    break;
                }
            }

            // If found, collect consecutive address lines
            if (addressStartIdx !== -1) {
                // Words that indicate we've left the address and entered company/brand territory
                const nonAddressIndicators = [
                    'venture', 'distributor', 'dealer', 'authorized', 'exclusive', 'official',
                    'supplier', 'manufacturer', 'importer', 'exporter', 'retailer', 'wholesale',
                    'representative', 'agent', 'partner', 'member', 'affiliate', 'branch',
                    'division', 'subsidiary', 'franchise', 'licensed', 'certified'
                ];

                for (let idx = addressStartIdx; idx < lines.length; idx++) {
                    if (usedLines.has(idx)) continue;
                    const line = lines[idx];
                    const lineLower = line.toLowerCase();

                    // Stop conditions
                    if (line.includes('@')) break; // Email
                    if (/^\+?\d[\d\s().-]{9,}$/.test(line.replace(/\s/g, ''))) break; // Phone
                    if (/^(tel|phone|mobile|fax|email|web|www)/i.test(line.trim())) break; // Label
                    if (STRONG_SUFFIX_REGEX.test(lineLower) && !ADDRESS_LOCATION_WORDS.some(w => lineLower.includes(w))) break; // Company

                    // Stop if line contains business/company indicators (not address)
                    if (nonAddressIndicators.some(w => lineLower.includes(w))) {
                        console.log(`[STEP 4] STOP: "${line}" contains business indicator`);
                        break;
                    }

                    // Stop if line looks like brand names (multiple ALL CAPS words, no address keywords)
                    const allCapsWords = line.split(/\s+/).filter(w => w === w.toUpperCase() && w.length > 2 && /[A-Z]/.test(w));
                    if (allCapsWords.length >= 2 && !ADDRESS_LOCATION_WORDS.some(w => lineLower.includes(w))) {
                        console.log(`[STEP 4] STOP: "${line}" looks like brand names`);
                        break;
                    }

                    // Check if looks like address continuation
                    const isAddress = isAddressLikeLine(line);
                    const hasComma = line.includes(',');
                    const endsWithComma = line.trim().endsWith(',');
                    const hasAddressWord = ADDRESS_LOCATION_WORDS.some(w => lineLower.includes(w));

                    // Only continue if it actually looks like an address (not just because it's short)
                    if (isAddress || (hasComma && hasAddressWord) || endsWithComma) {
                        addressParts.push(line);
                        usedLines.add(idx);
                    } else if (addressParts.length > 0) {
                        // Already have address parts, this line doesn't look like address - stop
                        break;
                    }
                }

                if (addressParts.length > 0) {
                    categorized.address = addressParts.join(' ').replace(/\s+/g, ' ').trim();
                    console.log(`[STEP 4] Collected ${addressParts.length} address lines: "${categorized.address}"`);
                }
            }

            // STEP 5: Find company line - collect candidates and pick the best one
            const companyStrongIndicators = ['inc', 'inc.', 'corp', 'corporation', 'llc', 'ltd', 'enterprises', 'industries', 'international', 'construction', 'builders'];
            const companyCandidates = [];

            lines.forEach((line, idx) => {
                if (usedLines.has(idx)) return;
                const lineLower = line.toLowerCase();

                // Use precompiled regex for company suffix check
                if (COMPANY_SUFFIX_WORD_REGEX.test(lineLower)) {
                    // Score the company candidate
                    let score = line.length;

                    // Strong bonus for definite company indicators (INC, CORP, LLC, etc.)
                    if (companyStrongIndicators.some(ind => lineLower.includes(ind))) {
                        score += 100;
                    }

                    // Bonus for ALL CAPS
                    if (line === line.toUpperCase() && /[A-Z]/.test(line)) {
                        score += 20;
                    }

                    // PENALTY: If it looks like a person's name (2 words, both capitalized proper names)
                    const words = line.split(/\s+/);
                    if (words.length === 2 && words.every(w => /^[A-Z][a-z]*$/.test(w) || /^[A-Z]+$/.test(w))) {
                        // Could be a person's name like "ROBIN REYES" - reduce score unless it has strong company indicators
                        if (!companyStrongIndicators.some(ind => lineLower.includes(ind))) {
                            score -= 50;
                        }
                    }

                    companyCandidates.push({ line, idx, score });
                }
            });

            // Pick the best company candidate
            if (companyCandidates.length > 0) {
                companyCandidates.sort((a, b) => b.score - a.score);
                // Only use if score is positive (not penalized too much)
                if (companyCandidates[0].score > 0) {
                    categorized.company = companyCandidates[0].line;
                    usedLines.add(companyCandidates[0].idx);
                }
            }

            // If no name with professional suffix, find name from remaining lines
            if (!categorized.name) {
                lines.forEach((line, idx) => {
                    if (usedLines.has(idx) || categorized.name) return;

                    const lineLower = line.toLowerCase();
                    const words = line.split(/[\s,]+/).filter(w => w.length > 0);

                    // NEVER use lines with company suffixes as names (use precompiled regex)
                    if (STRONG_SUFFIX_REGEX.test(lineLower)) return;

                    // Name patterns: 2-5 words, mostly letters, may have comma for suffix
                    const isLikelyName =
                        words.length >= 2 &&
                        words.length <= 5 &&
                        !line.includes('@') &&
                        !/\d{3}/.test(line) && // No long number sequences
                        line.length < 40 &&
                        words.every(w => /^[A-Za-z'.,-]+$/.test(w));

                    if (isLikelyName) {
                        categorized.name = line;
                        usedLines.add(idx);
                    }
                });
            }

            // If no name found, use first unused line that looks name-like
            if (!categorized.name) {
                for (let idx = 0; idx < lines.length; idx++) {
                    if (usedLines.has(idx)) continue;
                    const line = lines[idx];
                    const lineLower = line.toLowerCase();
                    const words = line.split(/\s+/);

                    // NEVER use lines with company suffixes as names (use precompiled regex)
                    if (STRONG_SUFFIX_REGEX.test(lineLower)) continue;

                    // Simple heuristic: first line with 2-4 words, no numbers, no special chars
                    if (words.length >= 2 && words.length <= 4 && !/\d/.test(line) && line.length < 40) {
                        categorized.name = line;
                        usedLines.add(idx);
                        break;
                    }
                }
            }

            // If still no name, just use first unused line (but still avoid company names)
            if (!categorized.name) {
                const firstUnused = lines.findIndex((line, idx) => {
                    if (usedLines.has(idx)) return false;
                    // Use precompiled regex
                    return !STRONG_SUFFIX_REGEX.test(line.toLowerCase());
                });
                if (firstUnused !== -1) {
                    categorized.name = lines[firstUnused];
                    usedLines.add(firstUnused);
                }
            }

            // If no company found, try to find one from remaining lines
            if (!categorized.company) {
                const remainingLines = lines.filter((_, idx) => !usedLines.has(idx));
                // Company names are often in ALL CAPS
                const possibleCompany = remainingLines.find(line => {
                    const isAllCaps = line === line.toUpperCase() && line.length > 3 && /[A-Z]/.test(line);
                    return isAllCaps && !/\d{4}/.test(line); // Not a phone or zip
                });
                if (possibleCompany) {
                    categorized.company = possibleCompany;
                    usedLines.add(lines.indexOf(possibleCompany));
                }
            }

            // Collect remaining lines as potential address
            const remainingLines = lines.filter((_, idx) => !usedLines.has(idx));
            if (!categorized.address && remainingLines.length > 0) {
                // Find lines that look like address parts
                const isAddressLine = (line) => {
                    const lower = line.toLowerCase();
                    // Has address keyword
                    if (addressKeywords.some(kw => lower.includes(kw))) return true;
                    // Has numbers (street numbers, zip codes, building numbers)
                    if (/\d/.test(line)) return true;
                    // Looks like location continuation (city, country, etc.) - ends with comma or is short
                    if (line.length < 30 && /,/.test(line)) return true;
                    // Is a country or region name
                    if (/\b(china|usa|philippines|singapore|japan|korea|india|uk|australia|canada|germany|france)\b/i.test(line)) return true;
                    return false;
                };

                // Find consecutive address lines starting from first address-like line
                const addressLines = [];
                let foundFirstAddress = false;
                let consecutiveNonAddress = 0;

                for (const line of remainingLines) {
                    if (isAddressLine(line)) {
                        // Check if line starts with "Add:" or similar prefix and clean it
                        const cleanedLine = line.replace(/^(add|address|addr)[\s.:]+/i, '').trim();
                        addressLines.push(cleanedLine || line);
                        foundFirstAddress = true;
                        consecutiveNonAddress = 0;
                    } else if (foundFirstAddress) {
                        // Allow 1 non-address line in between (might be part of address)
                        consecutiveNonAddress++;
                        if (consecutiveNonAddress > 1) break;
                        // Short lines after address start are likely address continuations
                        if (line.length < 40 && !/@/.test(line) && !/^(mobile|tel|phone|fax)/i.test(line)) {
                            addressLines.push(line);
                        }
                    }
                }

                if (addressLines.length > 0) {
                    // Join all address lines, use comma or space depending on context
                    categorized.address = addressLines
                        .map(l => l.trim())
                        .filter(l => l.length > 0)
                        .join(', ')
                        .replace(/,\s*,/g, ',') // Remove double commas
                        .replace(/\s+/g, ' '); // Normalize spaces
                }
            }

            // Format multiple phones for display
            const phoneDisplay = phones.length > 1
                ? phones.join(' / ')
                : phones[0] || '';

            // CLEANUP: Fix common OCR artifacts
            // Remove single-letter prefix from position (e.g., "A Sales Manager" → "Sales Manager")
            // This happens when Chinese characters are misread
            let cleanPosition = categorized.position || '';
            if (/^[A-Z]\s+[A-Z]/i.test(cleanPosition)) {
                cleanPosition = cleanPosition.replace(/^[A-Z]\s+/, '');
                console.log(`[Cleanup] Fixed position: "${categorized.position}" → "${cleanPosition}"`);
            }

            // Remove Chinese characters from position if they were incorrectly included
            cleanPosition = cleanPosition.replace(/[\u4e00-\u9fff]+\s*/g, '').trim();

            // Clean up name - remove Chinese characters if mixed with English name
            let cleanName = categorized.name || 'Unknown';
            // If name has both Chinese and English, prefer the English part
            if (/[\u4e00-\u9fff]/.test(cleanName) && /[A-Za-z]{2,}/.test(cleanName)) {
                const englishPart = cleanName.replace(/[\u4e00-\u9fff]+/g, '').trim();
                if (englishPart.length > 3) {
                    cleanName = englishPart;
                    console.log(`[Cleanup] Extracted English name: "${cleanName}"`);
                }
            }

            console.log('[Parser v2] Final categorized address:', categorized.address);

            const result = {
                name: cleanName,
                position: cleanPosition,
                company: categorized.company || '',
                phone: phoneDisplay, // All phones joined
                phones: phones, // Array of all phones
                email: categorized.email,
                website: categorized.website,
                address: categorized.address || '',
                notes: '',
                rawText: text // Keep for AI validation
            };

            return result;
        };

        // Validate/correct parsing with Gemini AI
        const validateWithGemini = async (rawText, parsed) => {
            console.log('[Gemini] Enhancing parsing to 99% accuracy...');

            try {
                const prompt = `You are an expert business card data curator. Your goal is to polish OCR-extracted contact information to 99% accuracy.

RAW OCR TEXT:
${rawText}

INITIAL PARSED DATA (needs refinement):
Name: ${parsed.name}
Position: ${parsed.position}
Company: ${parsed.company}
Phone: ${parsed.phone}
Email: ${parsed.email}
Address: ${parsed.address}

YOUR TASK: Improve accuracy to 99% by:
1. **Fix spacing**: "JohnSmith" → "John Smith", "Acme Inc" → "Acme Inc."
2. **Proper capitalization**: "ACME INC" → "Acme Inc.", "john smith" → "John Smith"
3. **Validate name/company**: Person names are 2-4 words. Companies have Inc/Corp/LLC/Solutions/Services
4. **Standardize phone**: Use consistent format (keep country code if present)
5. **Clean artifacts**: Remove OCR errors like extra spaces, weird characters
6. **Infer missing data**: If position is missing but context suggests a role, add it
7. **Format company properly**: "ACME, INC." → "Acme, Inc."
8. **CRITICAL - Merge fragmented company names**: OCR often splits company names across lines. Look in raw text for patterns like:
   - "Google" on one line, "LLC" on another → combine to "Google LLC"
   - "JIVO" on one line, "ENERGY" on another → combine to "Jivo Energy"
   - Brand name + continuation word (Energy, Group, Systems, Solutions, Technologies, Industries, Holdings, etc.)
   - Company name in logo text that appears separately from suffix
   If the parsed company is incomplete, search the RAW text for the full company name and combine ALL the parts.
9. **CRITICAL - Merge multi-line addresses**: Addresses often span 2-4 lines. Look in raw text for:
   - Street/building info on one line, district/city on another, country on third
   - Example: "No.6 Foluo Road Industrial" + "Park,Nanhai District,Foshan," + "Guangdong,China" → full address
   - Include ALL address parts: street, building, district, city, province/state, country
   - Remove "Add:" or "Address:" prefixes but keep ALL location data

Return ONLY valid JSON (no markdown formatting):
{
  "name": "Properly Capitalized Name",
  "position": "Job Title",
  "company": "Company Name Inc.",
  "phone": "formatted phone",
  "email": "email@domain.com",
  "address": "Full Street Address, District, City, Country"
}

CRITICAL: Ensure name is a person, company has business indicators. If you swap them, verify it makes sense.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GOOGLE_VISION_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 500
                        }
                    })
                });

                const data = await response.json();

                if (data.error) {
                    console.error('[Gemini] API error:', data.error);
                    return { ...parsed, _aiValidated: false, _aiError: data.error.message || 'API error' };
                }

                // Safe navigation with null checks
                const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                    console.warn('[Gemini] Empty or malformed response, using original parsing');
                    return { ...parsed, _aiValidated: false, _aiError: 'Empty response from AI' };
                }

                // Extract JSON from response (handle markdown code blocks)
                let jsonText = text.trim();
                if (jsonText.startsWith('```')) {
                    jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                }

                const corrected = JSON.parse(jsonText);

                console.log('[Gemini] Enhanced:', {
                    before: { name: parsed.name, company: parsed.company },
                    after: { name: corrected.name, company: corrected.company }
                });

                // Merge corrected data with original (keep phones array)
                // For address: prefer the LONGER one (merged multi-line addresses are more complete)
                const bestAddress = (corrected.address && parsed.address)
                    ? (corrected.address.length >= parsed.address.length ? corrected.address : parsed.address)
                    : (corrected.address || parsed.address);

                console.log('[Gemini] Address comparison:', {
                    ai: corrected.address?.substring(0, 50),
                    parsed: parsed.address?.substring(0, 50),
                    chosen: bestAddress?.substring(0, 50)
                });

                return {
                    ...parsed,
                    name: corrected.name || parsed.name,
                    position: corrected.position || parsed.position,
                    company: corrected.company || parsed.company,
                    phone: corrected.phone || parsed.phone,
                    email: corrected.email || parsed.email,
                    address: bestAddress,
                    _aiValidated: true
                };

            } catch (error) {
                console.error('[Gemini] Validation error:', error);
                return { ...parsed, _aiValidated: false, _aiError: error.message };
            }
        };

        // Parse with optional AI validation
        const parseWithValidation = async (text, useAI = true) => {
            const parsed = parseBusinessCard(text);

            if (!useAI) {
                console.log('[Parser] AI validation disabled, using rule-based parsing only');
                return { ...parsed, _aiValidated: false, _aiError: 'AI disabled' };
            }

            // Enhance with AI for 99% accuracy
            // Uses Gemini 1.5 Flash (free tier: 1,500 requests/day)
            return await validateWithGemini(text, parsed);
        };

        // Google Vision OCR
        const googleVisionOCR = async (imageSrc, apiKey) => {
            console.log('[Google Vision] Starting OCR...');
            const base64Image = imageSrc.replace(/^data:image\/\w+;base64,/, '');

            const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    requests: [{
                        image: { content: base64Image },
                        features: [{ type: 'TEXT_DETECTION' }]
                    }]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API error: ${response.status}`);
            }

            const data = await response.json();
            console.log('[Google Vision] Response received');

            if (data.responses[0]?.error) {
                throw new Error(data.responses[0].error.message);
            }

            const text = data.responses[0]?.fullTextAnnotation?.text || '';
            return { text, confidence: text ? 90 : 0 };
        };

        // Convert blob URL or File to base64 data URL
        const toBase64 = async (input) => {
            // If it's already a data URL, return as-is
            if (typeof input === 'string' && input.startsWith('data:')) {
                return input;
            }

            // If it's a blob URL, fetch and convert
            if (typeof input === 'string' && input.startsWith('blob:')) {
                const response = await fetch(input);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            // If it's a File or Blob object
            if (input instanceof Blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(input);
                });
            }

            return input;
        };

        // Preprocess image for better OCR (grayscale, contrast, threshold)
        const preprocessImage = async (imageSrc) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Use larger canvas for better quality
                    const scale = Math.max(1, 1500 / Math.max(img.width, img.height));
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;

                    // Draw original image
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // Convert to grayscale and increase contrast
                    for (let i = 0; i < data.length; i += 4) {
                        // Grayscale
                        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];

                        // Increase contrast
                        const contrast = 1.5;
                        const factor = (259 * (contrast * 100 + 255)) / (255 * (259 - contrast * 100));
                        let newGray = factor * (gray - 128) + 128;

                        // Clamp values
                        newGray = Math.max(0, Math.min(255, newGray));

                        // Apply threshold for cleaner text (binarization)
                        const threshold = 140;
                        const finalValue = newGray > threshold ? 255 : 0;

                        data[i] = finalValue;     // R
                        data[i + 1] = finalValue; // G
                        data[i + 2] = finalValue; // B
                        // Alpha stays the same
                    }

                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = () => resolve(imageSrc); // Fallback to original
                img.src = imageSrc;
            });
        };

        // Tesseract OCR with preprocessing
        const tesseractOCR = async (imageSrc, onProgress) => {
            console.log('[Tesseract] Starting OCR...');

            // Preprocess image for better recognition
            if (onProgress) onProgress('Preprocessing image...', 10);
            const processedImage = await preprocessImage(imageSrc);
            console.log('[Tesseract] Image preprocessed');

            const worker = await Tesseract.createWorker('eng', 1, {
                logger: m => {
                    console.log('[Tesseract]', m.status, m.progress ? Math.round(m.progress * 100) + '%' : '');
                    if (onProgress && m.progress) onProgress(m.status, Math.round(m.progress * 100));
                }
            });

            const result = await worker.recognize(processedImage);
            await worker.terminate();

            console.log('[Tesseract] Complete, confidence:', result.data.confidence);
            console.log('[Tesseract] Raw text:', result.data.text);
            return { text: result.data.text, confidence: result.data.confidence };
        };

        const App = () => {
            // Core state
            const [view, setView] = useState('home');
            const [contacts, setContacts] = useState([]);
            const [capturedImage, setCapturedImage] = useState(null);
            const [ocrResult, setOcrResult] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);

            // Settings state
            // API keys are defined globally (see top of file)
            const googleApiKey = GOOGLE_VISION_API_KEY;
            const [ocrEngine, setOcrEngine] = useState(localStorage.getItem('ocr_engine') || 'tesseract');
            const [aiValidation, setAiValidation] = useState(localStorage.getItem('ai_validation') !== 'false'); // Default ON

            // Google Drive sync state
            const driveClientId = GOOGLE_DRIVE_CLIENT_ID;
            const [driveConnected, setDriveConnected] = useState(false);
            const [driveUser, setDriveUser] = useState(null);
            const [driveSyncing, setDriveSyncing] = useState(false);
            const [driveFileId, setDriveFileId] = useState(localStorage.getItem('drive_file_id') || null);
            const [lastSyncTime, setLastSyncTime] = useState(localStorage.getItem('last_sync_time') || null);

            // Bulk upload state
            const [bulkQueue, setBulkQueue] = useState([]);
            const [bulkResults, setBulkResults] = useState([]);

            // Manual entry state
            const [manualEntry, setManualEntry] = useState({
                name: '', position: '', company: '', phone: '', email: '', address: '', notes: ''
            });

            // Error and status state
            const [error, setError] = useState(null);
            const [statusMessage, setStatusMessage] = useState('');
            const [progress, setProgress] = useState(0);

            // Refs
            const videoRef = useRef(null);
            const fileInputRef = useRef(null);

            // Load contacts from localStorage
            useEffect(() => {
                const saved = localStorage.getItem('demo_contacts');
                if (saved) setContacts(JSON.parse(saved));
            }, []);

            // Google Drive API Configuration
            const DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
            const DRIVE_FILE_NAME = 'curator-contacts.json';

            // Initialize Google API client
            const initGoogleDrive = async () => {
                if (!driveClientId) return false;

                return new Promise((resolve) => {
                    if (window.gapi) {
                        window.gapi.load('client', async () => {
                            try {
                                await window.gapi.client.init({
                                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                                });
                                console.log('[Drive] Google API client initialized');
                                resolve(true);
                            } catch (err) {
                                console.error('[Drive] Init error:', err);
                                resolve(false);
                            }
                        });
                    } else {
                        resolve(false);
                    }
                });
            };

            // Google Sign-In
            const connectGoogleDrive = async () => {
                if (!driveClientId) {
                    setError('Please enter your Google Client ID first');
                    return;
                }

                try {
                    await initGoogleDrive();

                    const tokenClient = window.google.accounts.oauth2.initTokenClient({
                        client_id: driveClientId,
                        scope: DRIVE_SCOPES,
                        callback: async (response) => {
                            if (response.access_token) {
                                window.gapi.client.setToken({ access_token: response.access_token });
                                setDriveConnected(true);

                                // Get user info
                                try {
                                    const userInfo = await window.gapi.client.request({
                                        path: 'https://www.googleapis.com/oauth2/v2/userinfo'
                                    });
                                    setDriveUser(userInfo.result);
                                    console.log('[Drive] Connected as:', userInfo.result.email);
                                } catch (e) {
                                    console.log('[Drive] Could not get user info');
                                }

                                // Load contacts from Drive
                                await loadFromDrive();
                            }
                        },
                        error_callback: (err) => {
                            console.error('[Drive] Auth error:', err);
                            setError('Google sign-in failed: ' + (err.message || 'Unknown error'));
                        }
                    });

                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } catch (err) {
                    console.error('[Drive] Connect error:', err);
                    setError('Failed to connect: ' + err.message);
                }
            };

            // Disconnect Google Drive
            const disconnectGoogleDrive = () => {
                if (window.google && window.google.accounts) {
                    window.google.accounts.oauth2.revoke(window.gapi.client.getToken()?.access_token, () => {
                        console.log('[Drive] Token revoked');
                    });
                }
                window.gapi?.client?.setToken(null);
                setDriveConnected(false);
                setDriveUser(null);
                setDriveFileId(null);
                localStorage.removeItem('drive_file_id');
                localStorage.removeItem('last_sync_time');
                setLastSyncTime(null);
            };

            // Find or create the contacts file in Drive
            const findOrCreateDriveFile = async () => {
                try {
                    // Search for existing file in appDataFolder
                    const searchResponse = await window.gapi.client.drive.files.list({
                        spaces: 'appDataFolder',
                        q: `name='${DRIVE_FILE_NAME}'`,
                        fields: 'files(id, name, modifiedTime)'
                    });

                    const files = searchResponse.result.files;

                    if (files && files.length > 0) {
                        console.log('[Drive] Found existing file:', files[0].id);
                        return files[0].id;
                    }

                    // Create new file
                    const createResponse = await window.gapi.client.drive.files.create({
                        resource: {
                            name: DRIVE_FILE_NAME,
                            parents: ['appDataFolder'],
                            mimeType: 'application/json'
                        },
                        fields: 'id'
                    });

                    console.log('[Drive] Created new file:', createResponse.result.id);
                    return createResponse.result.id;
                } catch (err) {
                    console.error('[Drive] File operation error:', err);
                    throw err;
                }
            };

            // Save contacts to Google Drive
            const saveToDrive = async (contactsToSave) => {
                if (!driveConnected) return;

                setDriveSyncing(true);
                try {
                    const fileId = driveFileId || await findOrCreateDriveFile();

                    if (!driveFileId) {
                        setDriveFileId(fileId);
                        localStorage.setItem('drive_file_id', fileId);
                    }

                    // Update file content
                    const content = JSON.stringify({
                        version: 1,
                        contacts: contactsToSave,
                        lastModified: new Date().toISOString()
                    });

                    await window.gapi.client.request({
                        path: `/upload/drive/v3/files/${fileId}`,
                        method: 'PATCH',
                        params: { uploadType: 'media' },
                        headers: { 'Content-Type': 'application/json' },
                        body: content
                    });

                    const syncTime = new Date().toISOString();
                    setLastSyncTime(syncTime);
                    localStorage.setItem('last_sync_time', syncTime);
                    console.log('[Drive] Saved to Drive');
                } catch (err) {
                    console.error('[Drive] Save error:', err);
                    // Don't show error to user for background syncs
                } finally {
                    setDriveSyncing(false);
                }
            };

            // Load contacts from Google Drive
            const loadFromDrive = async () => {
                if (!driveConnected && !window.gapi?.client?.getToken()) return;

                setDriveSyncing(true);
                try {
                    const fileId = driveFileId || await findOrCreateDriveFile();

                    if (!driveFileId) {
                        setDriveFileId(fileId);
                        localStorage.setItem('drive_file_id', fileId);
                    }

                    // Get file content
                    const response = await window.gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });

                    if (response.result && response.result.contacts) {
                        const driveContacts = response.result.contacts;
                        console.log('[Drive] Loaded', driveContacts.length, 'contacts from Drive');

                        // Merge: Drive contacts take priority, but keep local-only contacts
                        const localContacts = JSON.parse(localStorage.getItem('demo_contacts') || '[]');
                        const driveIds = new Set(driveContacts.map(c => c.id));
                        const localOnly = localContacts.filter(c => !driveIds.has(c.id));

                        const merged = [...driveContacts, ...localOnly];
                        setContacts(merged);
                        localStorage.setItem('demo_contacts', JSON.stringify(merged));

                        // Save merged back to Drive if there were local-only contacts
                        if (localOnly.length > 0) {
                            await saveToDrive(merged);
                        }

                        const syncTime = new Date().toISOString();
                        setLastSyncTime(syncTime);
                        localStorage.setItem('last_sync_time', syncTime);
                    }
                } catch (err) {
                    console.error('[Drive] Load error:', err);
                    // File might be empty or not exist yet, that's OK
                } finally {
                    setDriveSyncing(false);
                }
            };

            // Auto-sync when contacts change
            useEffect(() => {
                if (driveConnected && contacts.length > 0) {
                    // Debounce: wait 2 seconds after last change before syncing
                    const timer = setTimeout(() => {
                        saveToDrive(contacts);
                    }, 2000);
                    return () => clearTimeout(timer);
                }
            }, [contacts, driveConnected]);

            // Save contacts to localStorage (always) when they change
            useEffect(() => {
                if (contacts.length > 0) {
                    localStorage.setItem('demo_contacts', JSON.stringify(contacts));
                }
            }, [contacts]);

            // Icon component
            const SafeIcon = ({ name, className = "" }) => {
                const iconRef = useRef(null);
                useEffect(() => {
                    if (iconRef.current && window.lucide) {
                        iconRef.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`;
                        window.lucide.createIcons({ targets: [iconRef.current.firstChild] });
                    }
                }, [name, className]);
                return <span ref={iconRef} style={{ display: 'inline-flex' }}></span>;
            };

            // Camera functions
            const startCamera = async () => {
                setCapturedImage(null);
                setError(null);
                setView('scan');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (e) {
                    setError("Camera access denied. Please allow camera permissions.");
                    setView('home');
                }
            };

            const capture = () => {
                if (!videoRef.current) return;
                const canvas = document.createElement('canvas');
                canvas.width = videoRef.current.videoWidth || 640;
                canvas.height = videoRef.current.videoHeight || 480;
                const ctx = canvas.getContext('2d');
                if (ctx) ctx.drawImage(videoRef.current, 0, 0);
                setCapturedImage(canvas.toDataURL('image/jpeg'));
                // Safely stop video tracks
                if (videoRef.current.srcObject) {
                    videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                }
            };

            // OCR function
            const runOCR = async () => {
                setError(null);
                setStatusMessage('');
                setProgress(0);

                // Validate settings
                if (ocrEngine === 'google' && !googleApiKey) {
                    setError('Google Vision API key not configured. Go to Settings to add your API key, or switch to Tesseract (local) OCR.');
                    return;
                }

                setIsProcessing(true);

                try {
                    let result;

                    if (ocrEngine === 'google') {
                        setStatusMessage('Sending to Google Cloud Vision...');
                        setProgress(50);
                        result = await googleVisionOCR(capturedImage, googleApiKey);
                    } else {
                        setStatusMessage('Loading Tesseract engine...');
                        result = await tesseractOCR(capturedImage, (status, prog) => {
                            setStatusMessage(status);
                            setProgress(prog);
                        });
                    }

                    setProgress(90);
                    setStatusMessage('Parsing results...');

                    const parsed = await parseWithValidation(result.text, aiValidation);
                    setOcrResult({
                        ...parsed,
                        rawText: result.text,
                        confidence: result.confidence,
                        showRawText: false
                    });

                    setProgress(100);
                    setStatusMessage('Complete!');
                    setView('review');
                } catch (e) {
                    console.error('[OCR Error]', e);
                    setError(`OCR Failed: ${e.message}`);
                } finally {
                    setIsProcessing(false);
                }
            };

            // Save contact
            const saveContact = (contact) => {
                const newContacts = [{ ...contact, id: Date.now(), createdAt: new Date().toISOString() }, ...contacts];
                setContacts(newContacts);
                localStorage.setItem('demo_contacts', JSON.stringify(newContacts));
                setOcrResult(null);
                setCapturedImage(null);
                setView('contacts');
            };

            // File upload
            const handleFileUpload = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                setBulkQueue(files.map(f => ({
                    id: Math.random().toString(36).substr(2, 9),
                    file: f,
                    preview: URL.createObjectURL(f),
                    status: 'queued'
                })));
                setError(null);
                setView('upload');
            };

            // Bulk processing
            const processBulk = async () => {
                setError(null);

                if (ocrEngine === 'google' && !googleApiKey) {
                    setError('Google Vision API key not configured. Go to Settings to add your API key, or switch to Tesseract (local) OCR.');
                    return;
                }

                setIsProcessing(true);
                setStatusMessage('Starting batch processing...');
                const results = [];

                try {
                    let worker = null;

                    // Create Tesseract worker once for batch
                    if (ocrEngine === 'tesseract') {
                        setStatusMessage('Loading Tesseract engine...');
                        worker = await Tesseract.createWorker('eng', 1, {
                            logger: m => console.log('[Tesseract]', m.status)
                        });
                    }

                    for (let i = 0; i < bulkQueue.length; i++) {
                        const item = bulkQueue[i];
                        setStatusMessage(`Processing ${i + 1} of ${bulkQueue.length}...`);
                        setBulkQueue(prev => prev.map((q, idx) => idx === i ? { ...q, status: 'processing' } : q));

                        try {
                            let result;
                            if (ocrEngine === 'google') {
                                // Convert blob URL to base64 for Google Vision
                                const base64Image = await toBase64(item.preview);
                                result = await googleVisionOCR(base64Image, googleApiKey);
                            } else {
                                const tesseractResult = await worker.recognize(item.preview);
                                result = { text: tesseractResult.data.text, confidence: tesseractResult.data.confidence };
                            }

                            const parsed = await parseWithValidation(result.text, aiValidation);
                            results.push({
                                ...parsed,
                                id: `${Date.now()}-${i}-${Math.random().toString(36).substr(2, 9)}`,
                                image: item.preview,
                                fileName: item.file.name,
                                rawText: result.text,
                                confidence: result.confidence,
                                approved: true,
                                showRawText: false
                            });

                            setBulkQueue(prev => prev.map((q, idx) => idx === i ? { ...q, status: 'completed' } : q));
                        } catch (err) {
                            console.error(`Error processing ${item.file.name}:`, err);
                            setBulkQueue(prev => prev.map((q, idx) => idx === i ? { ...q, status: 'error', error: err.message } : q));
                        }
                    }

                    setBulkResults(results);
                    setStatusMessage('');

                    if (results.length > 0) {
                        setView('bulk-review');
                    } else {
                        setError('All images failed to process. Check your settings and try again.');
                    }
                } catch (e) {
                    console.error('[Bulk Error]', e);
                    setError(`Batch processing failed: ${e.message}`);
                } finally {
                    // Always terminate worker to prevent memory leaks
                    if (worker) {
                        try { await worker.terminate(); } catch (e) { console.warn('Worker termination failed:', e); }
                    }
                    setIsProcessing(false);
                }
            };

            // Cleanup blob URLs when component unmounts or bulk queue changes
            useEffect(() => {
                return () => {
                    // Revoke blob URLs to prevent memory leaks
                    bulkQueue.forEach(item => {
                        if (item.preview && item.preview.startsWith('blob:')) {
                            URL.revokeObjectURL(item.preview);
                        }
                    });
                };
            }, [bulkQueue]);

            // Save settings
            const saveSettings = () => {
                localStorage.setItem('ocr_engine', ocrEngine);
                localStorage.setItem('ai_validation', aiValidation);
                setView('home');
            };

            // Test API key
            const [apiTestResult, setApiTestResult] = useState(null);
            const [apiTesting, setApiTesting] = useState(false);

            const testApiKey = async () => {
                if (!googleApiKey) {
                    setApiTestResult({ success: false, message: 'Please enter an API key first' });
                    return;
                }

                setApiTesting(true);
                setApiTestResult(null);

                try {
                    const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${googleApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            requests: [{
                                image: { content: 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==' },
                                features: [{ type: 'TEXT_DETECTION' }]
                            }]
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        setApiTestResult({ success: false, message: data.error.message });
                    } else {
                        setApiTestResult({ success: true, message: 'API key is valid!' });
                    }
                } catch (e) {
                    setApiTestResult({ success: false, message: e.message });
                } finally {
                    setApiTesting(false);
                }
            };

            // ==================== RENDER FUNCTIONS ====================

            const renderHome = () => (
                <div className="flex flex-col items-center justify-center min-h-screen p-6 page-enter">
                    {/* Logo Section */}
                    <div className="mb-12 text-center">
                        <div className="mb-4">
                            <svg viewBox="0 0 280 80" xmlns="http://www.w3.org/2000/svg" className="w-56 h-auto mx-auto">
                                <defs>
                                    <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor:'#38bdf8'}} />
                                        <stop offset="50%" style={{stopColor:'#0ea5e9'}} />
                                        <stop offset="100%" style={{stopColor:'#0284c7'}} />
                                    </linearGradient>
                                    <linearGradient id="cardGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor:'#0369a1'}} />
                                        <stop offset="100%" style={{stopColor:'#075985'}} />
                                    </linearGradient>
                                    <filter id="glow">
                                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                        <feMerge>
                                            <feMergeNode in="coloredBlur"/>
                                            <feMergeNode in="SourceGraphic"/>
                                        </feMerge>
                                    </filter>
                                </defs>
                                {/* Icon */}
                                <g transform="translate(0, 10)" filter="url(#glow)">
                                    <path d="M28 5 A22 22 0 1 0 28 49" stroke="url(#logoGrad)" strokeWidth="5" fill="none" strokeLinecap="round"/>
                                    <rect x="14" y="18" width="26" height="17" rx="3" fill="url(#cardGrad)"/>
                                    <rect x="18" y="24" width="14" height="2" rx="1" fill="white" opacity="0.9"/>
                                    <rect x="18" y="29" width="9" height="2" rx="1" fill="white" opacity="0.5"/>
                                </g>
                                {/* Text */}
                                <text x="60" y="42" fontFamily="Inter, sans-serif" fontSize="28" fontWeight="800" fill="#ffffff" letterSpacing="-1">CURA</text>
                                <text x="138" y="42" fontFamily="Inter, sans-serif" fontSize="28" fontWeight="800" fill="url(#logoGrad)" letterSpacing="-1">.TOR</text>
                            </svg>
                        </div>
                        <p className="text-slate-500 text-xs tracking-widest uppercase">Smart Contact Curation</p>
                    </div>

                    {error && (
                        <div className="w-full max-w-md mb-6 p-4 card-elevated border-red-500/30 rounded-2xl flex items-start gap-3">
                            <div className="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0">
                                <SafeIcon name="alert-circle" className="w-4 h-4 text-red-400" />
                            </div>
                            <div className="flex-1">
                                <p className="text-red-400 text-sm font-medium">Error</p>
                                <p className="text-red-400/70 text-xs mt-1">{error}</p>
                            </div>
                            <button onClick={() => setError(null)} className="text-slate-500 hover:text-slate-300 transition-colors">
                                <SafeIcon name="x" className="w-4 h-4" />
                            </button>
                        </div>
                    )}

                    {/* Primary Actions */}
                    <div className="w-full max-w-md mb-6">
                        <p className="section-label mb-3 px-1">Quick Actions</p>
                        <div className="grid grid-cols-3 gap-3">
                            <div onClick={startCamera} className="action-card card-stagger">
                                <div className="icon-wrapper bg-gradient-to-br from-sky-500/20 to-blue-600/20">
                                    <SafeIcon name="scan" className="w-5 h-5 text-sky-400" />
                                </div>
                                <span className="font-semibold text-sm text-white">Scan</span>
                                <span className="text-[10px] text-slate-500">Camera</span>
                            </div>
                            <div onClick={() => fileInputRef.current.click()} className="action-card card-stagger">
                                <input type="file" ref={fileInputRef} onChange={handleFileUpload} multiple accept="image/*" className="hidden" />
                                <div className="icon-wrapper bg-gradient-to-br from-emerald-500/20 to-teal-600/20">
                                    <SafeIcon name="image-plus" className="w-5 h-5 text-emerald-400" />
                                </div>
                                <span className="font-semibold text-sm text-white">Upload</span>
                                <span className="text-[10px] text-slate-500">Images</span>
                            </div>
                            <div onClick={() => setView('manual')} className="action-card card-stagger">
                                <div className="icon-wrapper bg-gradient-to-br from-violet-500/20 to-purple-600/20">
                                    <SafeIcon name="pen-line" className="w-5 h-5 text-violet-400" />
                                </div>
                                <span className="font-semibold text-sm text-white">Manual</span>
                                <span className="text-[10px] text-slate-500">Entry</span>
                            </div>
                        </div>
                    </div>

                    {/* Secondary Actions */}
                    <div className="w-full max-w-md mb-8">
                        <p className="section-label mb-3 px-1">Manage</p>
                        <div className="grid grid-cols-2 gap-3">
                            <div onClick={() => setView('contacts')} className="action-card card-stagger flex-row justify-between px-5">
                                <div className="flex items-center gap-4">
                                    <div className="icon-wrapper bg-gradient-to-br from-cyan-500/20 to-blue-600/20" style={{width: '44px', height: '44px', borderRadius: '12px'}}>
                                        <SafeIcon name="users" className="w-5 h-5 text-cyan-400" />
                                    </div>
                                    <div className="text-left">
                                        <span className="font-semibold text-sm text-white block">Contacts</span>
                                        <span className="text-xs text-slate-500">{contacts.length} saved</span>
                                    </div>
                                </div>
                                <SafeIcon name="chevron-right" className="w-4 h-4 text-slate-600" />
                            </div>
                            <div onClick={() => setView('settings')} className="action-card card-stagger flex-row justify-between px-5">
                                <div className="flex items-center gap-4">
                                    <div className="icon-wrapper bg-gradient-to-br from-amber-500/20 to-orange-600/20" style={{width: '44px', height: '44px', borderRadius: '12px'}}>
                                        <SafeIcon name="settings" className="w-5 h-5 text-amber-400" />
                                    </div>
                                    <div className="text-left">
                                        <span className="font-semibold text-sm text-white block">Settings</span>
                                        <span className="text-xs text-slate-500">Configure</span>
                                    </div>
                                </div>
                                <SafeIcon name="chevron-right" className="w-4 h-4 text-slate-600" />
                            </div>
                        </div>
                    </div>

                    {/* Status Bar */}
                    <div className="w-full max-w-md card-elevated rounded-2xl p-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className={`status-dot ${driveConnected ? 'bg-emerald-500' : 'bg-slate-500'}`}></div>
                                <div>
                                    <p className="text-xs font-medium text-slate-300">
                                        {driveConnected ? 'Synced to Google Drive' : 'Local Storage'}
                                    </p>
                                    {driveConnected && driveSyncing && (
                                        <p className="text-[10px] text-slate-500">Syncing...</p>
                                    )}
                                </div>
                            </div>
                            <div className="flex items-center gap-2 text-xs text-slate-500">
                                <span className="px-2 py-1 bg-slate-800/50 rounded-md">
                                    {ocrEngine === 'google' ? 'Google Vision' : 'Tesseract'}
                                </span>
                                {aiValidation && (
                                    <span className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded-md">AI</span>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderSettings = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button onClick={() => setView('home')} className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors">
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <h2 className="font-semibold text-lg">Settings</h2>
                        <div className="w-10"></div>
                    </header>

                    <div className="p-5 space-y-6 flex-1 overflow-y-auto">
                        {/* OCR Engine Selection */}
                        <div className="space-y-3">
                            <p className="section-label px-1">OCR Engine</p>
                            <div className="space-y-2">
                                <button
                                    onClick={() => setOcrEngine('tesseract')}
                                    className={`w-full p-4 rounded-2xl text-left transition-all flex items-center gap-4 ${ocrEngine === 'tesseract' ? 'card-elevated border-sky-500/30' : 'card-elevated'}`}
                                >
                                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${ocrEngine === 'tesseract' ? 'bg-sky-500/20' : 'bg-slate-700/50'}`}>
                                        <SafeIcon name="cpu" className={`w-5 h-5 ${ocrEngine === 'tesseract' ? 'text-sky-400' : 'text-slate-400'}`} />
                                    </div>
                                    <div className="flex-1">
                                        <div className="font-semibold text-sm flex items-center gap-2">
                                            Tesseract
                                            <span className="text-[10px] px-2 py-0.5 bg-emerald-500/20 text-emerald-400 rounded-full">Free</span>
                                        </div>
                                        <div className="text-xs text-slate-500 mt-0.5">Runs locally in your browser</div>
                                    </div>
                                    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${ocrEngine === 'tesseract' ? 'border-sky-400 bg-sky-400' : 'border-slate-600'}`}>
                                        {ocrEngine === 'tesseract' && <SafeIcon name="check" className="w-3 h-3 text-white" />}
                                    </div>
                                </button>
                                <button
                                    onClick={() => setOcrEngine('google')}
                                    className={`w-full p-4 rounded-2xl text-left transition-all flex items-center gap-4 ${ocrEngine === 'google' ? 'card-elevated border-emerald-500/30' : 'card-elevated'}`}
                                >
                                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${ocrEngine === 'google' ? 'bg-emerald-500/20' : 'bg-slate-700/50'}`}>
                                        <SafeIcon name="cloud" className={`w-5 h-5 ${ocrEngine === 'google' ? 'text-emerald-400' : 'text-slate-400'}`} />
                                    </div>
                                    <div className="flex-1">
                                        <div className="font-semibold text-sm flex items-center gap-2">
                                            Google Vision
                                            <span className="text-[10px] px-2 py-0.5 bg-amber-500/20 text-amber-400 rounded-full">Pro</span>
                                        </div>
                                        <div className="text-xs text-slate-500 mt-0.5">Higher accuracy, cloud-powered</div>
                                    </div>
                                    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${ocrEngine === 'google' ? 'border-emerald-400 bg-emerald-400' : 'border-slate-600'}`}>
                                        {ocrEngine === 'google' && <SafeIcon name="check" className="w-3 h-3 text-white" />}
                                    </div>
                                </button>
                            </div>
                        </div>

                        {/* AI Validation Toggle */}
                        <div className="space-y-3">
                            <p className="section-label px-1">AI Enhancement</p>
                            <div
                                onClick={() => setAiValidation(!aiValidation)}
                                className={`p-4 rounded-2xl cursor-pointer transition-all flex items-center gap-4 ${aiValidation ? 'card-elevated border-purple-500/30' : 'card-elevated'}`}
                            >
                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${aiValidation ? 'bg-purple-500/20' : 'bg-slate-700/50'}`}>
                                    <SafeIcon name="sparkles" className={`w-5 h-5 ${aiValidation ? 'text-purple-400' : 'text-slate-400'}`} />
                                </div>
                                <div className="flex-1">
                                    <div className="font-semibold text-sm">AI-Powered Validation</div>
                                    <div className="text-xs text-slate-500 mt-0.5">Gemini AI improves accuracy to 99%</div>
                                </div>
                                <div className={`toggle-switch ${aiValidation ? 'bg-purple-500' : 'bg-slate-600'}`}>
                                    <div className={`toggle-knob ${aiValidation ? 'left-[26px]' : 'left-[3px]'}`}></div>
                                </div>
                            </div>
                            {!aiValidation && (
                                <div className="flex items-start gap-2 px-2">
                                    <SafeIcon name="alert-triangle" className="w-3 h-3 text-amber-400 mt-0.5 flex-shrink-0" />
                                    <p className="text-xs text-amber-400/80">Without AI, parsing relies on rule-based detection only.</p>
                                </div>
                            )}
                        </div>

                        {/* Google Drive Sync */}
                        <div className="space-y-3">
                            <p className="section-label px-1">Cloud Backup</p>
                            <div className="card-elevated rounded-2xl p-4">
                                {driveConnected ? (
                                    <>
                                        <div className="flex items-center gap-4 mb-4">
                                            <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                                                <SafeIcon name="cloud-check" className="w-6 h-6 text-white" />
                                            </div>
                                            <div className="flex-1">
                                                <p className="font-semibold text-sm text-emerald-400">Connected</p>
                                                {driveUser && <p className="text-xs text-slate-500">{driveUser.email}</p>}
                                            </div>
                                            {driveSyncing && (
                                                <div className="animate-spin h-5 w-5 border-2 border-emerald-500 border-t-transparent rounded-full"></div>
                                            )}
                                        </div>
                                        {lastSyncTime && (
                                            <p className="text-xs text-slate-500 mb-4 flex items-center gap-1">
                                                <SafeIcon name="clock" className="w-3 h-3" />
                                                Last synced: {new Date(lastSyncTime).toLocaleString()}
                                            </p>
                                        )}
                                        <div className="flex gap-2">
                                            <button
                                                onClick={loadFromDrive}
                                                disabled={driveSyncing}
                                                className="flex-1 py-3 text-sm btn-secondary rounded-xl disabled:opacity-50 flex items-center justify-center gap-2"
                                            >
                                                <SafeIcon name="refresh-cw" className="w-4 h-4" />
                                                Sync Now
                                            </button>
                                            <button
                                                onClick={disconnectGoogleDrive}
                                                className="py-3 px-4 text-sm bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition-colors"
                                            >
                                                <SafeIcon name="unplug" className="w-4 h-4" />
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div className="flex items-center gap-4 mb-4">
                                            <div className="w-12 h-12 bg-slate-700/50 rounded-xl flex items-center justify-center">
                                                <SafeIcon name="cloud-off" className="w-5 h-5 text-slate-400" />
                                            </div>
                                            <div>
                                                <p className="font-semibold text-sm">Google Drive Backup</p>
                                                <p className="text-xs text-slate-500">Keep your contacts safe in the cloud</p>
                                            </div>
                                        </div>
                                        <div className="space-y-2 mb-4 px-1">
                                            <div className="flex items-center gap-2 text-xs text-slate-400">
                                                <SafeIcon name="shield-check" className="w-3 h-3 text-emerald-400" />
                                                <span>Survives browser cache clearing</span>
                                            </div>
                                            <div className="flex items-center gap-2 text-xs text-slate-400">
                                                <SafeIcon name="smartphone" className="w-3 h-3 text-sky-400" />
                                                <span>Syncs across all your devices</span>
                                            </div>
                                            <div className="flex items-center gap-2 text-xs text-slate-400">
                                                <SafeIcon name="lock" className="w-3 h-3 text-purple-400" />
                                                <span>Your data stays private</span>
                                            </div>
                                        </div>
                                        <button
                                            onClick={connectGoogleDrive}
                                            className="w-full py-3 btn-primary rounded-xl text-sm font-semibold flex items-center justify-center gap-2"
                                        >
                                            <SafeIcon name="link" className="w-4 h-4" />
                                            Connect Google Drive
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="p-5 border-t border-white/5">
                        <button onClick={saveSettings} className="w-full py-4 btn-primary rounded-2xl font-semibold text-sm">
                            Save Settings
                        </button>
                    </div>
                </div>
            );

            const renderScan = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => { setView('home'); setCapturedImage(null); if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop()); }}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <h2 className="font-semibold text-lg">Scan Card</h2>
                        <div className="w-10"></div>
                    </header>

                    <div className="flex-1 p-5 flex flex-col items-center justify-center">
                        {/* Viewfinder */}
                        <div className="w-full max-w-md aspect-[1.586/1] rounded-2xl overflow-hidden relative shadow-2xl shadow-black/50">
                            <div className="absolute inset-0 border-2 border-white/20 rounded-2xl pointer-events-none z-10"></div>
                            {/* Corner guides */}
                            <div className="absolute top-3 left-3 w-8 h-8 border-t-2 border-l-2 border-sky-400 rounded-tl-lg z-10"></div>
                            <div className="absolute top-3 right-3 w-8 h-8 border-t-2 border-r-2 border-sky-400 rounded-tr-lg z-10"></div>
                            <div className="absolute bottom-3 left-3 w-8 h-8 border-b-2 border-l-2 border-sky-400 rounded-bl-lg z-10"></div>
                            <div className="absolute bottom-3 right-3 w-8 h-8 border-b-2 border-r-2 border-sky-400 rounded-br-lg z-10"></div>

                            {!capturedImage ? (
                                <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover bg-slate-900"></video>
                            ) : (
                                <img src={capturedImage} className="w-full h-full object-cover" />
                            )}
                        </div>

                        {/* Instructions */}
                        {!capturedImage && !isProcessing && (
                            <p className="text-slate-500 text-sm mt-4 text-center">Position business card within the frame</p>
                        )}

                        {/* Progress indicator */}
                        {isProcessing && (
                            <div className="mt-6 w-full max-w-md card-elevated rounded-2xl p-4">
                                <div className="flex items-center gap-3 mb-3">
                                    <div className="w-10 h-10 rounded-xl bg-sky-500/20 flex items-center justify-center">
                                        <div className="animate-spin h-5 w-5 border-2 border-sky-400 border-t-transparent rounded-full"></div>
                                    </div>
                                    <div className="flex-1">
                                        <p className="text-sm font-medium text-white">{statusMessage || 'Processing...'}</p>
                                        <p className="text-xs text-slate-500">Please wait</p>
                                    </div>
                                    <span className="text-sm font-semibold text-sky-400">{progress}%</span>
                                </div>
                                <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-gradient-to-r from-sky-500 to-emerald-500 transition-all duration-300" style={{ width: `${progress}%` }}></div>
                                </div>
                            </div>
                        )}

                        {/* Error display */}
                        {error && (
                            <div className="mt-6 w-full max-w-md card-elevated border-red-500/30 rounded-2xl p-4">
                                <div className="flex items-start gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center flex-shrink-0">
                                        <SafeIcon name="alert-circle" className="w-5 h-5 text-red-400" />
                                    </div>
                                    <div className="flex-1">
                                        <p className="text-sm font-medium text-red-400">Error</p>
                                        <p className="text-xs text-red-400/70 mt-1">{error}</p>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setError(null)} className="flex-1 px-4 py-2.5 text-sm bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition-colors">
                                        Dismiss
                                    </button>
                                    <button onClick={() => setView('settings')} className="flex-1 px-4 py-2.5 text-sm bg-slate-700/50 text-slate-300 rounded-xl hover:bg-slate-700/70 transition-colors">
                                        Settings
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Capture/Process buttons */}
                        <div className="mt-8">
                            {!capturedImage ? (
                                <button
                                    onClick={capture}
                                    className="w-20 h-20 bg-gradient-to-br from-sky-400 to-blue-600 rounded-full shadow-lg glow-pulse hover:scale-105 active:scale-95 transition-all flex items-center justify-center ring-4 ring-white/10"
                                >
                                    <SafeIcon name="camera" className="text-white w-8 h-8" />
                                </button>
                            ) : (
                                <div className="flex gap-4 items-center">
                                    <button
                                        onClick={() => { setCapturedImage(null); startCamera(); }}
                                        className="w-14 h-14 card-elevated rounded-full flex items-center justify-center hover:bg-white/10 transition-colors"
                                    >
                                        <SafeIcon name="refresh-cw" className="w-5 h-5 text-slate-300" />
                                    </button>
                                    <button
                                        onClick={runOCR}
                                        disabled={isProcessing}
                                        className="px-8 py-4 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl font-semibold flex items-center gap-3 disabled:opacity-50 shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 hover:scale-[1.02] active:scale-[0.98] transition-all"
                                    >
                                        {isProcessing ? (
                                            <div className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                                        ) : (
                                            <SafeIcon name="scan" className="w-5 h-5" />
                                        )}
                                        {isProcessing ? 'Processing...' : 'Process'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Engine indicator */}
                    <div className="p-4 flex justify-center">
                        <div className="flex items-center gap-2 px-3 py-2 card-elevated rounded-full text-xs text-slate-500">
                            <SafeIcon name={ocrEngine === 'google' ? 'cloud' : 'cpu'} className="w-3.5 h-3.5" />
                            <span>{ocrEngine === 'google' ? 'Google Vision' : 'Tesseract'}</span>
                            {aiValidation && (
                                <>
                                    <span className="text-slate-700">•</span>
                                    <span className="text-purple-400">AI Enhanced</span>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );

            const renderReview = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => { setView('scan'); setOcrResult(null); startCamera(); }}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <h2 className="font-semibold text-lg">Review Contact</h2>
                        <div className="w-10"></div>
                    </header>

                    <div className="p-5 space-y-5 flex-1 overflow-y-auto">
                        {/* Card Preview */}
                        {capturedImage && (
                            <div className="w-full aspect-[1.586/1] rounded-2xl overflow-hidden shadow-2xl shadow-black/50 border border-white/10">
                                <img src={capturedImage} className="w-full h-full object-cover" />
                            </div>
                        )}

                        {/* Confidence & Raw Text */}
                        <div className="card-elevated rounded-2xl p-4">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${ocrResult?.confidence > 70 ? 'bg-emerald-500/20' : 'bg-amber-500/20'}`}>
                                        <SafeIcon name={ocrResult?.confidence > 70 ? 'check-circle' : 'alert-triangle'} className={`w-5 h-5 ${ocrResult?.confidence > 70 ? 'text-emerald-400' : 'text-amber-400'}`} />
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium">OCR Confidence</p>
                                        <p className={`text-xs ${ocrResult?.confidence > 70 ? 'text-emerald-400' : 'text-amber-400'}`}>{Math.round(ocrResult?.confidence || 0)}%</p>
                                    </div>
                                </div>
                                <button
                                    onClick={() => setOcrResult(prev => ({ ...prev, showRawText: !prev.showRawText }))}
                                    className="px-3 py-1.5 text-xs bg-slate-700/50 text-slate-400 rounded-lg hover:bg-slate-700 hover:text-white transition-colors"
                                >
                                    {ocrResult?.showRawText ? 'Hide Raw' : 'View Raw'}
                                </button>
                            </div>
                            {ocrResult?.showRawText && (
                                <div className="mt-4 pt-4 border-t border-slate-800">
                                    <textarea
                                        className="w-full p-3 bg-slate-900/80 rounded-xl text-xs text-slate-300 whitespace-pre-wrap resize-none font-mono border border-slate-800 focus:border-slate-700 focus:ring-0 outline-none"
                                        rows={6}
                                        value={ocrResult.rawText || ''}
                                        onChange={(e) => setOcrResult(prev => ({ ...prev, rawText: e.target.value }))}
                                        placeholder="Edit raw OCR text..."
                                    />
                                    <button
                                        onClick={async () => {
                                            const reparsed = await parseWithValidation(ocrResult.rawText, aiValidation);
                                            setOcrResult(prev => ({
                                                ...prev,
                                                ...reparsed,
                                                rawText: prev.rawText,
                                                confidence: prev.confidence,
                                                showRawText: prev.showRawText
                                            }));
                                        }}
                                        className="mt-3 w-full px-4 py-2.5 bg-sky-500/10 text-sky-400 rounded-xl text-sm font-medium hover:bg-sky-500/20 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <SafeIcon name="refresh-cw" className="w-4 h-4" />
                                        Re-parse Text
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Editable fields */}
                        <div className="space-y-4">
                            <p className="section-label px-1">Contact Details</p>

                            {[
                                { field: 'name', icon: 'user', label: 'Full Name' },
                                { field: 'position', icon: 'briefcase', label: 'Job Title' },
                                { field: 'company', icon: 'building-2', label: 'Company' },
                                { field: 'phone', icon: 'phone', label: 'Phone' },
                                { field: 'email', icon: 'mail', label: 'Email' },
                                { field: 'address', icon: 'map-pin', label: 'Address' }
                            ].map(({ field, icon, label }) => (
                                <div key={field} className="relative">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">
                                        <SafeIcon name={icon} className="w-4 h-4 text-slate-500" />
                                    </div>
                                    <input
                                        className="w-full pl-14 pr-4 py-4 card-elevated rounded-xl text-sm focus:ring-1 focus:ring-sky-500/50 outline-none transition-all"
                                        value={ocrResult?.[field] || ''}
                                        onChange={(e) => setOcrResult(prev => ({ ...prev, [field]: e.target.value }))}
                                        placeholder={label}
                                    />
                                </div>
                            ))}

                            <div className="relative">
                                <div className="absolute left-4 top-4 w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">
                                    <SafeIcon name="sticky-note" className="w-4 h-4 text-slate-500" />
                                </div>
                                <textarea
                                    className="w-full pl-14 pr-4 py-4 card-elevated rounded-xl text-sm resize-none focus:ring-1 focus:ring-sky-500/50 outline-none transition-all"
                                    rows={2}
                                    value={ocrResult?.notes || ''}
                                    onChange={(e) => setOcrResult(prev => ({ ...prev, notes: e.target.value }))}
                                    placeholder="Notes"
                                />
                            </div>
                        </div>
                    </div>

                    <div className="p-5 border-t border-slate-800/50 bg-slate-950/80 backdrop-blur-xl">
                        <button
                            onClick={() => saveContact(ocrResult)}
                            className="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold rounded-2xl shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 hover:scale-[1.01] active:scale-[0.99] transition-all flex items-center justify-center gap-2"
                        >
                            <SafeIcon name="check" className="w-5 h-5" />
                            Save Contact
                        </button>
                    </div>
                </div>
            );

            // Ref for adding more files in upload view
            const addMoreFilesRef = useRef(null);

            const handleAddMoreFiles = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                const newItems = files.map(f => ({
                    id: Math.random().toString(36).substr(2, 9),
                    file: f,
                    preview: URL.createObjectURL(f),
                    status: 'queued'
                }));
                setBulkQueue(prev => [...prev, ...newItems]);
                e.target.value = ''; // Reset input so same files can be selected again
            };

            const renderUpload = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => { setView('home'); setBulkQueue([]); }}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <div className="text-center">
                            <h2 className="font-semibold text-lg">Upload Queue</h2>
                            <p className="text-xs text-slate-500">{bulkQueue.length} files</p>
                        </div>
                        <button
                            onClick={() => addMoreFilesRef.current?.click()}
                            className="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center hover:bg-emerald-500/20 transition-colors"
                        >
                            <SafeIcon name="plus" className="w-5 h-5 text-emerald-400" />
                        </button>
                        <input type="file" ref={addMoreFilesRef} onChange={handleAddMoreFiles} multiple accept="image/*" className="hidden" />
                    </header>

                    {/* Error display */}
                    {error && (
                        <div className="mx-5 mt-4 card-elevated border-red-500/30 rounded-2xl p-4">
                            <div className="flex items-start gap-3">
                                <div className="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center flex-shrink-0">
                                    <SafeIcon name="alert-circle" className="w-5 h-5 text-red-400" />
                                </div>
                                <div className="flex-1">
                                    <p className="text-sm font-medium text-red-400">Error</p>
                                    <p className="text-xs text-red-400/70 mt-1">{error}</p>
                                </div>
                            </div>
                            <div className="flex gap-2 mt-4">
                                <button onClick={() => setError(null)} className="flex-1 px-4 py-2.5 text-sm bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition-colors">
                                    Dismiss
                                </button>
                                <button onClick={() => setView('settings')} className="flex-1 px-4 py-2.5 text-sm bg-slate-700/50 text-slate-300 rounded-xl hover:bg-slate-700/70 transition-colors">
                                    Settings
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Status display */}
                    {isProcessing && statusMessage && (
                        <div className="mx-5 mt-4 card-elevated rounded-2xl p-4">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl bg-sky-500/20 flex items-center justify-center">
                                    <div className="animate-spin h-5 w-5 border-2 border-sky-400 border-t-transparent rounded-full"></div>
                                </div>
                                <div className="flex-1">
                                    <p className="text-sm font-medium text-white">{statusMessage}</p>
                                    <p className="text-xs text-slate-500">Please wait</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="p-5 space-y-3 flex-1 overflow-y-auto">
                        {bulkQueue.length === 0 ? (
                            <div className="text-center py-16">
                                <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-800/50 flex items-center justify-center">
                                    <SafeIcon name="image" className="w-10 h-10 text-slate-600" />
                                </div>
                                <p className="text-lg font-medium text-slate-400">No files in queue</p>
                                <p className="text-slate-600 text-sm mt-2">Add images to start processing</p>
                                <button
                                    onClick={() => addMoreFilesRef.current?.click()}
                                    className="mt-6 px-6 py-3 bg-emerald-500/10 text-emerald-400 rounded-xl text-sm font-medium hover:bg-emerald-500/20 transition-colors inline-flex items-center gap-2"
                                >
                                    <SafeIcon name="plus" className="w-4 h-4" />
                                    Add Files
                                </button>
                            </div>
                        ) : (
                            bulkQueue.map((item, idx) => (
                                <div key={item.id} className={`card-elevated rounded-2xl p-4 flex gap-4 items-center ${item.status === 'error' ? 'border-red-500/30' : ''}`}>
                                    <img src={item.preview} className="w-14 h-14 rounded-xl object-cover" />
                                    <div className="flex-1 min-w-0">
                                        <p className="text-sm font-medium text-white truncate">{item.file.name}</p>
                                        <p className={`text-xs mt-1 ${
                                            item.status === 'completed' ? 'text-emerald-400' :
                                            item.status === 'processing' ? 'text-sky-400' :
                                            item.status === 'error' ? 'text-red-400' : 'text-slate-500'
                                        }`}>
                                            {item.status === 'error' ? item.error : item.status.charAt(0).toUpperCase() + item.status.slice(1)}
                                        </p>
                                    </div>
                                    {item.status === 'completed' && (
                                        <div className="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                                            <SafeIcon name="check" className="w-4 h-4 text-emerald-400" />
                                        </div>
                                    )}
                                    {item.status === 'processing' && (
                                        <div className="w-8 h-8 rounded-lg bg-sky-500/20 flex items-center justify-center">
                                            <div className="animate-spin h-4 w-4 border-2 border-sky-400 border-t-transparent rounded-full"></div>
                                        </div>
                                    )}
                                    {item.status === 'error' && (
                                        <div className="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center">
                                            <SafeIcon name="x" className="w-4 h-4 text-red-400" />
                                        </div>
                                    )}
                                    {item.status === 'queued' && !isProcessing && (
                                        <button
                                            onClick={() => setBulkQueue(prev => prev.filter((_, i) => i !== idx))}
                                            className="w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center hover:bg-red-500/20 transition-colors group"
                                        >
                                            <SafeIcon name="trash-2" className="w-4 h-4 text-slate-500 group-hover:text-red-400 transition-colors" />
                                        </button>
                                    )}
                                </div>
                            ))
                        )}
                    </div>

                    <div className="p-5 border-t border-slate-800/50 bg-slate-950/80 backdrop-blur-xl">
                        <button
                            onClick={processBulk}
                            disabled={isProcessing || bulkQueue.length === 0}
                            className="w-full py-4 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-semibold rounded-2xl flex items-center justify-center gap-2 disabled:opacity-50 shadow-lg shadow-sky-500/20 hover:shadow-sky-500/40 hover:scale-[1.01] active:scale-[0.99] transition-all"
                        >
                            {isProcessing ? (
                                <>
                                    <div className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                                    Processing...
                                </>
                            ) : (
                                <>
                                    <SafeIcon name="play" className="w-5 h-5" />
                                    Start OCR
                                </>
                            )}
                        </button>
                    </div>
                </div>
            );

            const renderBulkReview = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => { setView('home'); setBulkResults([]); setBulkQueue([]); }}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="x" className="w-5 h-5" />
                        </button>
                        <div className="text-center">
                            <h2 className="font-semibold text-lg">Review Contacts</h2>
                            <p className="text-xs text-slate-500">{bulkResults.length} to save</p>
                        </div>
                        <div className="w-10"></div>
                    </header>

                    <div className="p-5 space-y-4 flex-1 overflow-y-auto">
                        {bulkResults.map((r, idx) => (
                            <div key={r.id} className="card-elevated rounded-2xl overflow-hidden">
                                <div className="relative">
                                    <img src={r.image} className="w-full h-28 object-cover" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                                    <div className="absolute bottom-3 left-3 right-3 flex justify-between items-end">
                                        <span className="text-xs text-white/80 truncate max-w-[60%]">{r.fileName}</span>
                                        <span className={`text-xs px-2 py-0.5 rounded-full ${r.confidence > 70 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`}>
                                            {Math.round(r.confidence)}%
                                        </span>
                                    </div>
                                </div>

                                {/* Raw Text toggle */}
                                <div className="px-4 py-2 border-b border-slate-800/50">
                                    <button
                                        onClick={() => setBulkResults(prev => prev.map((item, i) => i === idx ? { ...item, showRawText: !item.showRawText } : item))}
                                        className="text-xs text-slate-500 hover:text-white transition-colors flex items-center gap-1"
                                    >
                                        <SafeIcon name={r.showRawText ? 'chevron-up' : 'chevron-down'} className="w-3 h-3" />
                                        {r.showRawText ? 'Hide' : 'Show'} Raw Text
                                    </button>
                                    {r.showRawText && (
                                        <div className="mt-3">
                                            <textarea
                                                className="w-full p-3 bg-slate-900/80 rounded-xl text-xs text-slate-300 whitespace-pre-wrap resize-none font-mono border border-slate-800"
                                                rows={4}
                                                value={r.rawText || ''}
                                                onChange={(e) => setBulkResults(prev => prev.map((item, i) => i === idx ? { ...item, rawText: e.target.value } : item))}
                                                placeholder="Edit raw OCR text..."
                                            />
                                            <button
                                                onClick={async () => {
                                                    const reparsed = await parseWithValidation(r.rawText, aiValidation);
                                                    setBulkResults(prev => prev.map((item, i) => i === idx ? {
                                                        ...item,
                                                        ...reparsed,
                                                        rawText: item.rawText,
                                                        confidence: item.confidence,
                                                        showRawText: item.showRawText,
                                                        image: item.image,
                                                        fileName: item.fileName,
                                                        id: item.id
                                                    } : item));
                                                }}
                                                className="mt-2 w-full px-3 py-2 bg-sky-500/10 text-sky-400 rounded-xl text-xs hover:bg-sky-500/20 transition-colors flex items-center justify-center gap-1"
                                            >
                                                <SafeIcon name="refresh-cw" className="w-3 h-3" />
                                                Re-parse Text
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div className="p-4 space-y-2">
                                    {[
                                        { field: 'name', icon: 'user' },
                                        { field: 'position', icon: 'briefcase' },
                                        { field: 'company', icon: 'building-2' },
                                        { field: 'phone', icon: 'phone' },
                                        { field: 'email', icon: 'mail' }
                                    ].map(({ field, icon }) => (
                                        <div key={field} className="relative">
                                            <div className="absolute left-3 top-1/2 -translate-y-1/2 w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center">
                                                <SafeIcon name={icon} className="w-3 h-3 text-slate-500" />
                                            </div>
                                            <input
                                                className="w-full bg-slate-800/50 rounded-xl pl-11 pr-3 py-2.5 text-sm focus:ring-1 focus:ring-sky-500/50 outline-none transition-all"
                                                placeholder={field.charAt(0).toUpperCase() + field.slice(1)}
                                                value={r[field] || ''}
                                                onChange={e => setBulkResults(prev => prev.map((item, i) => i === idx ? { ...item, [field]: e.target.value } : item))}
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="p-5 border-t border-slate-800/50 bg-slate-950/80 backdrop-blur-xl">
                        <button
                            onClick={() => {
                                const newContacts = bulkResults.map(r => ({ ...r, id: Date.now() + Math.random(), createdAt: new Date().toISOString() }));
                                const updatedContacts = [...newContacts, ...contacts];
                                setContacts(updatedContacts);
                                localStorage.setItem('demo_contacts', JSON.stringify(updatedContacts));
                                setBulkResults([]);
                                setBulkQueue([]);
                                setView('contacts');
                            }}
                            className="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold rounded-2xl shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 hover:scale-[1.01] active:scale-[0.99] transition-all flex items-center justify-center gap-2"
                        >
                            <SafeIcon name="check" className="w-5 h-5" />
                            Save All ({bulkResults.length})
                        </button>
                    </div>
                </div>
            );

            // CSV Export function
            const exportToCSV = () => {
                if (contacts.length === 0) return;

                const headers = ['Name', 'Position', 'Company', 'Phone', 'Email', 'Address', 'Notes', 'Created At'];
                const csvRows = [headers.join(',')];

                contacts.forEach(c => {
                    const row = [
                        `"${(c.name || '').replace(/"/g, '""')}"`,
                        `"${(c.position || '').replace(/"/g, '""')}"`,
                        `"${(c.company || '').replace(/"/g, '""')}"`,
                        `"${(c.phone || '').replace(/"/g, '""')}"`,
                        `"${(c.email || '').replace(/"/g, '""')}"`,
                        `"${(c.address || '').replace(/"/g, '""')}"`,
                        `"${(c.notes || '').replace(/"/g, '""')}"`,
                        `"${(c.createdAt || '').replace(/"/g, '""')}"`
                    ];
                    csvRows.push(row.join(','));
                });

                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `contacts_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            // Generate vCard format for a single contact
            const generateVCard = (contact) => {
                // Parse name into parts (simple split)
                const nameParts = (contact.name || 'Unknown').split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                // Handle multiple phones (split by " / ")
                const phones = (contact.phone || '').split(' / ').filter(p => p.trim());

                // Build vCard
                let vcard = 'BEGIN:VCARD\n';
                vcard += 'VERSION:3.0\n';
                vcard += `FN:${contact.name || 'Unknown'}\n`;
                vcard += `N:${lastName};${firstName};;;\n`;

                if (contact.company) {
                    vcard += `ORG:${contact.company}\n`;
                }
                if (contact.position) {
                    vcard += `TITLE:${contact.position}\n`;
                }

                // Add all phone numbers
                phones.forEach((phone, idx) => {
                    const type = idx === 0 ? 'CELL' : 'WORK';
                    vcard += `TEL;TYPE=${type}:${phone.trim()}\n`;
                });

                if (contact.email) {
                    vcard += `EMAIL:${contact.email}\n`;
                }
                if (contact.address) {
                    // vCard address format: PO Box;Extended;Street;City;Region;Postal;Country
                    vcard += `ADR;TYPE=WORK:;;${contact.address};;;;\n`;
                }
                if (contact.notes) {
                    vcard += `NOTE:${contact.notes.replace(/\n/g, '\\n')}\n`;
                }

                vcard += 'END:VCARD\n';
                return vcard;
            };

            // Export single contact as vCard (for "Save to Phone")
            const exportSingleVCard = (contact) => {
                const vcard = generateVCard(contact);
                const blob = new Blob([vcard], { type: 'text/vcard;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                // Use contact name for filename, sanitized
                const safeName = (contact.name || 'contact').replace(/[^a-zA-Z0-9]/g, '_');
                link.download = `${safeName}.vcf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            // Export all contacts as vCard
            const exportAllVCards = () => {
                if (contacts.length === 0) return;

                // Multiple vCards can be in one file
                const vcards = contacts.map(c => generateVCard(c)).join('\n');
                const blob = new Blob([vcards], { type: 'text/vcard;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `curator_contacts_${new Date().toISOString().split('T')[0]}.vcf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            // Export menu state
            const [showExportMenu, setShowExportMenu] = useState(false);

            const renderContacts = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => setView('home')}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <div className="text-center">
                            <h2 className="font-semibold text-lg">Contacts</h2>
                            <p className="text-xs text-slate-500">{contacts.length} saved</p>
                        </div>
                        {contacts.length > 0 ? (
                            <div className="relative">
                                <button
                                    onClick={() => setShowExportMenu(!showExportMenu)}
                                    className="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center hover:bg-emerald-500/20 transition-colors"
                                >
                                    <SafeIcon name="download" className="w-5 h-5 text-emerald-400" />
                                </button>
                                {showExportMenu && (
                                    <div className="absolute right-0 top-12 card-elevated modal-enter rounded-2xl p-2 min-w-[180px] z-50 shadow-2xl border border-slate-700">
                                        <button
                                            onClick={() => { exportAllVCards(); setShowExportMenu(false); }}
                                            className="w-full text-left px-4 py-3 text-sm hover:bg-white/5 rounded-xl flex items-center gap-3 transition-colors"
                                        >
                                            <div className="w-8 h-8 rounded-lg bg-sky-500/20 flex items-center justify-center">
                                                <SafeIcon name="user-plus" className="w-4 h-4 text-sky-400" />
                                            </div>
                                            <span>Save to Phone</span>
                                        </button>
                                        <button
                                            onClick={() => { exportToCSV(); setShowExportMenu(false); }}
                                            className="w-full text-left px-4 py-3 text-sm hover:bg-white/5 rounded-xl flex items-center gap-3 transition-colors"
                                        >
                                            <div className="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                                                <SafeIcon name="table" className="w-4 h-4 text-emerald-400" />
                                            </div>
                                            <span>Export CSV</span>
                                        </button>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="w-10"></div>
                        )}
                    </header>

                    {/* Close menu when clicking outside */}
                    {showExportMenu && (
                        <div className="fixed inset-0 z-40" onClick={() => setShowExportMenu(false)}></div>
                    )}

                    <div className="p-5 space-y-3 flex-1 overflow-y-auto">
                        {contacts.length === 0 ? (
                            <div className="text-center py-16">
                                <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-800/50 flex items-center justify-center">
                                    <SafeIcon name="users" className="w-10 h-10 text-slate-600" />
                                </div>
                                <p className="text-lg font-medium text-slate-400">No contacts yet</p>
                                <p className="text-slate-600 text-sm mt-2 max-w-[200px] mx-auto">Scan or upload business cards to get started</p>
                                <button
                                    onClick={() => setView('home')}
                                    className="mt-6 px-6 py-3 bg-sky-500/10 text-sky-400 rounded-xl text-sm font-medium hover:bg-sky-500/20 transition-colors"
                                >
                                    Start Scanning
                                </button>
                            </div>
                        ) : (
                            contacts.map((c, i) => (
                                <div key={c.id || i} className="card-elevated card-stagger rounded-2xl overflow-hidden" style={{animationDelay: `${i * 0.05}s`}}>
                                    <div className="p-4 flex gap-4">
                                        <div className="h-14 w-14 bg-gradient-to-br from-sky-500 to-emerald-500 rounded-xl flex items-center justify-center font-bold text-xl flex-shrink-0 shadow-lg shadow-sky-500/20">
                                            {(c.name || '?')[0].toUpperCase()}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <h4 className="font-semibold text-white truncate">{c.name}</h4>
                                            {c.position && <p className="text-sm text-slate-400 truncate">{c.position}</p>}
                                            {c.company && (
                                                <p className="text-xs text-slate-500 truncate flex items-center gap-1 mt-1">
                                                    <SafeIcon name="building-2" className="w-3 h-3" />
                                                    {c.company}
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                    <div className="px-4 pb-4 flex gap-2">
                                        {c.phone && (
                                            <a href={`tel:${c.phone.split(' / ')[0]}`} className="flex-1 py-2.5 text-center text-xs bg-slate-800/70 rounded-xl hover:bg-slate-700 transition-colors flex items-center justify-center gap-1.5">
                                                <SafeIcon name="phone" className="w-3.5 h-3.5 text-sky-400" />
                                                <span>Call</span>
                                            </a>
                                        )}
                                        {c.email && (
                                            <a href={`mailto:${c.email}`} className="flex-1 py-2.5 text-center text-xs bg-slate-800/70 rounded-xl hover:bg-slate-700 transition-colors flex items-center justify-center gap-1.5">
                                                <SafeIcon name="mail" className="w-3.5 h-3.5 text-amber-400" />
                                                <span>Email</span>
                                            </a>
                                        )}
                                        <button
                                            onClick={() => exportSingleVCard(c)}
                                            className="flex-1 py-2.5 text-center text-xs bg-emerald-500/20 text-emerald-400 rounded-xl hover:bg-emerald-500/30 transition-colors flex items-center justify-center gap-1.5 font-medium"
                                        >
                                            <SafeIcon name="user-plus" className="w-3.5 h-3.5" />
                                            <span>Save</span>
                                        </button>
                                        <button
                                            onClick={() => {
                                                if (confirm(`Delete ${c.name || 'this contact'}?`)) {
                                                    setContacts(prev => prev.filter(contact => contact.id !== c.id));
                                                }
                                            }}
                                            className="py-2.5 px-3 text-center text-xs bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition-colors flex items-center justify-center"
                                        >
                                            <SafeIcon name="trash-2" className="w-3.5 h-3.5" />
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {contacts.length > 0 && (
                        <div className="p-5 border-t border-slate-800/50">
                            <button
                                onClick={() => {
                                    if (confirm('Delete all contacts?')) {
                                        setContacts([]);
                                        localStorage.removeItem('demo_contacts');
                                    }
                                }}
                                className="w-full py-3 bg-red-500/10 text-red-400 rounded-xl text-sm font-medium hover:bg-red-500/20 transition-colors"
                            >
                                Clear All Contacts
                            </button>
                        </div>
                    )}
                </div>
            );

            const renderManual = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => { setView('home'); setManualEntry({ name: '', position: '', company: '', phone: '', email: '', address: '', notes: '' }); }}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <h2 className="font-semibold text-lg">Add Contact</h2>
                        <div className="w-10"></div>
                    </header>

                    <div className="p-5 space-y-4 flex-1 overflow-y-auto">
                        <p className="section-label px-1">Contact Information</p>

                        {[
                            { field: 'name', icon: 'user', label: 'Full Name', type: 'text' },
                            { field: 'position', icon: 'briefcase', label: 'Job Title', type: 'text' },
                            { field: 'company', icon: 'building-2', label: 'Company', type: 'text' },
                            { field: 'phone', icon: 'phone', label: 'Phone Number', type: 'tel' },
                            { field: 'email', icon: 'mail', label: 'Email Address', type: 'email' },
                            { field: 'address', icon: 'map-pin', label: 'Address', type: 'text' }
                        ].map(({ field, icon, label, type }) => (
                            <div key={field} className="relative">
                                <div className="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">
                                    <SafeIcon name={icon} className="w-4 h-4 text-slate-500" />
                                </div>
                                <input
                                    className="w-full pl-14 pr-4 py-4 card-elevated rounded-xl text-sm focus:ring-1 focus:ring-violet-500/50 outline-none transition-all"
                                    value={manualEntry[field]}
                                    onChange={(e) => setManualEntry(prev => ({ ...prev, [field]: e.target.value }))}
                                    placeholder={label}
                                    type={type}
                                />
                            </div>
                        ))}

                        <div className="relative">
                            <div className="absolute left-4 top-4 w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">
                                <SafeIcon name="sticky-note" className="w-4 h-4 text-slate-500" />
                            </div>
                            <textarea
                                className="w-full pl-14 pr-4 py-4 card-elevated rounded-xl text-sm resize-none focus:ring-1 focus:ring-violet-500/50 outline-none transition-all"
                                rows={3}
                                value={manualEntry.notes}
                                onChange={(e) => setManualEntry(prev => ({ ...prev, notes: e.target.value }))}
                                placeholder="Notes"
                            />
                        </div>
                    </div>

                    <div className="p-5 border-t border-slate-800/50 bg-slate-950/80 backdrop-blur-xl">
                        <button
                            onClick={() => {
                                if (!manualEntry.name.trim()) {
                                    setError('Please enter at least a name');
                                    return;
                                }
                                const newContact = {
                                    ...manualEntry,
                                    id: Date.now(),
                                    createdAt: new Date().toISOString()
                                };
                                const newContacts = [newContact, ...contacts];
                                setContacts(newContacts);
                                localStorage.setItem('demo_contacts', JSON.stringify(newContacts));
                                setManualEntry({ name: '', position: '', company: '', phone: '', email: '', address: '', notes: '' });
                                setView('contacts');
                            }}
                            className="w-full py-4 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-2xl shadow-lg shadow-violet-500/20 hover:shadow-violet-500/40 hover:scale-[1.01] active:scale-[0.99] transition-all flex items-center justify-center gap-2"
                        >
                            <SafeIcon name="check" className="w-5 h-5" />
                            Save Contact
                        </button>
                    </div>
                </div>
            );

            // Main render
            if (view === 'home') return renderHome();
            if (view === 'settings') return renderSettings();
            if (view === 'scan') return renderScan();
            if (view === 'review') return renderReview();
            if (view === 'upload') return renderUpload();
            if (view === 'bulk-review') return renderBulkReview();
            if (view === 'contacts') return renderContacts();
            if (view === 'manual') return renderManual();
            return null;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('[Cura.tor] Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    console.log('[Cura.tor] New version available!');
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('[Cura.tor] Service Worker registration failed:', error);
                    });
            });
        }

        // Handle install prompt for "Add to Home Screen"
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('[Cura.tor] Install prompt available');
        });
    </script>
</body>

</html>
