<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cura.tor | Smart Contact Curation</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Scan and curate business cards with smart OCR technology">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cura.tor">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Cura.tor">
    <meta name="msapplication-TileColor" content="#020617">
    <meta name="msapplication-TileImage" content="/icons/icon-144.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-72.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-128.png">

    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <!-- Google Identity Services for OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #0a0f1a 0%, #0d1321 50%, #0a0f1a 100%);
            color: #e2e8f0;
            margin: 0;
            min-height: 100vh;
        }

        /* Premium glass effect */
        .glass {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.6) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        /* Elevated card style */
        .card-elevated {
            background: linear-gradient(145deg, rgba(20, 30, 48, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-elevated:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Gradient text variations */
        .gradient-text {
            background: linear-gradient(135deg, #ffffff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gradient-text-accent {
            background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 50%, #0284c7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .gradient-text-gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Ambient background glow */
        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse 80% 50% at 20% -10%, rgba(14, 165, 233, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 110%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse 40% 30% at 50% 50%, rgba(15, 23, 42, 0.5) 0%, transparent 70%);
            z-index: -1;
            pointer-events: none;
        }

        /* Premium button styles */
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            font-weight: 600;
            border: none;
            box-shadow: 0 4px 14px rgba(14, 165, 233, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            color: #e2e8f0;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Action card with icon */
        .action-card {
            background: linear-gradient(145deg, rgba(20, 30, 48, 0.7) 0%, rgba(15, 23, 42, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 20px;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        .action-card:hover {
            transform: translateY(-4px) scale(1.02);
            border-color: rgba(255, 255, 255, 0.12);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .action-card:active {
            transform: translateY(-2px) scale(1.01);
        }

        .action-card .icon-wrapper {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .action-card:hover .icon-wrapper {
            transform: scale(1.1);
        }

        /* Status indicator */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Smooth page transitions */
        .page-enter {
            animation: pageEnter 0.3s ease-out;
        }

        @keyframes pageEnter {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card stagger animation */
        .card-stagger {
            animation: cardSlideIn 0.4s ease-out backwards;
        }

        .card-stagger:nth-child(1) { animation-delay: 0.05s; }
        .card-stagger:nth-child(2) { animation-delay: 0.1s; }
        .card-stagger:nth-child(3) { animation-delay: 0.15s; }
        .card-stagger:nth-child(4) { animation-delay: 0.2s; }
        .card-stagger:nth-child(5) { animation-delay: 0.25s; }
        .card-stagger:nth-child(6) { animation-delay: 0.3s; }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Scale bounce animation for buttons */
        .btn-bounce {
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-bounce:active {
            transform: scale(0.95);
        }

        /* Shimmer loading effect */
        .shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Subtle float animation for icons */
        .icon-float {
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        /* Glow pulse for active elements */
        .glow-pulse {
            animation: glowPulse 2s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(14, 165, 233, 0.3); }
            50% { box-shadow: 0 0 30px rgba(14, 165, 233, 0.5); }
        }

        /* Fade scale for modals */
        .modal-enter {
            animation: modalEnter 0.25s ease-out;
        }

        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Smooth expand for collapsible sections */
        .expand-enter {
            animation: expandEnter 0.3s ease-out;
            overflow: hidden;
        }

        @keyframes expandEnter {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }

        /* Header style */
        .header-bar {
            background: linear-gradient(180deg, rgba(10, 15, 26, 0.95) 0%, rgba(10, 15, 26, 0.8) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        /* Input styles */
        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 14px 16px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: rgba(14, 165, 233, 0.5);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .input-field::placeholder {
            color: #475569;
        }

        /* Toggle switch */
        .toggle-switch {
            width: 52px;
            height: 28px;
            border-radius: 14px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .toggle-switch .toggle-knob {
            width: 22px;
            height: 22px;
            border-radius: 11px;
            background: white;
            position: absolute;
            top: 3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.5);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 0.7);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 16px;
        }

        /* Section label */
        .section-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #64748b;
        }
    </style>
</head>

<body>
    <div class="bg-glow"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Keys (hardcoded for personal use)
        const GOOGLE_VISION_API_KEY = 'AIzaSyDp5v_RuQZsNlrqJOKJ1TgAZq2n3GZ8nBg';
        const GEMINI_API_KEY = 'AIzaSyDOn66hhrMf6oBKSlgvSqzB3z_t1lQxvVw'; // Gemini-specific key
        const GOOGLE_DRIVE_CLIENT_ID = '989864367677-fcll4q385kai03cj1hkhaa852i5rdhis.apps.googleusercontent.com';

        // Smart OCR Parsing Logic
        // Precompiled regex patterns (created once, reused for all parses)
        const COMPANY_END_WORDS = ['inc', 'inc.', 'corp', 'corp.', 'corporation', 'llc', 'ltd', 'ltd.', 'co.', 'company'];
        const COMPANY_SUFFIX_END_REGEX = new RegExp(`\\b(${COMPANY_END_WORDS.map(s => s.replace('.', '\\.')).join('|')})$`, 'i');
        const COMPANY_SUFFIX_WORD_REGEX = new RegExp(`\\b(${COMPANY_END_WORDS.map(s => s.replace('.', '\\.')).join('|')})\\b`, 'i');
        const STRONG_COMPANY_SUFFIXES = ['inc', 'inc.', 'corp', 'corp.', 'corporation', 'llc', 'ltd', 'ltd.'];
        const STRONG_SUFFIX_REGEX = new RegExp(`\\b(${STRONG_COMPANY_SUFFIXES.map(s => s.replace('.', '\\.')).join('|')})\\b`, 'i');

        // Company continuation words - common second-line brand words that should be merged with company name
        const COMPANY_CONTINUATION_WORDS = ['energy', 'group', 'systems', 'solutions', 'technologies', 'technology', 'tech', 'industries', 'industrial', 'holdings', 'enterprises', 'services', 'international', 'partners', 'consulting', 'global', 'networks', 'labs', 'studio', 'studios', 'media', 'digital', 'creative', 'design', 'works', 'ventures', 'capital', 'financial', 'properties', 'realty', 'construction', 'builders', 'manufacturing', 'logistics', 'trading', 'supply', 'foods', 'pharma', 'health', 'healthcare', 'wellness', 'fitness', 'auto', 'motors', 'aviation', 'marine', 'power', 'electric', 'electronics', 'software', 'hardware', 'telecom', 'communications', 'security', 'insurance', 'bank', 'finance'];
        const COMPANY_CONTINUATION_REGEX = new RegExp(`^(${COMPANY_CONTINUATION_WORDS.join('|')})$`, 'i');

        const MERGE_ADDRESS_KW = ['street', 'st.', 'avenue', 'ave', 'road', 'rd', 'floor', 'flr', 'suite', 'unit', 'building', 'bldg', 'city', 'barangay', 'brgy'];
        const PHONE_REGEX = /^\+?\d[\d\s().-]{6,}$/;
        const HAS_LETTERS_REGEX = /[A-Za-z]/;

        // Professional suffixes pattern
        const PROFESSIONAL_SUFFIXES = ['ree', 'pee', 'rme', 'pme', 'cpa', 'cma', 'cfa', 'md', 'm\\.d\\.', 'do', 'd\\.o\\.', 'rn', 'r\\.n\\.', 'bsn', 'jd', 'j\\.d\\.', 'esq', 'esq\\.', 'atty', 'atty\\.', 'phd', 'ph\\.d\\.', 'edd', 'ed\\.d\\.', 'mba', 'm\\.b\\.a\\.', 'ms', 'm\\.s\\.', 'ma', 'm\\.a\\.', 'pe', 'p\\.e\\.', 'se', 's\\.e\\.', 'prc', 'lic\\.', 'certified'];
        const PROFESSIONAL_SUFFIX_REGEX = new RegExp(`[,\\s](${PROFESSIONAL_SUFFIXES.join('|')})$|[,\\s](${PROFESSIONAL_SUFFIXES.join('|')})[,\\s]`, 'i');

        // Title keywords pattern
        const TITLE_KEYWORDS = ['ceo', 'cto', 'cfo', 'coo', 'president', 'vice president', 'vp', 'director', 'manager', 'supervisor', 'lead', 'engineer', 'developer', 'designer', 'analyst', 'consultant', 'sales', 'marketing', 'executive', 'officer', 'associate', 'specialist', 'coordinator', 'administrator', 'assistant', 'founder', 'partner', 'owner', 'chairman', 'secretary', 'accountant', 'attorney', 'lawyer', 'doctor', 'nurse', 'representative', 'agent', 'broker', 'realtor', 'architect', 'account manager', 'project manager', 'general manager'];
        const TITLE_KEYWORD_REGEX = new RegExp(`\\b(${TITLE_KEYWORDS.join('|')})\\b`, 'i');

        // === INTERNATIONAL SUPPORT ===

        // Honorific/Professional title prefixes (goes before name)
        const HONORIFIC_TITLES = [
            // Engineering
            'engr', 'engr.', 'engineer', 'ing', 'ing.',
            // Medical
            'dr', 'dr.', 'doctor', 'md', 'm.d.', 'dds', 'd.d.s.',
            // Social
            'mr', 'mr.', 'mrs', 'mrs.', 'ms', 'ms.', 'miss',
            // Religious
            'rev', 'rev.', 'reverend', 'fr', 'fr.', 'father', 'pastor', 'bishop',
            // Academic
            'prof', 'prof.', 'professor',
            // Legal
            'atty', 'atty.', 'attorney', 'esq', 'esq.',
            // Military
            'gen', 'gen.', 'col', 'col.', 'maj', 'maj.', 'capt', 'capt.',
            // Other
            'sir', 'dame', 'lord', 'lady'
        ];
        const HONORIFIC_REGEX = new RegExp(`^(${HONORIFIC_TITLES.join('|')})\\s+`, 'i');

        // International company suffixes
        const INTERNATIONAL_COMPANY_SUFFIXES = [
            // Japanese
            '株式会社', 'かぶしきがいしゃ', 'カブシキガイシャ', // Kabushiki Kaisha (KK)
            '有限会社', 'ゆうげんがいしゃ', 'ユウゲンガイシャ', // Yugen Kaisha (YK)
            '合同会社', 'ごうどうがいしゃ', 'ゴウドウガイシャ', // Godo Kaisha (GK)
            // Chinese (Simplified & Traditional)
            '有限公司', '股份有限公司', '集团', '集團',
            // Korean
            '주식회사', '유한회사',
            // Thai
            'บริษัท', 'จำกัด',
            // Vietnamese
            'công ty', 'cổ phần',
            // Indonesian/Malay
            'pt', 'pt.', 'sdn bhd', 'sdn. bhd.',
            // Indian
            'pvt ltd', 'pvt. ltd.', 'private limited'
        ];

        // International address keywords
        const INTERNATIONAL_ADDRESS_KEYWORDS = [
            // Japanese
            '都', '道', '府', '県', // Prefecture
            '市', '区', '町', '村', // City/Ward
            '丁目', '番地', '号',  // Address numbers
            // Chinese (Simplified & Traditional)
            '省', '市', '区', '縣', '路', '街', '道', '巷', '弄', '號', '号', '楼', '樓', '层', '層',
            // Korean
            '시', '구', '동', '로', '길',
            // Thai
            'ถนน', 'ซอย', 'แขวง', 'เขต', 'จังหวัด',
            // Vietnamese
            'tỉnh', 'thành phố', 'quận', 'phường', 'đường',
            // Indonesian/Malay
            'jalan', 'jln', 'gang', 'gg', 'rt', 'rw', 'kelurahan', 'kecamatan',
            // Indian languages (transliterated)
            'nagar', 'marg', 'road', 'gali'
        ];

        const parseBusinessCard = (text) => {
            const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            let lines = normalizedText.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            // ============================================
            // PHASE 0: TABLE FORMAT DETECTION & RESTRUCTURING
            // Detect if text is in columnar/tabular format and restructure
            // ============================================

            const detectTableFormat = (lines) => {
                // Check if multiple lines have significant whitespace gaps (indicating columns)
                const tabularLines = lines.filter(line => {
                    // Split by 3+ spaces or tabs
                    const segments = line.split(/\s{3,}|\t+/);
                    // Must have 2+ segments, each non-empty
                    return segments.length >= 2 && segments.filter(s => s.trim().length > 0).length >= 2;
                });
                // If 40%+ of lines are tabular, it's likely a table format
                return tabularLines.length >= Math.max(2, lines.length * 0.4);
            };

            const restructureTableText = (lines) => {
                // Extract all columns from all lines
                const columns = [];
                lines.forEach(line => {
                    const segments = line.split(/\s{3,}|\t+/).map(s => s.trim()).filter(s => s);
                    segments.forEach((segment, colIdx) => {
                        if (!columns[colIdx]) columns[colIdx] = [];
                        columns[colIdx].push(segment);
                    });
                });
                // Flatten columns into linear text (read column by column)
                return columns.flat();
            };

            if (detectTableFormat(lines)) {
                console.log('[Parser] Table format detected, restructuring...');
                lines = restructureTableText(lines);
            }

            // ============================================
            // PHASE 1: EXTRACT (from raw text)
            // Extract emails, phones, websites FIRST
            // ============================================

            // --- Extract Emails ---
            const cleanedTextForEmail = normalizedText
                .replace(/\bI\s*([a-zA-Z][a-zA-Z0-9._+-]*)@/gi, '$1@')
                .replace(/\s+([a-zA-Z0-9._+-]+@)/g, ' $1');
            const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/gi;
            const emails = [...new Set((cleanedTextForEmail.match(emailRegex) || [])
                .filter(e => e.length > 5 && e.includes('.'))
                .sort((a, b) => {
                    const generic = ['info', 'sales', 'support', 'contact', 'admin', 'office'];
                    const aGen = generic.some(g => a.toLowerCase().startsWith(g));
                    const bGen = generic.some(g => b.toLowerCase().startsWith(g));
                    return aGen - bGen; // Personal emails first
                }))];

            // --- Extract Phones ---
            const phonePatterns = [];
            let match;

            // International: +XX followed by 7-15 digits
            const intlRegex = /(\+\d{1,3}[\s.-]*\d[\d\s.-]{6,14}\d)/gm;
            while ((match = intlRegex.exec(normalizedText)) !== null) phonePatterns.push(match[1]);

            // Labeled: "Mobile:", "Tel:", etc.
            const labeledRegex = /(?:mobile|tel|phone|fax|cell)[\s.:]*(?:no)?[\s.:]*([+\d\s()/-]{7,})/gi;
            while ((match = labeledRegex.exec(normalizedText)) !== null) phonePatterns.push(match[1]);

            // Philippine landline: +63 2 or 02
            const phLandline = /(\+?63[\s.-]?2[\s.-]?\d{4}[\s.-]?\d{4}|\(?0?2\)?[\s.-]?\d{4}[\s.-]?\d{4})/gm;
            while ((match = phLandline.exec(normalizedText)) !== null) phonePatterns.push(match[1]);

            // Philippine mobile: +63 9XX or 09XX
            const phMobile = /(\+?63[\s.-]?9\d{2}[\s.-]?\d{3}[\s.-]?\d{4}|09\d{2}[\s.-]?\d{3}[\s.-]?\d{4})/gm;
            while ((match = phMobile.exec(normalizedText)) !== null) phonePatterns.push(match[1]);

            // Generic standalone: 7-12 digits with formatting
            const genericPhone = /(?:^|[\s:])(\(?\d{2,4}\)?[\s.-]?\d{3,4}[\s.-]?\d{3,4})/gm;
            while ((match = genericPhone.exec(normalizedText)) !== null) phonePatterns.push(match[1]);

            // Clean and dedupe phones
            const phones = [...new Set(phonePatterns
                .map(p => p.replace(/[\s()-]/g, '').replace(/^[:.]/, '').trim())
                .filter(p => {
                    const digits = p.replace(/\D/g, '');
                    return digits.length >= 7 && digits.length <= 15;
                }))];

            // --- Extract Websites ---
            const websiteRegex = /(?:https?:\/\/)?(?:www\.)?[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(?:\/\S*)?/gi;
            const websites = [...new Set((normalizedText.match(websiteRegex) || [])
                .filter(w => !w.includes('@') && w.length > 4))];

            // ============================================
            // PHASE 2: MARK USED LINES
            // Mark lines that contain extracted data
            // ============================================

            const usedLines = new Set();
            const isPhoneLine = (line) => {
                const cleaned = line.replace(/[\s\-().]/g, '');
                return phones.some(p => cleaned.includes(p.slice(-7))) || /^\+?\d[\d\s().-]{7,}$/.test(cleaned);
            };

            lines.forEach((line, idx) => {
                const lower = line.toLowerCase();
                // Email line
                if (emails.some(e => lower.includes(e.toLowerCase()))) usedLines.add(idx);
                // Phone line
                if (isPhoneLine(line)) usedLines.add(idx);
                // Website line
                if (websites.some(w => lower.includes(w.toLowerCase().replace(/^www\./, '')))) usedLines.add(idx);
                // Label-only lines
                if (/^(email|e-mail|tel|telephone|mobile|phone|fax|address|website|web)[\s.:]*$/i.test(line)) usedLines.add(idx);
                // Empty/punctuation lines
                if (/^[:.\s]*$/.test(line) || line.length <= 2) usedLines.add(idx);
            });

            // ============================================
            // PHASE 3: PREPROCESS
            // Merge company and address fragments
            // ============================================

            // --- Merge Company Fragments ---
            // e.g., "JIVO" + "ENERGY" → "JIVO ENERGY"
            const processedLines = [];
            let i = 0;
            while (i < lines.length) {
                const line = lines[i];
                const lower = line.toLowerCase();
                const nextLine = lines[i + 1];
                const nextLower = nextLine?.toLowerCase();

                // Check if next line is a company continuation word
                if (nextLine && COMPANY_CONTINUATION_REGEX.test(nextLine.trim())) {
                    const isAllCaps = line === line.toUpperCase() && /[A-Z]/.test(line);
                    const isShort = line.length <= 25;
                    const notPerson = !/^[A-Z][a-z]+\s+[A-Z][a-z]+$/.test(line); // Not "John Smith"
                    if ((isAllCaps || isShort) && notPerson && !line.includes('@')) {
                        processedLines.push(`${line} ${nextLine}`.trim());
                        // Transfer usedLines status
                        if (usedLines.has(i) || usedLines.has(i + 1)) {
                            usedLines.add(processedLines.length - 1);
                        }
                        i += 2;
                        continue;
                    }
                }

                // Check if this line + next forms a company (e.g., "BUILDERS," + "INC.")
                if (nextLine && COMPANY_END_WORDS.some(s => nextLower === s || nextLower === s.replace('.', ''))) {
                    processedLines.push(`${line} ${nextLine}`.replace(/\s+/g, ' ').trim());
                    i += 2;
                    continue;
                }

                processedLines.push(line);
                i++;
            }
            lines = processedLines;

            // Rebuild usedLines for new indices
            const newUsedLines = new Set();
            lines.forEach((line, idx) => {
                const lower = line.toLowerCase();
                if (emails.some(e => lower.includes(e.toLowerCase()))) newUsedLines.add(idx);
                if (isPhoneLine(line)) newUsedLines.add(idx);
                if (websites.some(w => lower.includes(w.toLowerCase().replace(/^www\./, '')))) newUsedLines.add(idx);
                if (/^(email|e-mail|tel|telephone|mobile|phone|fax|address|website|web)[\s.:]*$/i.test(line)) newUsedLines.add(idx);
                if (/^[:.\s]*$/.test(line) || line.length <= 2) newUsedLines.add(idx);
            });

            // ============================================
            // PHASE 4: CATEGORIZE (single pass)
            // Name → Position → Company → Address
            // ============================================

            const result = {
                name: null,
                position: null,
                company: null,
                address: null,
                phone: phones.length > 1 ? phones.join(' / ') : phones[0] || '',
                phones: phones,
                email: emails[0] || '',
                website: websites[0] || '',
                notes: '',
                rawText: text
            };

            // --- Helper Functions ---
            const hasAddressWord = (text) => {
                const lower = text.toLowerCase();
                const addressWords = [
                    // English
                    'floor', 'flr', 'building', 'bldg', 'tower', 'unit', 'suite', 'room', 'street', 'st.', 'avenue', 'ave', 'road', 'rd', 'city', 'district', 'province', 'barangay', 'brgy', 'manila', 'makati', 'quezon', 'cebu', 'davao', 'china', 'philippines', 'singapore', 'park', 'compound', 'block', 'blk', 'lot', 'phase'
                ];
                if (addressWords.some(w => lower.includes(w))) return true;
                if (/\b(st|rd|ave|blvd|flr|rm|no)\b\.?/i.test(text)) return true;

                // Check for international address keywords (CJK and others)
                if (INTERNATIONAL_ADDRESS_KEYWORDS.some(keyword => text.includes(keyword))) return true;

                return false;
            };

            const looksLikePhone = (line) => /^\+?\d[\d\s().-]{7,}$/.test(line.replace(/\s+/g, ''));

            const looksLikePersonName = (line) => {
                const words = line.split(/\s+/).filter(w => w.length > 0);

                // Check for professional title prefix (Engr., Dr., Mr., etc.)
                const firstWord = words[0] || '';
                const hasHonorific = HONORIFIC_TITLES.some(title =>
                    firstWord.toLowerCase().replace(/\./g, '') === title.replace(/\./g, '')
                );

                // If has honorific, be more flexible (2-6 words OK)
                if (hasHonorific) {
                    if (words.length < 2 || words.length > 6) return false;
                    // Don't check strict character patterns if has honorific
                    if (line.includes('@') || /\d{4}/.test(line)) return false;
                    return true;
                }

                // Standard name detection (no title)
                if (words.length < 2 || words.length > 4) return false;
                if (line.includes('@') || /\d{3}/.test(line)) return false;
                if (STRONG_SUFFIX_REGEX.test(line.toLowerCase())) return false;

                // Accept Unicode letters (not just A-Z) for international names
                return words.every(w => /^[\p{L}'.,-]+$/u.test(w) || /^[A-Za-z'.,-]+$/.test(w));
            };

            const looksLikeCompany = (line) => {
                const lower = line.toLowerCase();
                // Has English company suffix (Inc, Corp, LLC, Ltd, etc.)
                if (COMPANY_SUFFIX_WORD_REGEX.test(lower)) return true;
                // Is a continuation word alone (Energy, Solutions, etc.)
                if (COMPANY_CONTINUATION_REGEX.test(line.trim())) return true;
                // Has business words (Manufacturing, Company, Limited, etc.)
                if (/\b(manufacturing|company|limited|private|pvt|ltd|inc|corp|llc|enterprises|industries|international)\b/i.test(line)) return true;

                // Check for international company suffixes (CJK and others)
                if (INTERNATIONAL_COMPANY_SUFFIXES.some(suffix => line.includes(suffix))) return true;

                // Long ALL CAPS with business context (5+ words)
                const words = line.split(/\s+/);
                if (line === line.toUpperCase() && words.length >= 5 && /[A-Z]/.test(line)) return true;
                return false;
            };

            // --- Find Position First (helps find name) ---
            let positionIdx = -1;
            lines.forEach((line, idx) => {
                if (newUsedLines.has(idx) || result.position) return;
                const lower = line.toLowerCase();

                if (!TITLE_KEYWORD_REGEX.test(lower)) return;
                if (STRONG_SUFFIX_REGEX.test(lower)) return;
                if (hasAddressWord(line)) return;

                // Score position candidates
                let score = 10;
                if (line.length < 40) score += 10;
                if (line !== line.toUpperCase()) score += 10; // Not ALL CAPS
                if (/manager|director|officer|engineer|specialist|consultant/i.test(line)) score += 20;

                if (score > 20) {
                    result.position = line;
                    positionIdx = idx;
                    newUsedLines.add(idx);
                }
            });

            // --- Find Name (line before position, or best candidate) ---
            if (positionIdx > 0) {
                for (let idx = positionIdx - 1; idx >= 0; idx--) {
                    if (newUsedLines.has(idx)) continue;
                    const line = lines[idx];
                    if (looksLikePersonName(line) && !looksLikeCompany(line)) {
                        result.name = line;
                        newUsedLines.add(idx);
                        break;
                    }
                }
            }

            // Fallback: find best name candidate
            if (!result.name) {
                let bestName = null;
                let bestScore = 0;

                lines.forEach((line, idx) => {
                    if (newUsedLines.has(idx)) return;
                    if (!looksLikePersonName(line)) return;
                    if (looksLikeCompany(line)) return;

                    let score = 10;
                    const words = line.split(/\s+/);

                    // Title Case bonus (strong signal)
                    if (words.every(w => /^[A-Z][a-z]+$/.test(w))) score += 50;
                    // 2-3 words bonus (typical name length)
                    if (words.length <= 3) score += 20;
                    // First/second line bonus (names usually at top)
                    if (idx === 0) score += 30;
                    if (idx === 1) score += 20;
                    // ALL CAPS small penalty (less than Title Case bonus)
                    if (line === line.toUpperCase() && words.length <= 3) score -= 10;

                    if (score > bestScore) {
                        bestScore = score;
                        bestName = { line, idx };
                    }
                });

                if (bestName) {
                    result.name = bestName.line;
                    newUsedLines.add(bestName.idx);
                }
            }

            // --- Find Company ---
            let bestCompany = null;
            let bestCompanyScore = 0;

            lines.forEach((line, idx) => {
                if (newUsedLines.has(idx)) return;
                const lower = line.toLowerCase();

                // Check if line looks like a company
                const hasSuffix = COMPANY_SUFFIX_WORD_REGEX.test(lower);
                const hasContinuationWord = COMPANY_CONTINUATION_WORDS.some(w => lower.includes(w));
                const hasBusinessWord = /\b(manufacturing|company|limited|private|pvt|enterprises|industries|international|solutions|systems|technologies|group)\b/i.test(line);

                if (!hasSuffix && !hasContinuationWord && !hasBusinessWord) return;

                let score = line.length;
                // Strong company indicators
                if (['inc', 'corp', 'llc', 'ltd', 'limited', 'private'].some(s => lower.includes(s))) score += 100;
                // Continuation words (Energy, Group, Systems, etc.)
                if (hasContinuationWord) score += 50;
                // ALL CAPS companies
                if (line === line.toUpperCase() && /[A-Z]/.test(line)) score += 30;
                // Longer companies more likely
                if (line.length > 20) score += 20;

                // Penalty for 2-word Title Case names (might be person)
                const words = line.split(/\s+/);
                if (words.length === 2 && words.every(w => /^[A-Z][a-z]+$/.test(w))) score -= 50;

                if (score > bestCompanyScore) {
                    bestCompanyScore = score;
                    bestCompany = { line, idx };
                }
            });

            if (bestCompany && bestCompanyScore > 0) {
                result.company = bestCompany.line;
                newUsedLines.add(bestCompany.idx);
            }

            // --- Find Address ---
            const addressParts = [];
            lines.forEach((line, idx) => {
                if (newUsedLines.has(idx)) return;
                if (looksLikePhone(line)) return;
                if (looksLikeCompany(line) && !hasAddressWord(line)) return;

                if (hasAddressWord(line) || /^#?\d+\s/.test(line) || /\bno\.?\s*\d/i.test(line)) {
                    let cleaned = line.replace(/^(add|address|addr)[\s.:]+/i, '').trim();
                    addressParts.push(cleaned);
                    newUsedLines.add(idx);
                }
            });

            if (addressParts.length > 0) {
                result.address = addressParts.join(', ').replace(/,\s*,/g, ',').replace(/\s+/g, ' ').trim();
            }

            // ============================================
            // PHASE 5: CLEANUP
            // Fix OCR artifacts
            // ============================================

            // Clean name
            if (result.name) {
                // Remove Chinese characters if mixed with English
                if (/[\u4e00-\u9fff]/.test(result.name) && /[A-Za-z]{2,}/.test(result.name)) {
                    const english = result.name.replace(/[\u4e00-\u9fff]+/g, '').trim();
                    if (english.length > 3) result.name = english;
                }
            } else {
                result.name = 'Unknown';
            }

            // Clean position
            if (result.position) {
                result.position = result.position
                    .replace(/^[A-Z]\s+(?=[A-Z])/i, '') // Remove single-letter prefix
                    .replace(/[\u4e00-\u9fff]+\s*/g, '') // Remove Chinese
                    .trim();
            }

            return result;
        };

        // Validate/correct parsing with Gemini AI (with vision)
        const validateWithGemini = async (imageData, rawText, parsed) => {
            console.log('[Gemini Vision] Starting validation with image...');
            console.log('[Gemini Vision] Image data length:', imageData?.length || 0);
            console.log('[Gemini Vision] Parsed data:', parsed);
            try {
                const prompt = `You are an expert multilingual business card data curator with VISION capability. Extract contact information directly from this image to 99% accuracy for ANY language and country.

CONTEXT - OCR extracted this text (may have errors):
${rawText}

CONTEXT - Basic parser found (may be incorrect):
Name: ${parsed.name}
Position: ${parsed.position}
Company: ${parsed.company}
Phone: ${parsed.phone}
Email: ${parsed.email}
Address: ${parsed.address}

YOUR TASK: Look at the IMAGE and extract the CORRECT data with 99% accuracy by:

1. **CRITICAL - Fix name with flexibility**:
   - Fix capitalization appropriately for the language
   - KEEP professional titles: "ENGR. JOHN DOE" → "Engr. John Doe"
   - Support all formats: "Dr. Maria Santos, MD", "李明", "สมชาย", "Müller"
   - ANY length OK: 1-6+ words accepted
   - If name has title prefix (Engr., Dr., Mr., Prof., Atty., Rev.), KEEP IT

2. **CRITICAL - Name vs Company (be intelligent)**:
   - Person names can have: titles, suffixes, any language, any case
   - Companies have: business suffixes (Inc, LLC, 株式会社, 有限公司, บริษัท) OR business words
   - If unsure, prefer keeping original parsing

3. **Fix company name (multilingual)**:
   - Merge fragments: "Google" + "LLC" → "Google LLC"
   - Support: English (Inc, Corp), Japanese (株式会社), Chinese (有限公司), Thai (บริษัท), etc.
   - Proper formatting for the language

4. **CRITICAL - Address from ANY country (be thorough)**:
   - Merge ALL address lines into ONE complete string
   - Support: Japanese (東京都...), Chinese (北京市...), Thai (ถนน...), ALL languages
   - Remove prefixes: "Add:", "Address:", "住所:"
   - Include: ALL parts (street, building, floor, district, city, province, country, postal)
   - NO length limits - addresses can be 200+ characters!

5. **Handle ANY label format**: "Contact:", "Tel:", "Mobile:", "HP:", "连络:", etc. all mean phone

6. **Clean OCR artifacts**: Fix spacing, remove weird chars, keep real content

7. **Standardize phone**: Keep country code (+81, +66, +86, +63, etc.), format consistently

8. **Work with tables/lists**: If data is in table or list format (Name: Earl, Contact: 09...), extract correctly

EXAMPLES of correct name handling:
- "ENGR. JOHN DOE" → "Engr. John Doe" (keep title!)
- "DR. MARIA SANTOS, MD" → "Dr. Maria Santos, MD"  (keep title and suffix!)
- "MR. & MRS. SMITH" → "Mr. & Mrs. Smith"
- "李明" → "李明" (keep non-Latin as-is)
- "JOSÉ GARCÍA" → "José García" (preserve accents)

Return ONLY valid JSON (no markdown, no code blocks):
{
  "name": "Person Name (with title if present)",
  "position": "Job Title",
  "company": "Company Name with Suffix",
  "phone": "+XX formatted phone",
  "email": "email@domain.com",
  "address": "Complete Full Address, All Parts, City, Country"
}

IMPORTANT: Be flexible! Names with titles are valid. Long addresses are valid. Non-Latin text is valid.`;

                // Remove data URL prefix if present
                const base64Image = imageData.replace(/^data:image\/\w+;base64,/, '');

                // Call Gemini directly with vision
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inline_data: {
                                        mime_type: 'image/jpeg',
                                        data: base64Image
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 500
                        }
                    })
                });

                const data = await response.json();
                console.log('[Gemini Vision] API response received:', data);

                if (!response.ok || data.error) {
                    console.error('[Gemini Vision] API error:', data.error || response.statusText);
                    return { ...parsed, _aiValidated: false, _aiError: data.error?.message || `API error: ${response.status}` };
                }

                // Safe navigation with null checks (endpoint returns Gemini's response format)
                const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                console.log('[Gemini Vision] Extracted text from response:', text);

                if (!text) {
                    console.warn('[Gemini Vision] Empty or malformed response, using original parsing');
                    return { ...parsed, _aiValidated: false, _aiError: 'Empty response from AI' };
                }

                // Extract JSON from response (handle markdown code blocks)
                let jsonText = text.trim();
                if (jsonText.startsWith('```')) {
                    jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                }

                console.log('[Gemini Vision] Cleaned JSON text:', jsonText);
                const corrected = JSON.parse(jsonText);
                console.log('[Gemini Vision] Parsed JSON:', corrected);

                // VALIDATION: Only reject clearly garbage AI responses (simplified - trust AI more!)
                const isGarbage = (str) => {
                    if (!str || str.length < 2) return true;
                    if (/^(unknown|n\/a|none|null|undefined)$/i.test(str.trim())) return true;
                    // Removed 150-char limit - international addresses can be long!
                    return false;
                };

                // Helper: Check if AI name is better than parsed name (simplified!)
                const isAINameBetter = (aiName, parsedName) => {
                    if (isGarbage(aiName)) return false;
                    if (!parsedName || parsedName === 'Unknown') return true;
                    // Removed strict Title Case check - accept titles, all caps, non-Latin, etc.
                    // Prefer AI if parsed name contains company words
                    if (/\b(inc|corp|llc|ltd|system|solar|trading|industrial)\b/i.test(parsedName)) return true;
                    return true; // Default: trust AI
                };

                // Helper: Check if AI company is better (simplified!)
                const isAICompanyBetter = (aiCompany, parsedCompany) => {
                    if (isGarbage(aiCompany)) return false;
                    if (!parsedCompany) return true;
                    // Simplified: trust AI unless it's obvious garbage
                    return true;
                };

                // Helper: Check if AI address is better (simplified!)
                const isAIAddressBetter = (aiAddress, parsedAddress) => {
                    if (isGarbage(aiAddress)) return false;
                    if (!parsedAddress) return true;
                    // Trust AI - removed length restrictions
                    // Prefer AI if parsed address is a tagline
                    if (/quality|products|services|solutions/i.test(parsedAddress)) return true;
                    return true; // Default: trust AI
                };

                // Select best values - TRUST AI MORE
                const bestName = isAINameBetter(corrected.name, parsed.name) ? corrected.name : parsed.name;
                const bestCompany = isAICompanyBetter(corrected.company, parsed.company) ? corrected.company : parsed.company;
                const bestPosition = corrected.position || parsed.position;
                const bestAddress = isAIAddressBetter(corrected.address, parsed.address) ? corrected.address : parsed.address;

                const finalResult = {
                    ...parsed,
                    name: bestName,
                    position: bestPosition,
                    company: bestCompany,
                    phone: corrected.phone || parsed.phone,
                    email: corrected.email || parsed.email,
                    address: bestAddress,
                    _aiValidated: true
                };

                console.log('[Gemini Vision] ✓ Final validated result:', finalResult);
                return finalResult;

            } catch (error) {
                console.error('[Gemini Vision] ✗ Validation error:', error);
                return { ...parsed, _aiValidated: false, _aiError: error.message };
            }
        };

        // Parse with optional AI validation
        const parseWithValidation = async (text, imageData = null, useAI = true) => {
            const parsed = parseBusinessCard(text);

            if (!useAI) {
                return { ...parsed, _aiValidated: false, _aiError: 'AI disabled' };
            }

            if (!imageData) {
                console.warn('[Validation] No image data provided, skipping AI validation');
                return { ...parsed, _aiValidated: false, _aiError: 'No image data' };
            }

            // Enhance with AI for 99% accuracy (with vision!)
            // Uses Gemini 1.5 Flash (free tier: 1,500 requests/day)
            return await validateWithGemini(imageData, text, parsed);
        };

        // Google Vision OCR
        const googleVisionOCR = async (imageSrc, apiKey) => {
            console.log('[Google Vision] Starting OCR...');
            const base64Image = imageSrc.replace(/^data:image\/\w+;base64,/, '');

            const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    requests: [{
                        image: { content: base64Image },
                        features: [{ type: 'TEXT_DETECTION' }]
                    }]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API error: ${response.status}`);
            }

            const data = await response.json();
            console.log('[Google Vision] Response received');

            if (data.responses[0]?.error) {
                throw new Error(data.responses[0].error.message);
            }

            const text = data.responses[0]?.fullTextAnnotation?.text || '';
            return { text, confidence: text ? 90 : 0 };
        };

        // Convert blob URL or File to base64 data URL
        const toBase64 = async (input) => {
            // If it's already a data URL, return as-is
            if (typeof input === 'string' && input.startsWith('data:')) {
                return input;
            }

            // If it's a blob URL, fetch and convert
            if (typeof input === 'string' && input.startsWith('blob:')) {
                const response = await fetch(input);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            // If it's a File or Blob object
            if (input instanceof Blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(input);
                });
            }

            return input;
        };

        // Preprocess image for better OCR (grayscale, contrast, threshold)
        const preprocessImage = async (imageSrc) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Use larger canvas for better quality
                    const scale = Math.max(1, 1500 / Math.max(img.width, img.height));
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;

                    // Draw original image
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // Convert to grayscale and increase contrast
                    for (let i = 0; i < data.length; i += 4) {
                        // Grayscale
                        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];

                        // Increase contrast
                        const contrast = 1.5;
                        const factor = (259 * (contrast * 100 + 255)) / (255 * (259 - contrast * 100));
                        let newGray = factor * (gray - 128) + 128;

                        // Clamp values
                        newGray = Math.max(0, Math.min(255, newGray));

                        // Apply threshold for cleaner text (binarization)
                        const threshold = 140;
                        const finalValue = newGray > threshold ? 255 : 0;

                        data[i] = finalValue;     // R
                        data[i + 1] = finalValue; // G
                        data[i + 2] = finalValue; // B
                        // Alpha stays the same
                    }

                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = () => resolve(imageSrc); // Fallback to original
                img.src = imageSrc;
            });
        };

        // Tesseract OCR with preprocessing
        const tesseractOCR = async (imageSrc, onProgress) => {
            // Preprocess image for better recognition
            if (onProgress) onProgress('Preprocessing image...', 10);
            const processedImage = await preprocessImage(imageSrc);

            const worker = await Tesseract.createWorker('eng', 1, {
                logger: m => {
                    if (onProgress && m.progress) onProgress(m.status, Math.round(m.progress * 100));
                }
            });

            const result = await worker.recognize(processedImage);
            await worker.terminate();

            return { text: result.data.text, confidence: result.data.confidence };
        };

        const App = () => {
            // Core state
            const [view, setView] = useState('home');
            const [contacts, setContacts] = useState([]);
            const [capturedImage, setCapturedImage] = useState(null);
            const [ocrResult, setOcrResult] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);

            // Settings state
            // API keys are defined globally (see top of file)
            const googleApiKey = GOOGLE_VISION_API_KEY;
            const [ocrEngine, setOcrEngine] = useState(localStorage.getItem('ocr_engine') || 'tesseract');
            const [aiValidation, setAiValidation] = useState(localStorage.getItem('ai_validation') !== 'false'); // Default ON

            // Google Drive sync state
            const driveClientId = GOOGLE_DRIVE_CLIENT_ID;
            const [driveConnected, setDriveConnected] = useState(false);
            const [driveUser, setDriveUser] = useState(null);
            const [driveSyncing, setDriveSyncing] = useState(false);
            const [driveFileId, setDriveFileId] = useState(localStorage.getItem('drive_file_id') || null);
            const [lastSyncTime, setLastSyncTime] = useState(localStorage.getItem('last_sync_time') || null);

            // Bulk upload state
            const [bulkQueue, setBulkQueue] = useState([]);
            const [bulkResults, setBulkResults] = useState([]);

            // Manual entry state
            const [manualEntry, setManualEntry] = useState({
                name: '', position: '', company: '', phone: '', email: '', address: '', notes: '', folder: 'Uncategorized'
            });

            // Error and status state
            const [error, setError] = useState(null);
            const [statusMessage, setStatusMessage] = useState('');
            const [progress, setProgress] = useState(0);

            // Refs
            const videoRef = useRef(null);
            const fileInputRef = useRef(null);

            // Load contacts from localStorage
            useEffect(() => {
                const saved = localStorage.getItem('demo_contacts');
                if (saved) setContacts(JSON.parse(saved));
            }, []);

            // Google Drive API Configuration
            const DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
            const DRIVE_FILE_NAME = 'curator-contacts.json';

            // Initialize Google API client
            const initGoogleDrive = async () => {
                if (!driveClientId) return false;

                return new Promise((resolve) => {
                    if (window.gapi) {
                        window.gapi.load('client', async () => {
                            try {
                                await window.gapi.client.init({
                                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                                });
                                console.log('[Drive] Google API client initialized');
                                resolve(true);
                            } catch (err) {
                                console.error('[Drive] Init error:', err);
                                resolve(false);
                            }
                        });
                    } else {
                        resolve(false);
                    }
                });
            };

            // Google Sign-In
            const connectGoogleDrive = async () => {
                if (!driveClientId) {
                    setError('Please enter your Google Client ID first');
                    return;
                }

                try {
                    await initGoogleDrive();

                    const tokenClient = window.google.accounts.oauth2.initTokenClient({
                        client_id: driveClientId,
                        scope: DRIVE_SCOPES,
                        callback: async (response) => {
                            if (response.access_token) {
                                window.gapi.client.setToken({ access_token: response.access_token });
                                setDriveConnected(true);

                                // Get user info
                                try {
                                    const userInfo = await window.gapi.client.request({
                                        path: 'https://www.googleapis.com/oauth2/v2/userinfo'
                                    });
                                    setDriveUser(userInfo.result);
                                    console.log('[Drive] Connected as:', userInfo.result.email);
                                } catch (e) {
                                    console.log('[Drive] Could not get user info');
                                }

                                // Load contacts from Drive
                                await loadFromDrive();
                            }
                        },
                        error_callback: (err) => {
                            console.error('[Drive] Auth error:', err);
                            setError('Google sign-in failed: ' + (err.message || 'Unknown error'));
                        }
                    });

                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } catch (err) {
                    console.error('[Drive] Connect error:', err);
                    setError('Failed to connect: ' + err.message);
                }
            };

            // Disconnect Google Drive
            const disconnectGoogleDrive = () => {
                if (window.google && window.google.accounts) {
                    window.google.accounts.oauth2.revoke(window.gapi.client.getToken()?.access_token, () => {
                        console.log('[Drive] Token revoked');
                    });
                }
                window.gapi?.client?.setToken(null);
                setDriveConnected(false);
                setDriveUser(null);
                setDriveFileId(null);
                localStorage.removeItem('drive_file_id');
                localStorage.removeItem('last_sync_time');
                setLastSyncTime(null);
            };

            // Find or create the contacts file in Drive
            const findOrCreateDriveFile = async () => {
                try {
                    // Search for existing file in appDataFolder
                    const searchResponse = await window.gapi.client.drive.files.list({
                        spaces: 'appDataFolder',
                        q: `name='${DRIVE_FILE_NAME}'`,
                        fields: 'files(id, name, modifiedTime)'
                    });

                    const files = searchResponse.result.files;

                    if (files && files.length > 0) {
                        console.log('[Drive] Found existing file:', files[0].id);
                        return files[0].id;
                    }

                    // Create new file
                    const createResponse = await window.gapi.client.drive.files.create({
                        resource: {
                            name: DRIVE_FILE_NAME,
                            parents: ['appDataFolder'],
                            mimeType: 'application/json'
                        },
                        fields: 'id'
                    });

                    console.log('[Drive] Created new file:', createResponse.result.id);
                    return createResponse.result.id;
                } catch (err) {
                    console.error('[Drive] File operation error:', err);
                    throw err;
                }
            };

            // Save contacts to Google Drive
            const saveToDrive = async (contactsToSave) => {
                if (!driveConnected) return;

                setDriveSyncing(true);
                try {
                    const fileId = driveFileId || await findOrCreateDriveFile();

                    if (!driveFileId) {
                        setDriveFileId(fileId);
                        localStorage.setItem('drive_file_id', fileId);
                    }

                    // Update file content
                    const content = JSON.stringify({
                        version: 1,
                        contacts: contactsToSave,
                        lastModified: new Date().toISOString()
                    });

                    await window.gapi.client.request({
                        path: `/upload/drive/v3/files/${fileId}`,
                        method: 'PATCH',
                        params: { uploadType: 'media' },
                        headers: { 'Content-Type': 'application/json' },
                        body: content
                    });

                    const syncTime = new Date().toISOString();
                    setLastSyncTime(syncTime);
                    localStorage.setItem('last_sync_time', syncTime);
                    console.log('[Drive] Saved to Drive');
                } catch (err) {
                    console.error('[Drive] Save error:', err);
                    // Don't show error to user for background syncs
                } finally {
                    setDriveSyncing(false);
                }
            };

            // Load contacts from Google Drive
            const loadFromDrive = async () => {
                if (!driveConnected && !window.gapi?.client?.getToken()) return;

                setDriveSyncing(true);
                try {
                    const fileId = driveFileId || await findOrCreateDriveFile();

                    if (!driveFileId) {
                        setDriveFileId(fileId);
                        localStorage.setItem('drive_file_id', fileId);
                    }

                    // Get file content
                    const response = await window.gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });

                    if (response.result && response.result.contacts) {
                        const driveContacts = response.result.contacts;
                        console.log('[Drive] Loaded', driveContacts.length, 'contacts from Drive');

                        // Merge: Drive contacts take priority, but keep local-only contacts
                        const localContacts = JSON.parse(localStorage.getItem('demo_contacts') || '[]');
                        const driveIds = new Set(driveContacts.map(c => c.id));
                        const localOnly = localContacts.filter(c => !driveIds.has(c.id));

                        const merged = [...driveContacts, ...localOnly];
                        setContacts(merged);
                        localStorage.setItem('demo_contacts', JSON.stringify(merged));

                        // Save merged back to Drive if there were local-only contacts
                        if (localOnly.length > 0) {
                            await saveToDrive(merged);
                        }

                        const syncTime = new Date().toISOString();
                        setLastSyncTime(syncTime);
                        localStorage.setItem('last_sync_time', syncTime);
                    }
                } catch (err) {
                    console.error('[Drive] Load error:', err);
                    // File might be empty or not exist yet, that's OK
                } finally {
                    setDriveSyncing(false);
                }
            };

            // Auto-sync when contacts change
            useEffect(() => {
                if (driveConnected && contacts.length > 0) {
                    // Debounce: wait 2 seconds after last change before syncing
                    const timer = setTimeout(() => {
                        saveToDrive(contacts);
                    }, 2000);
                    return () => clearTimeout(timer);
                }
            }, [contacts, driveConnected]);

            // Save contacts to localStorage (always) when they change
            useEffect(() => {
                if (contacts.length > 0) {
                    localStorage.setItem('demo_contacts', JSON.stringify(contacts));
                }
            }, [contacts]);

            // Icon component
            const SafeIcon = ({ name, className = "" }) => {
                const iconRef = useRef(null);
                useEffect(() => {
                    if (iconRef.current && window.lucide) {
                        iconRef.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`;
                        window.lucide.createIcons({ targets: [iconRef.current.firstChild] });
                    }
                }, [name, className]);
                return <span ref={iconRef} style={{ display: 'inline-flex' }}></span>;
            };

            // Camera functions
            const startCamera = async () => {
                setCapturedImage(null);
                setError(null);
                setView('scan');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (e) {
                    setError("Camera access denied. Please allow camera permissions.");
                    setView('home');
                }
            };

            const capture = () => {
                if (!videoRef.current) return;
                const canvas = document.createElement('canvas');
                canvas.width = videoRef.current.videoWidth || 640;
                canvas.height = videoRef.current.videoHeight || 480;
                const ctx = canvas.getContext('2d');
                if (ctx) ctx.drawImage(videoRef.current, 0, 0);
                setCapturedImage(canvas.toDataURL('image/jpeg'));
                // Safely stop video tracks
                if (videoRef.current.srcObject) {
                    videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                }
            };

            // OCR function
            const runOCR = async () => {
                setError(null);
                setStatusMessage('');
                setProgress(0);

                // Validate settings
                if (ocrEngine === 'google' && !googleApiKey) {
                    setError('Google Vision API key not configured. Go to Settings to add your API key, or switch to Tesseract (local) OCR.');
                    return;
                }

                setIsProcessing(true);

                try {
                    let result;

                    if (ocrEngine === 'google') {
                        setStatusMessage('Sending to Google Cloud Vision...');
                        setProgress(50);
                        result = await googleVisionOCR(capturedImage, googleApiKey);
                    } else {
                        setStatusMessage('Loading Tesseract engine...');
                        result = await tesseractOCR(capturedImage, (status, prog) => {
                            setStatusMessage(status);
                            setProgress(prog);
                        });
                    }

                    setProgress(90);
                    setStatusMessage('Parsing results with AI...');

                    const parsed = await parseWithValidation(result.text, capturedImage, aiValidation);
                    setOcrResult({
                        ...parsed,
                        rawText: result.text,
                        confidence: result.confidence,
                        showRawText: false
                    });

                    setProgress(100);
                    setStatusMessage('Complete!');
                    setView('review');
                } catch (e) {
                    console.error('[OCR Error]', e);
                    setError(`OCR Failed: ${e.message}`);
                } finally {
                    setIsProcessing(false);
                }
            };

            // Save contact
            const saveContact = (contact) => {
                const newContacts = [{
                    ...contact,
                    id: Date.now(),
                    createdAt: new Date().toISOString(),
                    folder: contact.folder || 'Uncategorized'
                }, ...contacts];
                setContacts(newContacts);
                localStorage.setItem('demo_contacts', JSON.stringify(newContacts));
                setOcrResult(null);
                setCapturedImage(null);
                setView('contacts');
            };

            // File upload
            const handleFileUpload = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                setBulkQueue(files.map(f => ({
                    id: Math.random().toString(36).substr(2, 9),
                    file: f,
                    preview: URL.createObjectURL(f),
                    status: 'queued'
                })));
                setError(null);
                setView('upload');
            };

            // Bulk processing
            const processBulk = async () => {
                setError(null);

                if (ocrEngine === 'google' && !googleApiKey) {
                    setError('Google Vision API key not configured. Go to Settings to add your API key, or switch to Tesseract (local) OCR.');
                    return;
                }

                setIsProcessing(true);
                setStatusMessage('Starting batch processing...');
                const results = [];

                try {
                    let worker = null;

                    // Create Tesseract worker once for batch
                    if (ocrEngine === 'tesseract') {
                        setStatusMessage('Loading Tesseract engine...');
                        worker = await Tesseract.createWorker('eng', 1, {
                            logger: m => console.log('[Tesseract]', m.status)
                        });
                    }

                    for (let i = 0; i < bulkQueue.length; i++) {
                        const item = bulkQueue[i];
                        setStatusMessage(`Processing ${i + 1} of ${bulkQueue.length}...`);
                        setBulkQueue(prev => prev.map((q, idx) => idx === i ? { ...q, status: 'processing' } : q));

                        try {
                            let result;
                            let imageData;
                            if (ocrEngine === 'google') {
                                // Convert blob URL to base64 for Google Vision
                                imageData = await toBase64(item.preview);
                                result = await googleVisionOCR(imageData, googleApiKey);
                            } else {
                                imageData = await toBase64(item.preview);
                                const tesseractResult = await worker.recognize(item.preview);
                                result = { text: tesseractResult.data.text, confidence: tesseractResult.data.confidence };
                            }

                            const parsed = await parseWithValidation(result.text, imageData, aiValidation);
                            results.push({
                                ...parsed,
                                id: `${Date.now()}-${i}-${Math.random().toString(36).substr(2, 9)}`,
                                image: item.preview,
                                fileName: item.file.name,
                                rawText: result.text,
                                confidence: result.confidence,
                                approved: true,
                                showRawText: false
                            });

                            setBulkQueue(prev => prev.map((q, idx) => idx === i ? { ...q, status: 'completed' } : q));
                        } catch (err) {
                            console.error(`Error processing ${item.file.name}:`, err);
                            setBulkQueue(prev => prev.map((q, idx) => idx === i ? { ...q, status: 'error', error: err.message } : q));
                        }
                    }

                    setBulkResults(results);
                    setStatusMessage('');

                    if (results.length > 0) {
                        setView('bulk-review');
                    } else {
                        setError('All images failed to process. Check your settings and try again.');
                    }
                } catch (e) {
                    console.error('[Bulk Error]', e);
                    setError(`Batch processing failed: ${e.message}`);
                } finally {
                    // Always terminate worker to prevent memory leaks
                    if (worker) {
                        try { await worker.terminate(); } catch (e) { console.warn('Worker termination failed:', e); }
                    }
                    setIsProcessing(false);
                }
            };

            // Cleanup blob URLs when component unmounts or bulk queue changes
            useEffect(() => {
                return () => {
                    // Revoke blob URLs to prevent memory leaks
                    bulkQueue.forEach(item => {
                        if (item.preview && item.preview.startsWith('blob:')) {
                            URL.revokeObjectURL(item.preview);
                        }
                    });
                };
            }, [bulkQueue]);

            // Save settings
            const saveSettings = () => {
                localStorage.setItem('ocr_engine', ocrEngine);
                localStorage.setItem('ai_validation', aiValidation);
                setView('home');
            };

            // Test API key
            const [apiTestResult, setApiTestResult] = useState(null);
            const [apiTesting, setApiTesting] = useState(false);

            const testApiKey = async () => {
                if (!googleApiKey) {
                    setApiTestResult({ success: false, message: 'Please enter an API key first' });
                    return;
                }

                setApiTesting(true);
                setApiTestResult(null);

                try {
                    const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${googleApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            requests: [{
                                image: { content: 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==' },
                                features: [{ type: 'TEXT_DETECTION' }]
                            }]
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        setApiTestResult({ success: false, message: data.error.message });
                    } else {
                        setApiTestResult({ success: true, message: 'API key is valid!' });
                    }
                } catch (e) {
                    setApiTestResult({ success: false, message: e.message });
                } finally {
                    setApiTesting(false);
                }
            };

            // ==================== RENDER FUNCTIONS ====================

            const renderHome = () => (
                <div className="flex flex-col items-center justify-center min-h-screen p-6 page-enter">
                    {/* Logo Section */}
                    <div className="mb-12 text-center">
                        <div className="mb-4">
                            <svg viewBox="0 0 280 80" xmlns="http://www.w3.org/2000/svg" className="w-56 h-auto mx-auto">
                                <defs>
                                    <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor:'#38bdf8'}} />
                                        <stop offset="50%" style={{stopColor:'#0ea5e9'}} />
                                        <stop offset="100%" style={{stopColor:'#0284c7'}} />
                                    </linearGradient>
                                    <linearGradient id="cardGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style={{stopColor:'#0369a1'}} />
                                        <stop offset="100%" style={{stopColor:'#075985'}} />
                                    </linearGradient>
                                    <filter id="glow">
                                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                        <feMerge>
                                            <feMergeNode in="coloredBlur"/>
                                            <feMergeNode in="SourceGraphic"/>
                                        </feMerge>
                                    </filter>
                                </defs>
                                {/* Icon */}
                                <g transform="translate(0, 10)" filter="url(#glow)">
                                    <path d="M28 5 A22 22 0 1 0 28 49" stroke="url(#logoGrad)" strokeWidth="5" fill="none" strokeLinecap="round"/>
                                    <rect x="14" y="18" width="26" height="17" rx="3" fill="url(#cardGrad)"/>
                                    <rect x="18" y="24" width="14" height="2" rx="1" fill="white" opacity="0.9"/>
                                    <rect x="18" y="29" width="9" height="2" rx="1" fill="white" opacity="0.5"/>
                                </g>
                                {/* Text */}
                                <text x="60" y="42" fontFamily="Inter, sans-serif" fontSize="28" fontWeight="800" fill="#ffffff" letterSpacing="-1">CURA</text>
                                <text x="138" y="42" fontFamily="Inter, sans-serif" fontSize="28" fontWeight="800" fill="url(#logoGrad)" letterSpacing="-1">.TOR</text>
                            </svg>
                        </div>
                        <p className="text-slate-500 text-xs tracking-widest uppercase">Smart Contact Curation</p>
                    </div>

                    {error && (
                        <div className="w-full max-w-md mb-6 p-4 card-elevated border-red-500/30 rounded-2xl flex items-start gap-3">
                            <div className="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0">
                                <SafeIcon name="alert-circle" className="w-4 h-4 text-red-400" />
                            </div>
                            <div className="flex-1">
                                <p className="text-red-400 text-sm font-medium">Error</p>
                                <p className="text-red-400/70 text-xs mt-1">{error}</p>
                            </div>
                            <button onClick={() => setError(null)} className="text-slate-500 hover:text-slate-300 transition-colors">
                                <SafeIcon name="x" className="w-4 h-4" />
                            </button>
                        </div>
                    )}

                    {/* Primary Actions */}
                    <div className="w-full max-w-md mb-6">
                        <p className="section-label mb-3 px-1">Quick Actions</p>
                        <div className="grid grid-cols-3 gap-3">
                            <div onClick={startCamera} className="action-card card-stagger">
                                <div className="icon-wrapper bg-gradient-to-br from-sky-500/20 to-blue-600/20">
                                    <SafeIcon name="scan" className="w-5 h-5 text-sky-400" />
                                </div>
                                <span className="font-semibold text-sm text-white">Scan</span>
                                <span className="text-[10px] text-slate-500">Camera</span>
                            </div>
                            <div onClick={() => fileInputRef.current.click()} className="action-card card-stagger">
                                <input type="file" ref={fileInputRef} onChange={handleFileUpload} multiple accept="image/*" className="hidden" />
                                <div className="icon-wrapper bg-gradient-to-br from-emerald-500/20 to-teal-600/20">
                                    <SafeIcon name="image-plus" className="w-5 h-5 text-emerald-400" />
                                </div>
                                <span className="font-semibold text-sm text-white">Upload</span>
                                <span className="text-[10px] text-slate-500">Images</span>
                            </div>
                            <div onClick={() => setView('manual')} className="action-card card-stagger">
                                <div className="icon-wrapper bg-gradient-to-br from-violet-500/20 to-purple-600/20">
                                    <SafeIcon name="pen-line" className="w-5 h-5 text-violet-400" />
                                </div>
                                <span className="font-semibold text-sm text-white">Manual</span>
                                <span className="text-[10px] text-slate-500">Entry</span>
                            </div>
                        </div>
                    </div>

                    {/* Secondary Actions */}
                    <div className="w-full max-w-md mb-8">
                        <p className="section-label mb-3 px-1">Manage</p>
                        <div className="grid grid-cols-2 gap-3">
                            <div onClick={() => setView('contacts')} className="action-card card-stagger flex-row justify-between px-5">
                                <div className="flex items-center gap-4">
                                    <div className="icon-wrapper bg-gradient-to-br from-cyan-500/20 to-blue-600/20" style={{width: '44px', height: '44px', borderRadius: '12px'}}>
                                        <SafeIcon name="users" className="w-5 h-5 text-cyan-400" />
                                    </div>
                                    <div className="text-left">
                                        <span className="font-semibold text-sm text-white block">Contacts</span>
                                        <span className="text-xs text-slate-500">{contacts.length} saved</span>
                                    </div>
                                </div>
                                <SafeIcon name="chevron-right" className="w-4 h-4 text-slate-600" />
                            </div>
                            <div onClick={() => setView('settings')} className="action-card card-stagger flex-row justify-between px-5">
                                <div className="flex items-center gap-4">
                                    <div className="icon-wrapper bg-gradient-to-br from-amber-500/20 to-orange-600/20" style={{width: '44px', height: '44px', borderRadius: '12px'}}>
                                        <SafeIcon name="settings" className="w-5 h-5 text-amber-400" />
                                    </div>
                                    <div className="text-left">
                                        <span className="font-semibold text-sm text-white block">Settings</span>
                                        <span className="text-xs text-slate-500">Configure</span>
                                    </div>
                                </div>
                                <SafeIcon name="chevron-right" className="w-4 h-4 text-slate-600" />
                            </div>
                        </div>
                    </div>

                    {/* Status Bar */}
                    <div className="w-full max-w-md card-elevated rounded-2xl p-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className={`status-dot ${driveConnected ? 'bg-emerald-500' : 'bg-slate-500'}`}></div>
                                <div>
                                    <p className="text-xs font-medium text-slate-300">
                                        {driveConnected ? 'Synced to Google Drive' : 'Local Storage'}
                                    </p>
                                    {driveConnected && driveSyncing && (
                                        <p className="text-[10px] text-slate-500">Syncing...</p>
                                    )}
                                </div>
                            </div>
                            <div className="flex items-center gap-2 text-xs text-slate-500">
                                <span className="px-2 py-1 bg-slate-800/50 rounded-md">
                                    {ocrEngine === 'google' ? 'Google Vision' : 'Tesseract'}
                                </span>
                                {aiValidation && (
                                    <span className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded-md">AI</span>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderSettings = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button onClick={() => setView('home')} className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors">
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <h2 className="font-semibold text-lg">Settings</h2>
                        <div className="w-10"></div>
                    </header>

                    <div className="p-5 space-y-6 flex-1 overflow-y-auto">
                        {/* OCR Engine Selection */}
                        <div className="space-y-3">
                            <p className="section-label px-1">OCR Engine</p>
                            <div className="space-y-2">
                                <button
                                    onClick={() => setOcrEngine('tesseract')}
                                    className={`w-full p-4 rounded-2xl text-left transition-all flex items-center gap-4 ${ocrEngine === 'tesseract' ? 'card-elevated border-sky-500/30' : 'card-elevated'}`}
                                >
                                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${ocrEngine === 'tesseract' ? 'bg-sky-500/20' : 'bg-slate-700/50'}`}>
                                        <SafeIcon name="cpu" className={`w-5 h-5 ${ocrEngine === 'tesseract' ? 'text-sky-400' : 'text-slate-400'}`} />
                                    </div>
                                    <div className="flex-1">
                                        <div className="font-semibold text-sm flex items-center gap-2">
                                            Tesseract
                                            <span className="text-[10px] px-2 py-0.5 bg-emerald-500/20 text-emerald-400 rounded-full">Free</span>
                                        </div>
                                        <div className="text-xs text-slate-500 mt-0.5">Runs locally in your browser</div>
                                    </div>
                                    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${ocrEngine === 'tesseract' ? 'border-sky-400 bg-sky-400' : 'border-slate-600'}`}>
                                        {ocrEngine === 'tesseract' && <SafeIcon name="check" className="w-3 h-3 text-white" />}
                                    </div>
                                </button>
                                <button
                                    onClick={() => setOcrEngine('google')}
                                    className={`w-full p-4 rounded-2xl text-left transition-all flex items-center gap-4 ${ocrEngine === 'google' ? 'card-elevated border-emerald-500/30' : 'card-elevated'}`}
                                >
                                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${ocrEngine === 'google' ? 'bg-emerald-500/20' : 'bg-slate-700/50'}`}>
                                        <SafeIcon name="cloud" className={`w-5 h-5 ${ocrEngine === 'google' ? 'text-emerald-400' : 'text-slate-400'}`} />
                                    </div>
                                    <div className="flex-1">
                                        <div className="font-semibold text-sm flex items-center gap-2">
                                            Google Vision
                                            <span className="text-[10px] px-2 py-0.5 bg-amber-500/20 text-amber-400 rounded-full">Pro</span>
                                        </div>
                                        <div className="text-xs text-slate-500 mt-0.5">Higher accuracy, cloud-powered</div>
                                    </div>
                                    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${ocrEngine === 'google' ? 'border-emerald-400 bg-emerald-400' : 'border-slate-600'}`}>
                                        {ocrEngine === 'google' && <SafeIcon name="check" className="w-3 h-3 text-white" />}
                                    </div>
                                </button>
                            </div>
                        </div>

                        {/* AI Validation Toggle */}
                        <div className="space-y-3">
                            <p className="section-label px-1">AI Enhancement</p>
                            <div
                                onClick={() => setAiValidation(!aiValidation)}
                                className={`p-4 rounded-2xl cursor-pointer transition-all flex items-center gap-4 ${aiValidation ? 'card-elevated border-purple-500/30' : 'card-elevated'}`}
                            >
                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${aiValidation ? 'bg-purple-500/20' : 'bg-slate-700/50'}`}>
                                    <SafeIcon name="sparkles" className={`w-5 h-5 ${aiValidation ? 'text-purple-400' : 'text-slate-400'}`} />
                                </div>
                                <div className="flex-1">
                                    <div className="font-semibold text-sm">AI-Powered Validation</div>
                                    <div className="text-xs text-slate-500 mt-0.5">Gemini AI improves accuracy to 99%</div>
                                </div>
                                <div className={`toggle-switch ${aiValidation ? 'bg-purple-500' : 'bg-slate-600'}`}>
                                    <div className={`toggle-knob ${aiValidation ? 'left-[26px]' : 'left-[3px]'}`}></div>
                                </div>
                            </div>
                            {!aiValidation && (
                                <div className="flex items-start gap-2 px-2">
                                    <SafeIcon name="alert-triangle" className="w-3 h-3 text-amber-400 mt-0.5 flex-shrink-0" />
                                    <p className="text-xs text-amber-400/80">Without AI, parsing relies on rule-based detection only.</p>
                                </div>
                            )}
                        </div>

                        {/* Google Drive Sync */}
                        <div className="space-y-3">
                            <p className="section-label px-1">Cloud Backup</p>
                            <div className="card-elevated rounded-2xl p-4">
                                {driveConnected ? (
                                    <>
                                        <div className="flex items-center gap-4 mb-4">
                                            <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                                                <SafeIcon name="cloud-check" className="w-6 h-6 text-white" />
                                            </div>
                                            <div className="flex-1">
                                                <p className="font-semibold text-sm text-emerald-400">Connected</p>
                                                {driveUser && <p className="text-xs text-slate-500">{driveUser.email}</p>}
                                            </div>
                                            {driveSyncing && (
                                                <div className="animate-spin h-5 w-5 border-2 border-emerald-500 border-t-transparent rounded-full"></div>
                                            )}
                                        </div>
                                        {lastSyncTime && (
                                            <p className="text-xs text-slate-500 mb-4 flex items-center gap-1">
                                                <SafeIcon name="clock" className="w-3 h-3" />
                                                Last synced: {new Date(lastSyncTime).toLocaleString()}
                                            </p>
                                        )}
                                        <div className="flex gap-2">
                                            <button
                                                onClick={loadFromDrive}
                                                disabled={driveSyncing}
                                                className="flex-1 py-3 text-sm btn-secondary rounded-xl disabled:opacity-50 flex items-center justify-center gap-2"
                                            >
                                                <SafeIcon name="refresh-cw" className="w-4 h-4" />
                                                Sync Now
                                            </button>
                                            <button
                                                onClick={disconnectGoogleDrive}
                                                className="py-3 px-4 text-sm bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition-colors"
                                            >
                                                <SafeIcon name="unplug" className="w-4 h-4" />
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div className="flex items-center gap-4 mb-4">
                                            <div className="w-12 h-12 bg-slate-700/50 rounded-xl flex items-center justify-center">
                                                <SafeIcon name="cloud-off" className="w-5 h-5 text-slate-400" />
                                            </div>
                                            <div>
                                                <p className="font-semibold text-sm">Google Drive Backup</p>
                                                <p className="text-xs text-slate-500">Keep your contacts safe in the cloud</p>
                                            </div>
                                        </div>
                                        <div className="space-y-2 mb-4 px-1">
                                            <div className="flex items-center gap-2 text-xs text-slate-400">
                                                <SafeIcon name="shield-check" className="w-3 h-3 text-emerald-400" />
                                                <span>Survives browser cache clearing</span>
                                            </div>
                                            <div className="flex items-center gap-2 text-xs text-slate-400">
                                                <SafeIcon name="smartphone" className="w-3 h-3 text-sky-400" />
                                                <span>Syncs across all your devices</span>
                                            </div>
                                            <div className="flex items-center gap-2 text-xs text-slate-400">
                                                <SafeIcon name="lock" className="w-3 h-3 text-purple-400" />
                                                <span>Your data stays private</span>
                                            </div>
                                        </div>
                                        <button
                                            onClick={connectGoogleDrive}
                                            className="w-full py-3 btn-primary rounded-xl text-sm font-semibold flex items-center justify-center gap-2"
                                        >
                                            <SafeIcon name="link" className="w-4 h-4" />
                                            Connect Google Drive
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="p-5 border-t border-white/5">
                        <button onClick={saveSettings} className="w-full py-4 btn-primary rounded-2xl font-semibold text-sm">
                            Save Settings
                        </button>
                    </div>
                </div>
            );

            const renderScan = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => { setView('home'); setCapturedImage(null); if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop()); }}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <h2 className="font-semibold text-lg">Scan Card</h2>
                        <div className="w-10"></div>
                    </header>

                    <div className="flex-1 p-5 flex flex-col items-center justify-center">
                        {/* Viewfinder */}
                        <div className="w-full max-w-md aspect-[1.586/1] rounded-2xl overflow-hidden relative shadow-2xl shadow-black/50">
                            <div className="absolute inset-0 border-2 border-white/20 rounded-2xl pointer-events-none z-10"></div>
                            {/* Corner guides */}
                            <div className="absolute top-3 left-3 w-8 h-8 border-t-2 border-l-2 border-sky-400 rounded-tl-lg z-10"></div>
                            <div className="absolute top-3 right-3 w-8 h-8 border-t-2 border-r-2 border-sky-400 rounded-tr-lg z-10"></div>
                            <div className="absolute bottom-3 left-3 w-8 h-8 border-b-2 border-l-2 border-sky-400 rounded-bl-lg z-10"></div>
                            <div className="absolute bottom-3 right-3 w-8 h-8 border-b-2 border-r-2 border-sky-400 rounded-br-lg z-10"></div>

                            {!capturedImage ? (
                                <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover bg-slate-900"></video>
                            ) : (
                                <img src={capturedImage} className="w-full h-full object-cover" />
                            )}
                        </div>

                        {/* Instructions */}
                        {!capturedImage && !isProcessing && (
                            <p className="text-slate-500 text-sm mt-4 text-center">Position business card within the frame</p>
                        )}

                        {/* Progress indicator */}
                        {isProcessing && (
                            <div className="mt-6 w-full max-w-md card-elevated rounded-2xl p-4">
                                <div className="flex items-center gap-3 mb-3">
                                    <div className="w-10 h-10 rounded-xl bg-sky-500/20 flex items-center justify-center">
                                        <div className="animate-spin h-5 w-5 border-2 border-sky-400 border-t-transparent rounded-full"></div>
                                    </div>
                                    <div className="flex-1">
                                        <p className="text-sm font-medium text-white">{statusMessage || 'Processing...'}</p>
                                        <p className="text-xs text-slate-500">Please wait</p>
                                    </div>
                                    <span className="text-sm font-semibold text-sky-400">{progress}%</span>
                                </div>
                                <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-gradient-to-r from-sky-500 to-emerald-500 transition-all duration-300" style={{ width: `${progress}%` }}></div>
                                </div>
                            </div>
                        )}

                        {/* Error display */}
                        {error && (
                            <div className="mt-6 w-full max-w-md card-elevated border-red-500/30 rounded-2xl p-4">
                                <div className="flex items-start gap-3">
                                    <div className="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center flex-shrink-0">
                                        <SafeIcon name="alert-circle" className="w-5 h-5 text-red-400" />
                                    </div>
                                    <div className="flex-1">
                                        <p className="text-sm font-medium text-red-400">Error</p>
                                        <p className="text-xs text-red-400/70 mt-1">{error}</p>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setError(null)} className="flex-1 px-4 py-2.5 text-sm bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition-colors">
                                        Dismiss
                                    </button>
                                    <button onClick={() => setView('settings')} className="flex-1 px-4 py-2.5 text-sm bg-slate-700/50 text-slate-300 rounded-xl hover:bg-slate-700/70 transition-colors">
                                        Settings
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Capture/Process buttons */}
                        <div className="mt-8">
                            {!capturedImage ? (
                                <button
                                    onClick={capture}
                                    className="w-20 h-20 bg-gradient-to-br from-sky-400 to-blue-600 rounded-full shadow-lg glow-pulse hover:scale-105 active:scale-95 transition-all flex items-center justify-center ring-4 ring-white/10"
                                >
                                    <SafeIcon name="camera" className="text-white w-8 h-8" />
                                </button>
                            ) : (
                                <div className="flex gap-4 items-center">
                                    <button
                                        onClick={() => { setCapturedImage(null); startCamera(); }}
                                        className="w-14 h-14 card-elevated rounded-full flex items-center justify-center hover:bg-white/10 transition-colors"
                                    >
                                        <SafeIcon name="refresh-cw" className="w-5 h-5 text-slate-300" />
                                    </button>
                                    <button
                                        onClick={runOCR}
                                        disabled={isProcessing}
                                        className="px-8 py-4 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl font-semibold flex items-center gap-3 disabled:opacity-50 shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 hover:scale-[1.02] active:scale-[0.98] transition-all"
                                    >
                                        {isProcessing ? (
                                            <div className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                                        ) : (
                                            <SafeIcon name="scan" className="w-5 h-5" />
                                        )}
                                        {isProcessing ? 'Processing...' : 'Process'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Engine indicator */}
                    <div className="p-4 flex justify-center">
                        <div className="flex items-center gap-2 px-3 py-2 card-elevated rounded-full text-xs text-slate-500">
                            <SafeIcon name={ocrEngine === 'google' ? 'cloud' : 'cpu'} className="w-3.5 h-3.5" />
                            <span>{ocrEngine === 'google' ? 'Google Vision' : 'Tesseract'}</span>
                            {aiValidation && (
                                <>
                                    <span className="text-slate-700">•</span>
                                    <span className="text-purple-400">AI Enhanced</span>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );

            const renderReview = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => { setView('scan'); setOcrResult(null); startCamera(); }}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <h2 className="font-semibold text-lg">Review Contact</h2>
                        <div className="w-10"></div>
                    </header>

                    <div className="p-5 space-y-5 flex-1 overflow-y-auto">
                        {/* Card Preview */}
                        {capturedImage && (
                            <div className="w-full aspect-[1.586/1] rounded-2xl overflow-hidden shadow-2xl shadow-black/50 border border-white/10">
                                <img src={capturedImage} className="w-full h-full object-cover" />
                            </div>
                        )}

                        {/* Confidence & Raw Text */}
                        <div className="card-elevated rounded-2xl p-4">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${ocrResult?.confidence > 70 ? 'bg-emerald-500/20' : 'bg-amber-500/20'}`}>
                                        <SafeIcon name={ocrResult?.confidence > 70 ? 'check-circle' : 'alert-triangle'} className={`w-5 h-5 ${ocrResult?.confidence > 70 ? 'text-emerald-400' : 'text-amber-400'}`} />
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium">OCR Confidence</p>
                                        <p className={`text-xs ${ocrResult?.confidence > 70 ? 'text-emerald-400' : 'text-amber-400'}`}>{Math.round(ocrResult?.confidence || 0)}%</p>
                                    </div>
                                </div>
                                <button
                                    onClick={() => setOcrResult(prev => ({ ...prev, showRawText: !prev.showRawText }))}
                                    className="px-3 py-1.5 text-xs bg-slate-700/50 text-slate-400 rounded-lg hover:bg-slate-700 hover:text-white transition-colors"
                                >
                                    {ocrResult?.showRawText ? 'Hide Raw' : 'View Raw'}
                                </button>
                            </div>
                            {ocrResult?.showRawText && (
                                <div className="mt-4 pt-4 border-t border-slate-800">
                                    <textarea
                                        className="w-full p-3 bg-slate-900/80 rounded-xl text-xs text-slate-300 whitespace-pre-wrap resize-none font-mono border border-slate-800 focus:border-slate-700 focus:ring-0 outline-none"
                                        rows={6}
                                        value={ocrResult.rawText || ''}
                                        onChange={(e) => setOcrResult(prev => ({ ...prev, rawText: e.target.value }))}
                                        placeholder="Edit raw OCR text..."
                                    />
                                    <button
                                        onClick={async () => {
                                            const reparsed = await parseWithValidation(ocrResult.rawText, capturedImage, aiValidation);
                                            setOcrResult(prev => ({
                                                ...prev,
                                                ...reparsed,
                                                rawText: prev.rawText,
                                                confidence: prev.confidence,
                                                showRawText: prev.showRawText
                                            }));
                                        }}
                                        className="mt-3 w-full px-4 py-2.5 bg-sky-500/10 text-sky-400 rounded-xl text-sm font-medium hover:bg-sky-500/20 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <SafeIcon name="refresh-cw" className="w-4 h-4" />
                                        Re-parse Text
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Editable fields */}
                        <div className="space-y-4">
                            <p className="section-label px-1">Contact Details</p>

                            {[
                                { field: 'name', icon: 'user', label: 'Full Name' },
                                { field: 'position', icon: 'briefcase', label: 'Job Title' },
                                { field: 'company', icon: 'building-2', label: 'Company' },
                                { field: 'phone', icon: 'phone', label: 'Phone' },
                                { field: 'email', icon: 'mail', label: 'Email' },
                                { field: 'address', icon: 'map-pin', label: 'Address' }
                            ].map(({ field, icon, label }) => (
                                <div key={field} className="relative">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">
                                        <SafeIcon name={icon} className="w-4 h-4 text-slate-500" />
                                    </div>
                                    <input
                                        className="w-full pl-14 pr-4 py-4 card-elevated rounded-xl text-sm focus:ring-1 focus:ring-sky-500/50 outline-none transition-all"
                                        value={ocrResult?.[field] || ''}
                                        onChange={(e) => setOcrResult(prev => ({ ...prev, [field]: e.target.value }))}
                                        placeholder={label}
                                    />
                                </div>
                            ))}

                            <div className="relative">
                                <div className="absolute left-4 top-4 w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">
                                    <SafeIcon name="sticky-note" className="w-4 h-4 text-slate-500" />
                                </div>
                                <textarea
                                    className="w-full pl-14 pr-4 py-4 card-elevated rounded-xl text-sm resize-none focus:ring-1 focus:ring-sky-500/50 outline-none transition-all"
                                    rows={2}
                                    value={ocrResult?.notes || ''}
                                    onChange={(e) => setOcrResult(prev => ({ ...prev, notes: e.target.value }))}
                                    placeholder="Notes"
                                />
                            </div>

                            <div className="relative">
                                <div className="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">
                                    <SafeIcon name="folder" className="w-4 h-4 text-slate-500" />
                                </div>
                                <select
                                    className="w-full pl-14 pr-4 py-4 card-elevated rounded-xl text-sm focus:ring-1 focus:ring-sky-500/50 outline-none transition-all"
                                    value={ocrResult?.folder || 'Uncategorized'}
                                    onChange={(e) => setOcrResult(prev => ({ ...prev, folder: e.target.value }))}
                                >
                                    {customFolders.map(folder => (
                                        <option key={folder} value={folder}>{folder}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className="p-5 border-t border-slate-800/50 bg-slate-950/80 backdrop-blur-xl">
                        <button
                            onClick={() => saveContact(ocrResult)}
                            className="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold rounded-2xl shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 hover:scale-[1.01] active:scale-[0.99] transition-all flex items-center justify-center gap-2"
                        >
                            <SafeIcon name="check" className="w-5 h-5" />
                            Save Contact
                        </button>
                    </div>
                </div>
            );

            // Ref for adding more files in upload view
            const addMoreFilesRef = useRef(null);

            const handleAddMoreFiles = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                const newItems = files.map(f => ({
                    id: Math.random().toString(36).substr(2, 9),
                    file: f,
                    preview: URL.createObjectURL(f),
                    status: 'queued'
                }));
                setBulkQueue(prev => [...prev, ...newItems]);
                e.target.value = ''; // Reset input so same files can be selected again
            };

            const renderUpload = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => { setView('home'); setBulkQueue([]); }}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <div className="text-center">
                            <h2 className="font-semibold text-lg">Upload Queue</h2>
                            <p className="text-xs text-slate-500">{bulkQueue.length} files</p>
                        </div>
                        <button
                            onClick={() => addMoreFilesRef.current?.click()}
                            className="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center hover:bg-emerald-500/20 transition-colors"
                        >
                            <SafeIcon name="plus" className="w-5 h-5 text-emerald-400" />
                        </button>
                        <input type="file" ref={addMoreFilesRef} onChange={handleAddMoreFiles} multiple accept="image/*" className="hidden" />
                    </header>

                    {/* Error display */}
                    {error && (
                        <div className="mx-5 mt-4 card-elevated border-red-500/30 rounded-2xl p-4">
                            <div className="flex items-start gap-3">
                                <div className="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center flex-shrink-0">
                                    <SafeIcon name="alert-circle" className="w-5 h-5 text-red-400" />
                                </div>
                                <div className="flex-1">
                                    <p className="text-sm font-medium text-red-400">Error</p>
                                    <p className="text-xs text-red-400/70 mt-1">{error}</p>
                                </div>
                            </div>
                            <div className="flex gap-2 mt-4">
                                <button onClick={() => setError(null)} className="flex-1 px-4 py-2.5 text-sm bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition-colors">
                                    Dismiss
                                </button>
                                <button onClick={() => setView('settings')} className="flex-1 px-4 py-2.5 text-sm bg-slate-700/50 text-slate-300 rounded-xl hover:bg-slate-700/70 transition-colors">
                                    Settings
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Status display */}
                    {isProcessing && statusMessage && (
                        <div className="mx-5 mt-4 card-elevated rounded-2xl p-4">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl bg-sky-500/20 flex items-center justify-center">
                                    <div className="animate-spin h-5 w-5 border-2 border-sky-400 border-t-transparent rounded-full"></div>
                                </div>
                                <div className="flex-1">
                                    <p className="text-sm font-medium text-white">{statusMessage}</p>
                                    <p className="text-xs text-slate-500">Please wait</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="p-5 space-y-3 flex-1 overflow-y-auto">
                        {bulkQueue.length === 0 ? (
                            <div className="text-center py-16">
                                <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-800/50 flex items-center justify-center">
                                    <SafeIcon name="image" className="w-10 h-10 text-slate-600" />
                                </div>
                                <p className="text-lg font-medium text-slate-400">No files in queue</p>
                                <p className="text-slate-600 text-sm mt-2">Add images to start processing</p>
                                <button
                                    onClick={() => addMoreFilesRef.current?.click()}
                                    className="mt-6 px-6 py-3 bg-emerald-500/10 text-emerald-400 rounded-xl text-sm font-medium hover:bg-emerald-500/20 transition-colors inline-flex items-center gap-2"
                                >
                                    <SafeIcon name="plus" className="w-4 h-4" />
                                    Add Files
                                </button>
                            </div>
                        ) : (
                            bulkQueue.map((item, idx) => (
                                <div key={item.id} className={`card-elevated rounded-2xl p-4 flex gap-4 items-center ${item.status === 'error' ? 'border-red-500/30' : ''}`}>
                                    <img src={item.preview} className="w-14 h-14 rounded-xl object-cover" />
                                    <div className="flex-1 min-w-0">
                                        <p className="text-sm font-medium text-white truncate">{item.file.name}</p>
                                        <p className={`text-xs mt-1 ${
                                            item.status === 'completed' ? 'text-emerald-400' :
                                            item.status === 'processing' ? 'text-sky-400' :
                                            item.status === 'error' ? 'text-red-400' : 'text-slate-500'
                                        }`}>
                                            {item.status === 'error' ? item.error : item.status.charAt(0).toUpperCase() + item.status.slice(1)}
                                        </p>
                                    </div>
                                    {item.status === 'completed' && (
                                        <div className="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                                            <SafeIcon name="check" className="w-4 h-4 text-emerald-400" />
                                        </div>
                                    )}
                                    {item.status === 'processing' && (
                                        <div className="w-8 h-8 rounded-lg bg-sky-500/20 flex items-center justify-center">
                                            <div className="animate-spin h-4 w-4 border-2 border-sky-400 border-t-transparent rounded-full"></div>
                                        </div>
                                    )}
                                    {item.status === 'error' && (
                                        <div className="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center">
                                            <SafeIcon name="x" className="w-4 h-4 text-red-400" />
                                        </div>
                                    )}
                                    {item.status === 'queued' && !isProcessing && (
                                        <button
                                            onClick={() => setBulkQueue(prev => prev.filter((_, i) => i !== idx))}
                                            className="w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center hover:bg-red-500/20 transition-colors group"
                                        >
                                            <SafeIcon name="trash-2" className="w-4 h-4 text-slate-500 group-hover:text-red-400 transition-colors" />
                                        </button>
                                    )}
                                </div>
                            ))
                        )}
                    </div>

                    <div className="p-5 border-t border-slate-800/50 bg-slate-950/80 backdrop-blur-xl">
                        <button
                            onClick={processBulk}
                            disabled={isProcessing || bulkQueue.length === 0}
                            className="w-full py-4 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-semibold rounded-2xl flex items-center justify-center gap-2 disabled:opacity-50 shadow-lg shadow-sky-500/20 hover:shadow-sky-500/40 hover:scale-[1.01] active:scale-[0.99] transition-all"
                        >
                            {isProcessing ? (
                                <>
                                    <div className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                                    Processing...
                                </>
                            ) : (
                                <>
                                    <SafeIcon name="play" className="w-5 h-5" />
                                    Start OCR
                                </>
                            )}
                        </button>
                    </div>
                </div>
            );

            const renderBulkReview = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => { setView('home'); setBulkResults([]); setBulkQueue([]); }}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="x" className="w-5 h-5" />
                        </button>
                        <div className="text-center">
                            <h2 className="font-semibold text-lg">Review Contacts</h2>
                            <p className="text-xs text-slate-500">{bulkResults.length} to save</p>
                        </div>
                        <div className="w-10"></div>
                    </header>

                    <div className="p-5 space-y-4 flex-1 overflow-y-auto">
                        {bulkResults.map((r, idx) => (
                            <div key={r.id} className="card-elevated rounded-2xl overflow-hidden">
                                <div className="relative">
                                    <img src={r.image} className="w-full h-28 object-cover" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                                    <div className="absolute bottom-3 left-3 right-3 flex justify-between items-end">
                                        <span className="text-xs text-white/80 truncate max-w-[60%]">{r.fileName}</span>
                                        <span className={`text-xs px-2 py-0.5 rounded-full ${r.confidence > 70 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`}>
                                            {Math.round(r.confidence)}%
                                        </span>
                                    </div>
                                </div>

                                {/* Raw Text toggle */}
                                <div className="px-4 py-2 border-b border-slate-800/50">
                                    <button
                                        onClick={() => setBulkResults(prev => prev.map((item, i) => i === idx ? { ...item, showRawText: !item.showRawText } : item))}
                                        className="text-xs text-slate-500 hover:text-white transition-colors flex items-center gap-1"
                                    >
                                        <SafeIcon name={r.showRawText ? 'chevron-up' : 'chevron-down'} className="w-3 h-3" />
                                        {r.showRawText ? 'Hide' : 'Show'} Raw Text
                                    </button>
                                    {r.showRawText && (
                                        <div className="mt-3">
                                            <textarea
                                                className="w-full p-3 bg-slate-900/80 rounded-xl text-xs text-slate-300 whitespace-pre-wrap resize-none font-mono border border-slate-800"
                                                rows={4}
                                                value={r.rawText || ''}
                                                onChange={(e) => setBulkResults(prev => prev.map((item, i) => i === idx ? { ...item, rawText: e.target.value } : item))}
                                                placeholder="Edit raw OCR text..."
                                            />
                                            <button
                                                onClick={async () => {
                                                    const reparsed = await parseWithValidation(r.rawText, r.image, aiValidation);
                                                    setBulkResults(prev => prev.map((item, i) => i === idx ? {
                                                        ...item,
                                                        ...reparsed,
                                                        rawText: item.rawText,
                                                        confidence: item.confidence,
                                                        showRawText: item.showRawText,
                                                        image: item.image,
                                                        fileName: item.fileName,
                                                        id: item.id
                                                    } : item));
                                                }}
                                                className="mt-2 w-full px-3 py-2 bg-sky-500/10 text-sky-400 rounded-xl text-xs hover:bg-sky-500/20 transition-colors flex items-center justify-center gap-1"
                                            >
                                                <SafeIcon name="refresh-cw" className="w-3 h-3" />
                                                Re-parse Text
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <div className="p-4 space-y-2">
                                    {[
                                        { field: 'name', icon: 'user' },
                                        { field: 'position', icon: 'briefcase' },
                                        { field: 'company', icon: 'building-2' },
                                        { field: 'phone', icon: 'phone' },
                                        { field: 'email', icon: 'mail' }
                                    ].map(({ field, icon }) => (
                                        <div key={field} className="relative">
                                            <div className="absolute left-3 top-1/2 -translate-y-1/2 w-6 h-6 rounded bg-slate-800/50 flex items-center justify-center">
                                                <SafeIcon name={icon} className="w-3 h-3 text-slate-500" />
                                            </div>
                                            <input
                                                className="w-full bg-slate-800/50 rounded-xl pl-11 pr-3 py-2.5 text-sm focus:ring-1 focus:ring-sky-500/50 outline-none transition-all"
                                                placeholder={field.charAt(0).toUpperCase() + field.slice(1)}
                                                value={r[field] || ''}
                                                onChange={e => setBulkResults(prev => prev.map((item, i) => i === idx ? { ...item, [field]: e.target.value } : item))}
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="p-5 border-t border-slate-800/50 bg-slate-950/80 backdrop-blur-xl">
                        <button
                            onClick={() => {
                                const newContacts = bulkResults.map(r => ({ ...r, id: Date.now() + Math.random(), createdAt: new Date().toISOString() }));
                                const updatedContacts = [...newContacts, ...contacts];
                                setContacts(updatedContacts);
                                localStorage.setItem('demo_contacts', JSON.stringify(updatedContacts));
                                setBulkResults([]);
                                setBulkQueue([]);
                                setView('contacts');
                            }}
                            className="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold rounded-2xl shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 hover:scale-[1.01] active:scale-[0.99] transition-all flex items-center justify-center gap-2"
                        >
                            <SafeIcon name="check" className="w-5 h-5" />
                            Save All ({bulkResults.length})
                        </button>
                    </div>
                </div>
            );

            // CSV Export function
            const exportToCSV = () => {
                console.log('exportToCSV called, contacts:', contacts.length);
                if (contacts.length === 0) {
                    alert('No contacts to export');
                    return;
                }

                try {
                    const headers = ['Name', 'Position', 'Company', 'Phone', 'Email', 'Address', 'Notes', 'Created At'];
                    const csvRows = [headers.join(',')];

                    contacts.forEach(c => {
                        const row = [
                            `"${(c.name || '').replace(/"/g, '""')}"`,
                            `"${(c.position || '').replace(/"/g, '""')}"`,
                            `"${(c.company || '').replace(/"/g, '""')}"`,
                            `"${(c.phone || '').replace(/"/g, '""')}"`,
                            `"${(c.email || '').replace(/"/g, '""')}"`,
                            `"${(c.address || '').replace(/"/g, '""')}"`,
                            `"${(c.notes || '').replace(/"/g, '""')}"`,
                            `"${(c.createdAt || '').replace(/"/g, '""')}"`
                        ];
                        csvRows.push(row.join(','));
                    });

                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `contacts_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    console.log('CSV export completed successfully');
                } catch (error) {
                    console.error('CSV export failed:', error);
                    alert('Failed to export CSV: ' + error.message);
                }
            };

            // Generate vCard format for a single contact
            const generateVCard = (contact) => {
                // Parse name into parts (simple split)
                const nameParts = (contact.name || 'Unknown').split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                // Handle multiple phones (split by " / ")
                const phones = (contact.phone || '').split(' / ').filter(p => p.trim());

                // Build vCard
                let vcard = 'BEGIN:VCARD\n';
                vcard += 'VERSION:3.0\n';
                vcard += `FN:${contact.name || 'Unknown'}\n`;
                vcard += `N:${lastName};${firstName};;;\n`;

                if (contact.company) {
                    vcard += `ORG:${contact.company}\n`;
                }
                if (contact.position) {
                    vcard += `TITLE:${contact.position}\n`;
                }

                // Add all phone numbers
                phones.forEach((phone, idx) => {
                    const type = idx === 0 ? 'CELL' : 'WORK';
                    vcard += `TEL;TYPE=${type}:${phone.trim()}\n`;
                });

                if (contact.email) {
                    vcard += `EMAIL:${contact.email}\n`;
                }
                if (contact.address) {
                    // vCard address format: PO Box;Extended;Street;City;Region;Postal;Country
                    vcard += `ADR;TYPE=WORK:;;${contact.address};;;;\n`;
                }
                if (contact.notes) {
                    vcard += `NOTE:${contact.notes.replace(/\n/g, '\\n')}\n`;
                }

                vcard += 'END:VCARD\n';
                return vcard;
            };

            // Export single contact as vCard (for "Save to Phone")
            const exportSingleVCard = (contact) => {
                const vcard = generateVCard(contact);
                const blob = new Blob([vcard], { type: 'text/vcard;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                // Use contact name for filename, sanitized
                const safeName = (contact.name || 'contact').replace(/[^a-zA-Z0-9]/g, '_');
                link.download = `${safeName}.vcf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            // Export all contacts as vCard
            const exportAllVCards = () => {
                console.log('exportAllVCards called, contacts:', contacts.length);
                if (contacts.length === 0) {
                    alert('No contacts to export');
                    return;
                }

                try {
                    // Multiple vCards can be in one file
                    const vcards = contacts.map(c => generateVCard(c)).join('\n');
                    const blob = new Blob([vcards], { type: 'text/vcard;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `curator_contacts_${new Date().toISOString().split('T')[0]}.vcf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    console.log('vCard export completed successfully');
                } catch (error) {
                    console.error('vCard export failed:', error);
                    alert('Failed to export vCard: ' + error.message);
                }
            };

            // Export menu state
            const [showExportMenu, setShowExportMenu] = useState(false);

            // Edit contact state
            const [editingContact, setEditingContact] = useState(null);
            const [editForm, setEditForm] = useState({});

            // Folder/grouping state
            const [customFolders, setCustomFolders] = useState(() => {
                const saved = localStorage.getItem('custom_folders');
                return saved ? JSON.parse(saved) : ['Personal', 'Work', 'Uncategorized'];
            });
            const [selectedFolder, setSelectedFolder] = useState('All');
            const [showNewFolderModal, setShowNewFolderModal] = useState(false);
            const [newFolderName, setNewFolderName] = useState('');

            // Save custom folders to localStorage whenever they change
            useEffect(() => {
                localStorage.setItem('custom_folders', JSON.stringify(customFolders));
            }, [customFolders]);

            const folders = ['All', ...customFolders];

            const renderContacts = () => {
                // Sort contacts by ID descending (newest first)
                const sortedContacts = [...contacts].sort((a, b) => (b.id || 0) - (a.id || 0));

                // Filter by folder
                const filteredContacts = selectedFolder === 'All'
                    ? sortedContacts
                    : sortedContacts.filter(c => (c.folder || 'Uncategorized') === selectedFolder);

                return (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => setView('home')}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <div className="text-center">
                            <h2 className="font-semibold text-lg">Contacts</h2>
                            <p className="text-xs text-slate-500">{contacts.length} saved</p>
                        </div>
                        {contacts.length > 0 ? (
                            <div className="relative">
                                <button
                                    onClick={() => setShowExportMenu(!showExportMenu)}
                                    className="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center hover:bg-emerald-500/20 transition-colors"
                                >
                                    <SafeIcon name="download" className="w-5 h-5 text-emerald-400" />
                                </button>
                                {showExportMenu && (
                                    <>
                                        {/* Close menu when clicking outside */}
                                        <div className="fixed inset-0 z-40" onClick={() => setShowExportMenu(false)}></div>
                                        <div className="absolute right-0 top-12 card-elevated modal-enter rounded-2xl p-2 min-w-[180px] z-50 shadow-2xl border border-slate-700">
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    exportAllVCards();
                                                    setShowExportMenu(false);
                                                }}
                                                className="w-full text-left px-4 py-3 text-sm hover:bg-white/5 rounded-xl flex items-center gap-3 transition-colors"
                                            >
                                                <div className="w-8 h-8 rounded-lg bg-sky-500/20 flex items-center justify-center">
                                                    <SafeIcon name="user-plus" className="w-4 h-4 text-sky-400" />
                                                </div>
                                                <span>Save to Phone</span>
                                            </button>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    exportToCSV();
                                                    setShowExportMenu(false);
                                                }}
                                                className="w-full text-left px-4 py-3 text-sm hover:bg-white/5 rounded-xl flex items-center gap-3 transition-colors"
                                            >
                                                <div className="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                                                    <SafeIcon name="table" className="w-4 h-4 text-emerald-400" />
                                                </div>
                                                <span>Export CSV</span>
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        ) : (
                            <div className="w-10"></div>
                        )}
                    </header>

                    {/* Folder Filter */}
                    {contacts.length > 0 && (
                        <div className="px-5 pt-4 pb-2 overflow-x-auto flex gap-2">
                            {folders.map(folder => (
                                <button
                                    key={folder}
                                    onClick={() => setSelectedFolder(folder)}
                                    className={`px-4 py-2 rounded-xl text-xs font-medium whitespace-nowrap transition-all ${
                                        selectedFolder === folder
                                            ? 'bg-sky-500/20 text-sky-400 border border-sky-500/30'
                                            : 'bg-slate-800/50 text-slate-400 hover:bg-slate-700'
                                    }`}
                                >
                                    {folder}
                                </button>
                            ))}
                            <button
                                onClick={() => setShowNewFolderModal(true)}
                                className="px-4 py-2 rounded-xl text-xs font-medium whitespace-nowrap bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20 transition-all border border-emerald-500/30 flex items-center gap-1.5"
                            >
                                <SafeIcon name="plus" className="w-3.5 h-3.5" />
                                <span>New Folder</span>
                            </button>
                        </div>
                    )}

                    <div className="p-5 space-y-3 flex-1 overflow-y-auto">
                        {filteredContacts.length === 0 ? (
                            <div className="text-center py-16">
                                <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-800/50 flex items-center justify-center">
                                    <SafeIcon name="users" className="w-10 h-10 text-slate-600" />
                                </div>
                                <p className="text-lg font-medium text-slate-400">No contacts yet</p>
                                <p className="text-slate-600 text-sm mt-2 max-w-[200px] mx-auto">Scan or upload business cards to get started</p>
                                <button
                                    onClick={() => setView('home')}
                                    className="mt-6 px-6 py-3 bg-sky-500/10 text-sky-400 rounded-xl text-sm font-medium hover:bg-sky-500/20 transition-colors"
                                >
                                    Start Scanning
                                </button>
                            </div>
                        ) : (
                            filteredContacts.map((c, i) => (
                                <div key={c.id || i} className="card-elevated card-stagger rounded-2xl overflow-hidden" style={{animationDelay: `${i * 0.05}s`}}>
                                    <div className="p-4 flex gap-4">
                                        <div className="h-14 w-14 bg-gradient-to-br from-sky-500 to-emerald-500 rounded-xl flex items-center justify-center font-bold text-xl flex-shrink-0 shadow-lg shadow-sky-500/20">
                                            {(c.name || '?')[0].toUpperCase()}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <h4 className="font-semibold text-white truncate">{c.name}</h4>
                                            {c.position && <p className="text-sm text-slate-400 truncate">{c.position}</p>}
                                            {c.company && (
                                                <p className="text-xs text-slate-500 truncate flex items-center gap-1 mt-1">
                                                    <SafeIcon name="building-2" className="w-3 h-3" />
                                                    {c.company}
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                    <div className="px-4 pb-4 flex gap-2">
                                        {c.phone && (
                                            <a href={`tel:${c.phone.split(' / ')[0]}`} className="flex-1 py-2.5 text-center text-xs bg-slate-800/70 rounded-xl hover:bg-slate-700 transition-colors flex items-center justify-center gap-1.5">
                                                <SafeIcon name="phone" className="w-3.5 h-3.5 text-sky-400" />
                                                <span>Call</span>
                                            </a>
                                        )}
                                        {c.email && (
                                            <a href={`mailto:${c.email}`} className="flex-1 py-2.5 text-center text-xs bg-slate-800/70 rounded-xl hover:bg-slate-700 transition-colors flex items-center justify-center gap-1.5">
                                                <SafeIcon name="mail" className="w-3.5 h-3.5 text-amber-400" />
                                                <span>Email</span>
                                            </a>
                                        )}
                                        <button
                                            onClick={() => {
                                                setEditingContact(c);
                                                setEditForm({ ...c });
                                            }}
                                            className="flex-1 py-2.5 text-center text-xs bg-purple-500/20 text-purple-400 rounded-xl hover:bg-purple-500/30 transition-colors flex items-center justify-center gap-1.5 font-medium"
                                        >
                                            <SafeIcon name="pencil" className="w-3.5 h-3.5" />
                                            <span>Edit</span>
                                        </button>
                                        <button
                                            onClick={() => exportSingleVCard(c)}
                                            className="flex-1 py-2.5 text-center text-xs bg-emerald-500/20 text-emerald-400 rounded-xl hover:bg-emerald-500/30 transition-colors flex items-center justify-center gap-1.5 font-medium"
                                        >
                                            <SafeIcon name="user-plus" className="w-3.5 h-3.5" />
                                            <span>Save</span>
                                        </button>
                                        <button
                                            onClick={() => {
                                                if (confirm(`Delete ${c.name || 'this contact'}?`)) {
                                                    setContacts(prev => prev.filter(contact => contact.id !== c.id));
                                                }
                                            }}
                                            className="py-2.5 px-3 text-center text-xs bg-red-500/10 text-red-400 rounded-xl hover:bg-red-500/20 transition-colors flex items-center justify-center"
                                        >
                                            <SafeIcon name="trash-2" className="w-3.5 h-3.5" />
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {contacts.length > 0 && (
                        <div className="p-5 border-t border-slate-800/50">
                            <button
                                onClick={() => {
                                    if (confirm('Delete all contacts?')) {
                                        setContacts([]);
                                        localStorage.removeItem('demo_contacts');
                                    }
                                }}
                                className="w-full py-3 bg-red-500/10 text-red-400 rounded-xl text-sm font-medium hover:bg-red-500/20 transition-colors"
                            >
                                Clear All Contacts
                            </button>
                        </div>
                    )}

                    {/* Edit Contact Modal */}
                    {editingContact && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 modal-enter" onClick={() => setEditingContact(null)}>
                            <div className="card-elevated rounded-3xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="text-lg font-bold text-white">Edit Contact</h3>
                                    <button onClick={() => setEditingContact(null)} className="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center transition-colors">
                                        <SafeIcon name="x" className="w-5 h-5" />
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-2">Name</label>
                                        <input
                                            type="text"
                                            value={editForm.name || ''}
                                            onChange={(e) => setEditForm({...editForm, name: e.target.value})}
                                            className="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-3 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-2">Position</label>
                                        <input
                                            type="text"
                                            value={editForm.position || ''}
                                            onChange={(e) => setEditForm({...editForm, position: e.target.value})}
                                            className="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-3 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-2">Company</label>
                                        <input
                                            type="text"
                                            value={editForm.company || ''}
                                            onChange={(e) => setEditForm({...editForm, company: e.target.value})}
                                            className="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-3 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-2">Folder</label>
                                        <select
                                            value={editForm.folder || 'Uncategorized'}
                                            onChange={(e) => setEditForm({...editForm, folder: e.target.value})}
                                            className="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-3 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50"
                                        >
                                            {customFolders.map(folder => (
                                                <option key={folder} value={folder}>{folder}</option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-2">Phone</label>
                                        <input
                                            type="text"
                                            value={editForm.phone || ''}
                                            onChange={(e) => setEditForm({...editForm, phone: e.target.value})}
                                            className="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-3 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-2">Email</label>
                                        <input
                                            type="email"
                                            value={editForm.email || ''}
                                            onChange={(e) => setEditForm({...editForm, email: e.target.value})}
                                            className="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-3 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-xs font-medium text-slate-400 mb-2">Address</label>
                                        <textarea
                                            value={editForm.address || ''}
                                            onChange={(e) => setEditForm({...editForm, address: e.target.value})}
                                            rows="3"
                                            className="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-3 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500/50"
                                        />
                                    </div>
                                </div>

                                <div className="flex gap-3 mt-6">
                                    <button
                                        onClick={() => setEditingContact(null)}
                                        className="flex-1 py-3 bg-slate-800/50 rounded-xl hover:bg-slate-700 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => {
                                            const updatedContacts = contacts.map(c => c.id === editingContact.id ? {...c, ...editForm} : c);
                                            setContacts(updatedContacts);
                                            localStorage.setItem('demo_contacts', JSON.stringify(updatedContacts));
                                            setEditingContact(null);
                                        }}
                                        className="flex-1 py-3 bg-sky-500 text-white rounded-xl hover:bg-sky-400 transition-colors font-medium"
                                    >
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* New Folder Modal */}
                    {showNewFolderModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-5 bg-black/80 backdrop-blur-sm modal-enter" onClick={() => setShowNewFolderModal(false)}>
                            <div className="card-elevated rounded-2xl p-6 w-full max-w-md" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-lg font-semibold mb-4">Create New Folder</h3>
                                <input
                                    type="text"
                                    value={newFolderName}
                                    onChange={(e) => setNewFolderName(e.target.value)}
                                    placeholder="Folder name (e.g., Clients, Vendors)"
                                    className="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-3 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/50 mb-4"
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && newFolderName.trim()) {
                                            if (!customFolders.includes(newFolderName.trim())) {
                                                setCustomFolders([...customFolders, newFolderName.trim()]);
                                                setNewFolderName('');
                                                setShowNewFolderModal(false);
                                            } else {
                                                alert('Folder already exists');
                                            }
                                        }
                                    }}
                                />
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setNewFolderName('');
                                            setShowNewFolderModal(false);
                                        }}
                                        className="flex-1 py-3 bg-slate-800/50 rounded-xl hover:bg-slate-700 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (newFolderName.trim()) {
                                                if (!customFolders.includes(newFolderName.trim())) {
                                                    setCustomFolders([...customFolders, newFolderName.trim()]);
                                                    setNewFolderName('');
                                                    setShowNewFolderModal(false);
                                                } else {
                                                    alert('Folder already exists');
                                                }
                                            }
                                        }}
                                        disabled={!newFolderName.trim()}
                                        className="flex-1 py-3 bg-emerald-500 text-white rounded-xl hover:bg-emerald-400 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Create Folder
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
            };

            const renderManual = () => (
                <div className="flex flex-col min-h-screen page-enter">
                    <header className="header-bar p-5 flex items-center justify-between sticky top-0 z-10">
                        <button
                            onClick={() => { setView('home'); setManualEntry({ name: '', position: '', company: '', phone: '', email: '', address: '', notes: '', folder: 'Uncategorized' }); }}
                            className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors"
                        >
                            <SafeIcon name="arrow-left" className="w-5 h-5" />
                        </button>
                        <h2 className="font-semibold text-lg">Add Contact</h2>
                        <div className="w-10"></div>
                    </header>

                    <div className="p-5 space-y-4 flex-1 overflow-y-auto">
                        <p className="section-label px-1">Contact Information</p>

                        {[
                            { field: 'name', icon: 'user', label: 'Full Name', type: 'text' },
                            { field: 'position', icon: 'briefcase', label: 'Job Title', type: 'text' },
                            { field: 'company', icon: 'building-2', label: 'Company', type: 'text' },
                            { field: 'phone', icon: 'phone', label: 'Phone Number', type: 'tel' },
                            { field: 'email', icon: 'mail', label: 'Email Address', type: 'email' },
                            { field: 'address', icon: 'map-pin', label: 'Address', type: 'text' }
                        ].map(({ field, icon, label, type }) => (
                            <div key={field} className="relative">
                                <div className="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">
                                    <SafeIcon name={icon} className="w-4 h-4 text-slate-500" />
                                </div>
                                <input
                                    className="w-full pl-14 pr-4 py-4 card-elevated rounded-xl text-sm focus:ring-1 focus:ring-violet-500/50 outline-none transition-all"
                                    value={manualEntry[field]}
                                    onChange={(e) => setManualEntry(prev => ({ ...prev, [field]: e.target.value }))}
                                    placeholder={label}
                                    type={type}
                                />
                            </div>
                        ))}

                        <div className="relative">
                            <div className="absolute left-4 top-4 w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">
                                <SafeIcon name="sticky-note" className="w-4 h-4 text-slate-500" />
                            </div>
                            <textarea
                                className="w-full pl-14 pr-4 py-4 card-elevated rounded-xl text-sm resize-none focus:ring-1 focus:ring-violet-500/50 outline-none transition-all"
                                rows={3}
                                value={manualEntry.notes}
                                onChange={(e) => setManualEntry(prev => ({ ...prev, notes: e.target.value }))}
                                placeholder="Notes"
                            />
                        </div>

                        <div className="relative">
                            <div className="absolute left-4 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">
                                <SafeIcon name="folder" className="w-4 h-4 text-slate-500" />
                            </div>
                            <select
                                className="w-full pl-14 pr-4 py-4 card-elevated rounded-xl text-sm focus:ring-1 focus:ring-violet-500/50 outline-none transition-all"
                                value={manualEntry.folder}
                                onChange={(e) => setManualEntry(prev => ({ ...prev, folder: e.target.value }))}
                            >
                                {customFolders.map(folder => (
                                    <option key={folder} value={folder}>{folder}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div className="p-5 border-t border-slate-800/50 bg-slate-950/80 backdrop-blur-xl">
                        <button
                            onClick={() => {
                                if (!manualEntry.name.trim()) {
                                    setError('Please enter at least a name');
                                    return;
                                }
                                const newContact = {
                                    ...manualEntry,
                                    id: Date.now(),
                                    createdAt: new Date().toISOString()
                                };
                                const newContacts = [newContact, ...contacts];
                                setContacts(newContacts);
                                localStorage.setItem('demo_contacts', JSON.stringify(newContacts));
                                setManualEntry({ name: '', position: '', company: '', phone: '', email: '', address: '', notes: '', folder: 'Uncategorized' });
                                setView('contacts');
                            }}
                            className="w-full py-4 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold rounded-2xl shadow-lg shadow-violet-500/20 hover:shadow-violet-500/40 hover:scale-[1.01] active:scale-[0.99] transition-all flex items-center justify-center gap-2"
                        >
                            <SafeIcon name="check" className="w-5 h-5" />
                            Save Contact
                        </button>
                    </div>
                </div>
            );

            // Main render
            if (view === 'home') return renderHome();
            if (view === 'settings') return renderSettings();
            if (view === 'scan') return renderScan();
            if (view === 'review') return renderReview();
            if (view === 'upload') return renderUpload();
            if (view === 'bulk-review') return renderBulkReview();
            if (view === 'contacts') return renderContacts();
            if (view === 'manual') return renderManual();
            return null;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('[Cura.tor] Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    console.log('[Cura.tor] New version available!');
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('[Cura.tor] Service Worker registration failed:', error);
                    });
            });
        }

        // Handle install prompt for "Add to Home Screen"
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('[Cura.tor] Install prompt available');
        });
    </script>
</body>

</html>
